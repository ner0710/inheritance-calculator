<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>遗产份额计算器 | 民法典继承计算工具</title>
    <meta name="description" content="免费在线遗产继承份额计算器，基于《民法典》继承编，快速计算法定继承份额，保护您的合法权益">
    <meta name="keywords" content="遗产计算,继承份额,法定继承,民法典,遗产分配">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Chart.js datalabels 插件 -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <!-- 自定义样式 -->
    <style>
        .step { display: none; }
        .step.active { display: block; }
        .progress-bar { transition: width 0.5s ease; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .wechat-card {
            background: linear-gradient(135deg, #7bb342 0%, #4c8b2f 100%);
            color: white;
            border-radius: 12px;
            overflow: hidden;
        }
        .info-summary-item {
            transition: all 0.3s ease;
        }
        .info-summary-item:hover {
            background-color: #f8fafc;
        }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 6px;
        }
        .badge-primary { background-color: #dbeafe; color: #1e40af; }
        .badge-secondary { background-color: #f0f9ff; color: #0c4a6e; }
        .badge-success { background-color: #d1fae5; color: #065f46; }
        .badge-warning { background-color: #fef3c7; color: #92400e; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-md py-4">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <div class="bg-blue-600 text-white p-2 rounded-md mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold text-blue-700">遗产份额计算器</h1>
                </div>
                <div class="text-sm">
                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full">免费使用</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区 -->
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- 进度条 -->
        <div class="mb-10">
            <div class="flex justify-between mb-2">
                <span class="text-sm font-medium">计算进度</span>
                <span class="text-sm font-medium"><span id="current-step">1</span>/9</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full progress-bar" style="width: 11%"></div>
            </div>
        </div>

        <!-- 计算器表单 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <!-- 步骤1: 基本情况 -->
            <div id="step1" class="step active">
                <h2 class="text-2xl font-bold mb-6 text-blue-800">第一步：被继承人基本情况</h2>
                <div class="space-y-6">
                    <div>
                        <label class="block text-lg font-medium mb-2">被继承人是否留有遗嘱？</label>
                        <div class="flex flex-col space-y-4">
                            <label class="flex items-center">
                                <input type="radio" name="hasWill" value="no" class="mr-3 h-5 w-5" checked>
                                <div>
                                    <span class="font-medium">无遗嘱</span>
                                    <p class="text-gray-600 text-sm">按法定继承规则计算继承份额</p>
                                </div>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="hasWill" value="yes" class="mr-3 h-5 w-5">
                                <div>
                                    <span class="font-medium">有遗嘱</span>
                                    <p class="text-gray-600 text-sm">按遗嘱继承，但需注意法律规定的特殊情况</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div id="willWarning" class="bg-blue-50 p-4 rounded-lg hidden">
                        <h3 class="font-medium text-blue-800 mb-2">重要提示</h3>
                        <div class="space-y-2 text-blue-700 text-sm">
                            <p>根据《民法典》第一千一百五十四条规定，有下列情形之一的，遗产中的有关部分按照法定继承办理：</p>
                            <ul class="list-disc pl-5 space-y-1">
                                <li>遗嘱继承人放弃继承或者受遗赠人放弃受遗赠</li>
                                <li>遗嘱继承人丧失继承权或者受遗赠人丧失受遗赠权</li>
                                <li>遗嘱继承人、受遗赠人先于遗嘱人死亡</li>
                                <li>遗嘱无效部分所涉及的遗产</li>
                                <li>遗嘱未处分的遗产</li>
                            </ul>
                            <p>如存在上述情形，相关遗产将按法定继承规则处理。</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-10">
                    <div></div>
                    <button onclick="nextStep()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-8 rounded-lg transition duration-200">
                        下一步
                    </button>
                </div>
            </div>

            <!-- 步骤2: 配偶情况 -->
            <div id="step2" class="step">
                <h2 class="text-2xl font-bold mb-6 text-blue-800">第二步：被继承人配偶情况</h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-lg font-medium mb-2">被继承人的配偶情况</label>
                        <div class="space-y-4">
                            <label class="flex items-start">
                                <input type="radio" name="spouse" value="alive" class="mr-3 h-5 w-5 mt-1">
                                <div>
                                    <span class="font-medium">在世</span>
                                    <p class="text-gray-600 text-sm">配偶有权继承遗产</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start">
                                <input type="radio" name="spouse" value="deceased_before" class="mr-3 h-5 w-5 mt-1">
                                <div>
                                    <span class="font-medium">已故（在被继承人之前去世）</span>
                                    <p class="text-gray-600 text-sm">配偶无权继承遗产</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start">
                                <input type="radio" name="spouse" value="deceased_after" class="mr-3 h-5 w-5 mt-1">
                                <div>
                                    <span class="font-medium">已故（在被继承人之后去世）</span>
                                    <p class="text-gray-600 text-sm">涉及转继承，配偶应继承的份额转由其继承人继承</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start">
                                <input type="radio" name="spouse" value="divorced" class="mr-3 h-5 w-5 mt-1">
                                <div>
                                    <span class="font-medium">已离婚</span>
                                    <p class="text-gray-600 text-sm">配偶无权继承遗产</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- 配偶姓名输入 -->
                    <div>
                        <label class="block text-lg font-medium mb-2">配偶姓名（可选）</label>
                        <input type="text" id="spouseName" class="w-full border rounded-lg py-3 px-4 text-lg" placeholder="请输入配偶姓名">
                        <p class="text-gray-600 text-sm mt-2">请输入配偶姓名，如不清楚可不填</p>
                    </div>

                    <!-- 转继承人信息（仅当选择"在被继承人之后去世"时显示） -->
                    <div id="spouseTransferredContainer" class="hidden">
                        <div class="border-l-4 border-blue-400 pl-4 ml-3">
                            <label class="block text-lg font-medium mb-2">配偶的转继承人信息</label>
                            <div class="mb-4">
                                <p class="text-sm text-gray-600 mb-3">
                                    <strong>转继承说明：</strong>配偶在被继承人之后去世，其应继承的份额转由他的继承人继承，通常是配偶的子女、父母等。例如：张先生的妻子李女士在张先生去世后也去世了，李女士应继承的份额转由李女士的子女继承。
                                </p>
                            </div>
                            
                            <div id="spouseTransferredList" class="space-y-4 mb-4">
                                <!-- 动态添加的转继承人行将出现在这里 -->
                            </div>
                            
                            <button type="button" onclick="addSpouseTransferred()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-blue-500 hover:text-blue-600 transition duration-200">
                                + 添加转继承人
                            </button>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-medium text-blue-800 mb-2">法律提示</h3>
                        <div class="space-y-2 text-blue-700 text-sm">
                            <p>• 夫妻共同财产应先分出一半归配偶所有，其余部分作为遗产</p>
                            <p>• 已离婚的配偶无权继承遗产</p>
                            <p>• 配偶在被继承人之后去世的，涉及转继承</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-10">
                    <button onclick="prevStep()" class="bg-gray-200 hover:bg-gray-300 font-medium py-3 px-8 rounded-lg transition duration-200">
                        上一步
                    </button>
                    <button onclick="nextStep()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-8 rounded-lg transition duration-200">
                        下一步
                    </button>
                </div>
            </div>

            <!-- 步骤3: 子女情况 -->
            <div id="step3" class="step">
                <h2 class="text-2xl font-bold mb-6 text-blue-800">第三步：被继承人子女情况</h2>
                
                <div class="space-y-6">
                    <!-- 是否有子女选择 -->
                    <div>
                        <label class="block text-lg font-medium mb-2">是否有子女？</label>
                        <div class="flex space-x-6 mb-6">
                            <label class="flex items-center">
                                <input type="radio" name="hasChildren" value="yes" class="mr-2" id="hasChildrenYes">
                                <span>有子女</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="hasChildren" value="no" class="mr-2" id="hasChildrenNo" checked>
                                <span>无子女</span>
                            </label>
                        </div>
                    </div>

                    <!-- 子女信息容器（默认隐藏，当选择"有子女"时显示） -->
                    <div id="childrenContainer" class="hidden">
                        <p class="text-gray-600 mb-6">请添加所有子女信息（包括婚生子女、非婚生子女、养子女、有扶养关系的继子女）</p>
                        
                        <div id="childrenList">
                            <!-- 动态添加的子女行将出现在这里 -->
                        </div>
                        
                        <button type="button" onclick="addChild()" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-blue-500 hover:text-blue-600 transition duration-200 mb-6">
                            + 添加子女
                        </button>
                    </div>
                    
                    <!-- 代位继承说明 -->
                    <div class="bg-blue-50 p-4 rounded-lg mb-4">
                        <h3 class="font-medium text-blue-800 mb-2 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            代位继承说明
                        </h3>
                        <div class="space-y-2 text-blue-700 text-sm">
                            <p><strong>定义：</strong>被继承人的子女先于被继承人死亡时，由该先亡子女的子女（孙子女/外孙子女）代替其继承遗产。</p>
                            <p><strong>举例：</strong>张三先于父亲去世，张三的儿子张小三可以代位继承张三应得的份额。如有多个代位继承人，一般平均分配该份额。</p>
                        </div>
                    </div>
                    
                    <!-- 转继承说明 -->
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h3 class="font-medium text-purple-800 mb-2 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            子女转继承说明
                        </h3>
                        <div class="space-y-2 text-purple-700 text-sm">
                            <p><strong>定义：</strong>子女在被继承人去世后、遗产分割前去世，其应继承的份额转由他的继承人（配偶、子女、父母等）继承。</p>
                            <p><strong>举例：</strong>张三在被继承人去世后、遗产分割前去世，张三应继承的份额转由张三的配偶、子女、父母继承。</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-10">
                    <button onclick="prevStep()" class="bg-gray-200 hover:bg-gray-300 font-medium py-3 px-8 rounded-lg transition duration-200">
                        上一步
                    </button>
                    <button onclick="nextStep()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-8 rounded-lg transition duration-200">
                        下一步
                    </button>
                </div>
            </div>

            <!-- 步骤4: 父母情况 -->
            <div id="step4" class="step">
                <h2 class="text-2xl font-bold mb-6 text-blue-800">第四步：被继承人父母情况</h2>
                
                <div class="space-y-8">
                    <!-- 父亲情况 -->
                    <div class="p-4 border rounded-lg">
                        <h3 class="font-medium mb-4">父亲情况</h3>
                        <div class="space-y-4">
                            <div class="space-y-3">
                                <label class="flex items-start">
                                    <input type="radio" name="father" value="alive" class="mr-3 h-5 w-5 mt-1">
                                    <div>
                                        <span class="font-medium">在世</span>
                                        <p class="text-gray-600 text-sm">父亲有权继承遗产</p>
                                    </div>
                                </label>
                                
                                <label class="flex items-start">
                                    <input type="radio" name="father" value="deceased_before" class="mr-3 h-5 w-5 mt-1" checked>
                                    <div>
                                        <span class="font-medium">已故（在被继承人之前去世）</span>
                                        <p class="text-gray-600 text-sm">父亲无权继承遗产</p>
                                    </div>
                                </label>
                                
                                <label class="flex items-start">
                                    <input type="radio" name="father" value="deceased_after" class="mr-3 h-5 w-5 mt-1">
                                    <div>
                                        <span class="font-medium">已故（在被继承人之后去世）</span>
                                        <p class="text-gray-600 text-sm">涉及转继承，父亲应继承的份额转由其继承人继承</p>
                                    </div>
                                </label>
                            </div>
                            
                            <div id="fatherTransferredContainer" class="hidden border-l-4 border-blue-400 pl-4 mt-4">
                                <label class="block text-sm font-medium mb-2">父亲的转继承人信息</label>
                                <div class="mb-3">
                                    <p class="text-xs text-gray-600 mb-2">
                                        <strong>转继承说明：</strong>父亲在被继承人之后去世，父亲本应继承的份额转由他的继承人继承。
                                    </p>
                                    <p class="text-xs text-red-600 font-medium mb-2">
                                        <strong>特别注意：</strong>被继承人（父亲的子女）也是转继承人之一，但因被继承人已去世，此处应填写被继承人的子女（即父亲的孙子女）。如果有多个孙子女，应写在同一栏中。
                                    </p>
                                    <p class="text-xs text-gray-600">
                                        <strong>举例：</strong>张先生的父亲在张先生去世后也去世了，张先生的父亲应继承的份额转由张先生的兄弟姐妹和张先生的子女（孙子女）共同继承。如果张先生有两个子女张小一和张小二，那么转继承人一栏应填写"张小一、张小二"。
                                    </p>
                                </div>
                                
                                <div id="fatherTransferredList" class="space-y-3 mb-3">
                                    <!-- 动态添加的父亲转继承人行将出现在这里 -->
                                </div>
                                
                                <button type="button" onclick="addFatherTransferred()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-blue-500 hover:text-blue-600 transition duration-200 text-sm">
                                    + 添加转继承人
                                </button>
                            </div>
                            
                            <div class="mt-4">
                                <label class="block text-sm font-medium mb-1">父亲姓名（可选）</label>
                                <input type="text" id="fatherName" class="w-full border rounded py-2 px-3" placeholder="请输入父亲姓名">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 母亲情况 -->
                    <div class="p-4 border rounded-lg">
                        <h3 class="font-medium mb-4">母亲情况</h3>
                        <div class="space-y-4">
                            <div class="space-y-3">
                                <label class="flex items-start">
                                    <input type="radio" name="mother" value="alive" class="mr-3 h-5 w-5 mt-1">
                                    <div>
                                        <span class="font-medium">在世</span>
                                        <p class="text-gray-600 text-sm">母亲有权继承遗产</p>
                                    </div>
                                </label>
                                
                                <label class="flex items-start">
                                    <input type="radio" name="mother" value="deceased_before" class="mr-3 h-5 w-5 mt-1" checked>
                                    <div>
                                        <span class="font-medium">已故（在被继承人之前去世）</span>
                                        <p class="text-gray-600 text-sm">母亲无权继承遗产</p>
                                    </div>
                                </label>
                                
                                <label class="flex items-start">
                                    <input type="radio" name="mother" value="deceased_after" class="mr-3 h-5 w-5 mt-1">
                                    <div>
                                        <span class="font-medium">已故（在被继承人之后去世）</span>
                                        <p class="text-gray-600 text-sm">涉及转继承，母亲应继承的份额转由其继承人继承</p>
                                    </div>
                                </label>
                            </div>
                            
                            <div id="motherTransferredContainer" class="hidden border-l-4 border-blue-400 pl-4 mt-4">
                                <label class="block text-sm font-medium mb-2">母亲的转继承人信息</label>
                                <div class="mb-3">
                                    <p class="text-xs text-gray-600 mb-2">
                                        <strong>转继承说明：</strong>母亲在被继承人之后去世，母亲本应继承的份额转由她的继承人继承。
                                    </p>
                                    <p class="text-xs text-red-600 font-medium mb-2">
                                        <strong>特别注意：</strong>被继承人（母亲的子女）也是转继承人之一，但因被继承人已去世，此处应填写被继承人的子女（即母亲的孙子女）。如果有多个孙子女，应写在同一栏中。
                                    </p>
                                    <p class="text-xs text-gray-600">
                                        <strong>举例：</strong>张先生的母亲在张先生去世后也去世了，张先生的母亲应继承的份额转由张先生的兄弟姐妹和张先生的子女（孙子女）共同继承。如果张先生有两个子女张小一和张小二，那么转继承人一栏应填写"张小一、张小二"。
                                    </p>
                                </div>
                                
                                <div id="motherTransferredList" class="space-y-3 mb-3">
                                    <!-- 动态添加的母亲转继承人行将出现在这里 -->
                                </div>
                                
                                <button type="button" onclick="addMotherTransferred()" class="w-full py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-blue-500 hover:text-blue-600 transition duration-200 text-sm">
                                    + 添加转继承人
                                </button>
                            </div>
                            
                            <div class="mt-4">
                                <label class="block text-sm font-medium mb-1">母亲姓名（可选）</label>
                                <input type="text" id="motherName" class="w-full border rounded py-2 px-3" placeholder="请输入母亲姓名">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-10">
                    <button onclick="prevStep()" class="bg-gray-200 hover:bg-gray-300 font-medium py-3 px-8 rounded-lg transition duration-200">
                        上一步
                    </button>
                    <button onclick="nextStep()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-8 rounded-lg transition duration-200">
                        下一步
                    </button>
                </div>
            </div>

            <!-- 步骤5: 第二顺序继承人情况 -->
            <div id="step5" class="step">
                <h2 class="text-2xl font-bold mb-6 text-blue-800">第五步：被继承人第二顺序继承人情况</h2>
                <p class="text-gray-600 mb-6">如已有第一顺序继承人（配偶、子女、父母）的，此步可忽略。</p>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-lg font-medium mb-2">兄弟姐妹情况</label>
                        <div class="space-y-3">
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="hasSiblings" class="mr-2">
                                    <span>有兄弟姐妹（包括同父母、同父异母、同母异父、养兄弟姐妹、有扶养关系的继兄弟姐妹）</span>
                                </label>
                            </div>
                            <div id="siblingsContainer" class="ml-6 hidden">
                                <div id="siblingsList" class="space-y-4">
                                    <!-- 动态添加的兄弟姐妹行将出现在这里 -->
                                </div>
                                <button type="button" onclick="addSibling()" class="w-full mt-4 py-2 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-blue-500 hover:text-blue-600 transition duration-200 text-sm">
                                    + 添加兄弟姐妹
                                </button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-lg font-medium mb-2">祖父母、外祖父母情况</label>
                        <div class="space-y-4">
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="hasPaternalGrandfather" class="mr-2">
                                    <span>祖父（父亲的父亲）在世</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="hasPaternalGrandmother" class="mr-2">
                                    <span>祖母（父亲的母亲）在世</span>
                                </label>
                            </div>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="hasMaternalGrandfather" class="mr-2">
                                    <span>外祖父（母亲的父亲）在世</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="hasMaternalGrandmother" class="mr-2">
                                    <span>外祖母（母亲的母亲）在世</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第二顺序继承人转继承提示 -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-medium text-blue-800 mb-2">关于第二顺序继承人的提示</h3>
                        <div class="space-y-2 text-blue-700 text-sm">
                            <p>第二顺序继承人（兄弟姐妹、祖父母、外祖父母）如果涉及先于或后于被继承人去世的情况，计算较为复杂。</p>
                            <p>如果您的家庭涉及上述情形，建议咨询专业律师以获得准确的法律意见。</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-10">
                    <button onclick="prevStep()" class="bg-gray-200 hover:bg-gray-300 font-medium py-3 px-8 rounded-lg transition duration-200">
                        上一步
                    </button>
                    <button onclick="nextStep()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-8 rounded-lg transition duration-200">
                        下一步
                    </button>
                </div>
            </div>

            <!-- 步骤6: 遗产情况 -->
            <div id="step6" class="step">
                <h2 class="text-2xl font-bold mb-6 text-blue-800">第六步：被继承人遗产情况</h2>
                
                <div class="space-y-8">
                    <div class="bg-blue-50 p-5 rounded-lg border border-blue-200">
                        <h3 class="font-bold text-blue-800 mb-3">关于夫妻共同财产的提示</h3>
                        <div class="space-y-3 text-blue-700 text-sm">
                            <p>根据《民法典》第一千一百五十三条规定：</p>
                            <p>夫妻共同所有的财产，遗产分割时应先将一半分出为配偶所有，其余部分为被继承人的遗产。</p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-lg font-medium mb-2">遗产是否包含夫妻共同财产？</label>
                        <div class="flex space-x-6 mb-4">
                            <label class="flex items-center">
                                <input type="radio" name="isCommunityProperty" value="yes" class="mr-2">
                                <span>包含夫妻共同财产</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="isCommunityProperty" value="no" class="mr-2" checked>
                                <span>全部为被继承人个人财产</span>
                            </label>
                        </div>
                        
                        <div id="communityPropertyDetails" class="hidden ml-6 p-4 bg-gray-50 rounded-lg">
                            <label class="block text-sm font-medium mb-2">夫妻共同财产总额（人民币）</label>
                            <div class="flex items-center mb-2">
                                <span class="text-xl mr-2">¥</span>
                                <input type="number" id="communityPropertyAmount" min="0" placeholder="例如：2000000" class="w-full border rounded-lg py-2 px-4">
                            </div>
                            <p class="text-gray-600 text-sm">请输入夫妻共同财产的总价值</p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-lg font-medium mb-2">遗产总额（人民币）</label>
                        <div class="flex items-center">
                            <span class="text-2xl mr-2">¥</span>
                            <input type="number" id="estateAmount" min="0" placeholder="例如：1000000" class="w-full border rounded-lg py-3 px-4 text-lg">
                        </div>
                        <p class="text-gray-600 text-sm mt-2">
                            * 遗产总额 = 夫妻共同财产总额 × 50% + 被继承人其他个人财产
                        </p>
                    </div>
                </div>
                
                <div class="flex justify-between mt-10">
                    <button onclick="prevStep()" class="bg-gray-200 hover:bg-gray-300 font-medium py-3 px-8 rounded-lg transition duration-200">
                        上一步
                    </button>
                    <button onclick="nextStep()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-8 rounded-lg transition duration-200">
                        下一步
                    </button>
                </div>
            </div>

            <!-- 步骤7: 继承人的特殊情况 -->
            <div id="step7" class="step">
                <h2 class="text-2xl font-bold mb-6 text-blue-800">第七步：继承人的特殊情况</h2>
                
                <div class="space-y-6">
                    <div class="bg-yellow-50 p-4 rounded-lg mb-4">
                        <h3 class="font-medium text-yellow-800 mb-2">重要提示</h3>
                        <div class="space-y-2 text-yellow-700 text-sm">
                            <p>以下特殊情况均由法院个案分析，本工具不计算具体份额。</p>
                            <p>具体可详询专业律师。</p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-lg font-medium mb-2">是否有以下特殊情况？</label>
                        <div class="space-y-4">
                            <label class="flex items-start">
                                <input type="checkbox" id="specialCase1" class="mr-3 h-5 w-5 mt-1">
                                <div>
                                    <span class="font-medium">继承人对被继承人尽了主要扶养义务</span>
                                    <p class="text-gray-600 text-sm">可多分遗产</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start">
                                <input type="checkbox" id="specialCase2" class="mr-3 h-5 w-5 mt-1">
                                <div>
                                    <span class="font-medium">继承人生活有特殊困难且缺乏劳动能力</span>
                                    <p class="text-gray-600 text-sm">应予以照顾</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start">
                                <input type="checkbox" id="specialCase3" class="mr-3 h-5 w-5 mt-1">
                                <div>
                                    <span class="font-medium">有扶养能力和条件的继承人，未尽扶养义务</span>
                                    <p class="text-gray-600 text-sm">应当不分或者少分</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start">
                                <input type="checkbox" id="specialCase4" class="mr-3 h-5 w-5 mt-1">
                                <div>
                                    <span class="font-medium">存在胎儿继承权</span>
                                    <p class="text-gray-600 text-sm">应为胎儿保留继承份额</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start">
                                <input type="checkbox" id="specialCase5" class="mr-3 h-5 w-5 mt-1">
                                <div>
                                    <span class="font-medium">丧偶儿媳/女婿尽了主要赡养义务</span>
                                    <p class="text-gray-600 text-sm">可作为第一顺序继承人</p>
                                </div>
                            </label>
                            
                            <label class="flex items-start">
                                <input type="checkbox" id="specialCase6" class="mr-3 h-5 w-5 mt-1">
                                <div>
                                    <span class="font-medium">继承人以外的人可分得遗产</span>
                                    <p class="text-gray-600 text-sm">依靠被继承人扶养或对被继承人扶养较多的人</p>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-10">
                    <button onclick="prevStep()" class="bg-gray-200 hover:bg-gray-300 font-medium py-3 px-8 rounded-lg transition duration-200">
                        上一步
                    </button>
                    <button onclick="nextStep()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-8 rounded-lg transition duration-200">
                        下一步
                    </button>
                </div>
            </div>

            <!-- 步骤8: 信息确认页 -->
            <div id="step8" class="step">
                <h2 class="text-2xl font-bold mb-6 text-blue-800">信息确认</h2>
                <p class="text-gray-600 mb-6">请确认以下信息是否正确，确认无误后点击"确认并计算"按钮</p>
                
                <div id="infoSummary" class="space-y-6">
                    <!-- 信息将通过JavaScript动态填充 -->
                </div>
                
                <div class="mt-10 p-6 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="font-bold text-blue-800 mb-3">重要提示</h3>
                    <div class="space-y-2 text-blue-700 text-sm">
                        <p>请仔细核对以上信息，确保准确无误。</p>
                        <p>如有错误，请点击"上一步"返回修改。</p>
                    </div>
                </div>
                
                <div class="flex justify-between mt-10">
                    <button onclick="prevStep()" class="bg-gray-200 hover:bg-gray-300 font-medium py-3 px-8 rounded-lg transition duration-200">
                        上一步
                    </button>
                    <button onclick="calculateInheritance()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-8 rounded-lg transition duration-200">
                        确认并计算
                    </button>
                </div>
            </div>

            <!-- 步骤9: 计算结果 -->
            <div id="step9" class="step">
                <h2 class="text-2xl font-bold mb-6 text-blue-800">继承份额计算结果</h2>
                
                <div id="calculationResult" class="space-y-8">
                    <!-- 结果将通过JavaScript动态填充 -->
                </div>
                
                <!-- 夫妻共同财产提示 -->
                <div class="mt-6 p-6 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="font-bold text-blue-800 mb-3">关于继承所得财产的提示</h3>
                    <div class="space-y-2 text-blue-700 text-sm">
                        <p>继承人通过法定继承取得的遗产，原则上属于该继承人与其配偶的共同财产。</p>
                        <p>遗嘱或赠与合同中确定只归一方的财产除外。</p>
                    </div>
                </div>

                <!-- 自然引流到微信的卡片 -->
                <div class="mt-10 wechat-card p-6">
                    <div class="flex flex-col md:flex-row items-center">
                        <div class="md:w-2/3 md:pr-8 mb-6 md:mb-0">
                            <h3 class="text-xl font-bold mb-3">需要专业继承规划指导？</h3>
                            <p class="text-white/90 mb-4">计算结果仅供参考，实际继承可能涉及更多复杂因素。</p>
                            <ul class="space-y-2 text-sm text-white/90 mb-4">
                                <li class="flex items-start">
                                    <svg class="h-5 w-5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>免费获取《遗产继承法律指南》PDF</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="h-5 w-5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>专业律师在线解答继承疑问</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="h-5 w-5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>遗嘱模板与继承手续指导</span>
                                </li>
                            </ul>
                            <div class="bg-white/20 p-3 rounded-lg">
                                <p class="text-sm font-medium mb-1">添加微信获取帮助</p>
                                <div class="flex items-center">
                                    <div class="bg-white p-1 rounded mr-3">
                                        <!-- 微信图标 -->
                                        <svg class="h-8 w-8 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.16.16-.295.295-.605.295l.213-3.053 5.56-5.022c.241-.213-.054-.334-.373-.121l-6.869 4.326-2.962-.924c-.643-.204-.657-.643.136-.953l11.566-4.458c.538-.196 1.006.128.832.941z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-bold text-lg">黄冠雄 继承律师</p>
                                        <p class="text-sm opacity-90">微信号: <span id="wechatId" class="font-mono">ner_0710</span></p>
                                        <button onclick="copyWechatId()" class="mt-2 bg-white text-green-700 hover:bg-gray-100 font-medium py-1 px-3 rounded text-sm transition duration-200">
                                            复制微信号
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="md:w-1/3 text-center">
                            <div class="bg-white p-4 rounded-lg inline-block">
                                <div class="text-center mb-2">
                                    <div class="text-xs text-gray-500 mb-1">微信扫码添加好友</div>
                                    <div class="text-xs text-gray-500">（备注"遗产计算"优先通过）</div>
                                </div>
                                <!-- 二维码占位图 -->
                                <div class="w-48 h-48 bg-gradient-to-br from-green-100 to-green-300 rounded flex items-center justify-center">
                                    <div class="text-center">
                                        <div class="text-green-700 font-bold mb-1">微信二维码</div>
                                        <div class="text-green-600 text-sm">请扫码添加</div>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-600 mt-2">扫码或搜索上方微信号添加</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-10 p-6 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="font-bold text-blue-800 mb-3">重要法律声明</h3>
                    <div class="space-y-2 text-blue-700 text-sm">
                        <p>1. 本计算结果仅供参考，不构成正式法律意见。</p>
                        <p>2. 实际继承情况可能因具体案情、地方司法实践、证据材料等因素而有所不同。</p>
                        <p>3. 建议在重大遗产分配前咨询专业律师或公证处，以确保合法合规。</p>
                    </div>
                </div>
                
                <div class="mt-10 flex flex-col sm:flex-row justify-between space-y-4 sm:space-y-0">
                    <button onclick="restartCalculator()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-8 rounded-lg transition duration-200">
                        重新计算
                    </button>
                    <div class="space-x-4">
                        <button onclick="saveResult()" class="bg-gray-200 hover:bg-gray-300 font-medium py-3 px-6 rounded-lg transition duration-200">
                            保存结果
                        </button>
                        <button onclick="shareResult()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg transition duration-200">
                            分享给家人
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 常见问题 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mt-8">
            <h3 class="text-xl font-bold mb-6 text-blue-800">常见问题解答</h3>
            <div class="space-y-6">
                <div>
                    <h4 class="font-medium mb-2">1. 遗产计算的法律依据是什么？</h4>
                    <p class="text-gray-600 text-sm">本计算器依据《中华人民共和国民法典》继承编的相关规定，特别是关于法定继承顺序和份额分配的规定。</p>
                </div>
                <div>
                    <h4 class="font-medium mb-2">2. 夫妻共同财产如何分割？</h4>
                    <p class="text-gray-600 text-sm">根据《民法典》规定，夫妻共同财产应先分出一半归配偶所有，剩余部分作为被继承人的遗产进行分配。</p>
                </div>
                <div>
                    <h4 class="font-medium mb-2">3. 什么是代位继承和转继承？</h4>
                    <p class="text-gray-600 text-sm">代位继承：子女先于被继承人去世，由其子女代位继承。转继承：继承开始后遗产分割前继承人去世，由其继承人转继承。</p>
                </div>
                <div>
                    <h4 class="font-medium mb-2">4. 我的数据会被保存吗？</h4>
                    <p class="text-gray-600 text-sm">本计算器完全在前端运行，不会将您的任何数据上传到服务器，保护您的隐私安全。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <h2 class="text-xl font-bold mb-2">遗产份额计算器</h2>
                    <p class="text-gray-400 text-sm">免费在线工具 · 基于《民法典》继承编</p>
                </div>
                <div class="text-center md:text-right">
                    <p class="text-gray-400 text-sm">© 2023 遗产份额计算器. 本工具仅供参考。</p>
                    <p class="text-gray-400 text-sm mt-1">建议复杂案件咨询专业律师。</p>
                    <p class="text-gray-400 text-sm mt-2">
                        <a href="#" class="hover:text-white">免责声明</a> | 
                        <a href="#" class="hover:text-white">隐私政策</a> | 
                        <a href="#" class="hover:text-white">联系我们</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript 代码 -->
    <script>
        // 全局变量
        let currentStep = 1;
        const totalSteps = 9;
        let inheritanceResult = {};

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 监听是否有遗嘱选择
            const willRadios = document.querySelectorAll('input[name="hasWill"]');
            willRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const warningDiv = document.getElementById('willWarning');
                    if (this.value === 'yes') {
                        warningDiv.classList.remove('hidden');
                    } else {
                        warningDiv.classList.add('hidden');
                    }
                });
            });

            // 监听是否包含夫妻共同财产
            const communityPropertyRadios = document.querySelectorAll('input[name="isCommunityProperty"]');
            const communityPropertyDetails = document.getElementById('communityPropertyDetails');
            
            communityPropertyRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'yes') {
                        communityPropertyDetails.classList.remove('hidden');
                    } else {
                        communityPropertyDetails.classList.add('hidden');
                    }
                });
            });

            // 监听是否有子女选择
            const hasChildrenYes = document.getElementById('hasChildrenYes');
            const hasChildrenNo = document.getElementById('hasChildrenNo');
            const childrenContainer = document.getElementById('childrenContainer');
            
            hasChildrenYes.addEventListener('change', function() {
                if (this.checked) {
                    childrenContainer.classList.remove('hidden');
                    // 如果没有子女行，添加一个
                    if (document.querySelectorAll('#childrenList .child-item').length === 0) {
                        addChild();
                    }
                }
            });
            
            hasChildrenNo.addEventListener('change', function() {
                if (this.checked) {
                    childrenContainer.classList.add('hidden');
                    // 清空所有子女行
                    document.getElementById('childrenList').innerHTML = '';
                }
            });

            // 监听是否有兄弟姐妹选择
            const hasSiblings = document.getElementById('hasSiblings');
            const siblingsContainer = document.getElementById('siblingsContainer');
            
            hasSiblings.addEventListener('change', function() {
                if (this.checked) {
                    siblingsContainer.classList.remove('hidden');
                    // 如果没有兄弟姐妹行，添加一个
                    if (document.querySelectorAll('#siblingsList .sibling-item').length === 0) {
                        addSibling();
                    }
                } else {
                    siblingsContainer.classList.add('hidden');
                    document.getElementById('siblingsList').innerHTML = '';
                }
            });

            // 监听配偶情况变化，显示/隐藏转继承人信息
            const spouseRadios = document.querySelectorAll('input[name="spouse"]');
            const spouseTransferredContainer = document.getElementById('spouseTransferredContainer');
            
            spouseRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'deceased_after') {
                        spouseTransferredContainer.classList.remove('hidden');
                        // 如果没有转继承人行，添加一个
                        if (document.querySelectorAll('#spouseTransferredList .transferred-item').length === 0) {
                            addSpouseTransferred();
                        }
                    } else {
                        spouseTransferredContainer.classList.add('hidden');
                    }
                });
            });

            // 监听父亲情况变化
            const fatherRadios = document.querySelectorAll('input[name="father"]');
            const fatherTransferredContainer = document.getElementById('fatherTransferredContainer');
            
            fatherRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'deceased_after') {
                        fatherTransferredContainer.classList.remove('hidden');
                        // 如果没有转继承人行，添加一个
                        if (document.querySelectorAll('#fatherTransferredList .transferred-item').length === 0) {
                            addFatherTransferred();
                        }
                    } else {
                        fatherTransferredContainer.classList.add('hidden');
                    }
                });
            });

            // 监听母亲情况变化
            const motherRadios = document.querySelectorAll('input[name="mother"]');
            const motherTransferredContainer = document.getElementById('motherTransferredContainer');
            
            motherRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'deceased_after') {
                        motherTransferredContainer.classList.remove('hidden');
                        // 如果没有转继承人行，添加一个
                        if (document.querySelectorAll('#motherTransferredList .transferred-item').length === 0) {
                            addMotherTransferred();
                        }
                    } else {
                        motherTransferredContainer.classList.add('hidden');
                    }
                });
            });
        });

        // 步骤导航函数
        function nextStep() {
            if (currentStep < totalSteps) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep++;
                
                // 如果进入信息确认页，先更新显示信息
                if (currentStep === 8) {
                    updateInfoSummary();
                }
                
                document.getElementById(`step${currentStep}`).classList.add('active');
                updateProgress();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep--;
                document.getElementById(`step${currentStep}`).classList.add('active');
                updateProgress();
            }
        }

        function updateProgress() {
            const progressPercent = ((currentStep - 1) / (totalSteps - 1)) * 100;
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;
            document.getElementById('current-step').textContent = currentStep;
        }

        // 添加子女行
        function addChild() {
            const container = document.getElementById('childrenList');
            const childCount = container.querySelectorAll('.child-item').length + 1;
            
            const childDiv = document.createElement('div');
            childDiv.className = 'child-item p-4 border rounded-lg mb-4 fade-in';
            childDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">子女姓名（子女${childCount}）</label>
                        <input type="text" class="child-name w-full border rounded py-2 px-3" placeholder="请输入子女姓名">
                    </div>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="childStatus${childCount}" value="alive" class="mr-2 child-alive" checked>
                            <span class="text-sm">在世</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="childStatus${childCount}" value="predeceased" class="mr-2 child-predeceased">
                            <span class="text-sm">先于被继承人去世（代位继承）</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="childStatus${childCount}" value="transferred" class="mr-2 child-transferred">
                            <span class="text-sm">在被继承人之后去世（转继承）</span>
                        </label>
                    </div>
                </div>
                <div class="predeceased-details hidden">
                    <div class="mb-2">
                        <p class="text-xs text-gray-600">
                            <strong>提示：</strong>代位继承人通常是先亡子女的子女（孙子女/外孙子女）。例如：子女张三先于被继承人去世，张三的儿子张小三就是代位继承人。
                        </p>
                    </div>
                    <label class="block text-sm font-medium mb-1">代位继承人信息</label>
                    <div class="successors-container space-y-2">
                        <div class="flex items-center">
                            <input type="text" class="successor-name w-full border rounded py-2 px-3" placeholder="请输入代位继承人姓名">
                            <button type="button" onclick="removeSuccessor(this)" class="ml-2 text-red-600 hover:text-red-800">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button type="button" onclick="addSuccessor(this)" class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                        + 添加代位继承人
                    </button>
                </div>
                <div class="transferred-details hidden">
                    <div class="mb-2">
                        <p class="text-xs text-gray-600">
                            <strong>提示：</strong>转继承人通常是该子女的继承人（通常是该子女的配偶、子女、父母等）。
                        </p>
                    </div>
                    <label class="block text-sm font-medium mb-1">转继承人信息</label>
                    <div class="transferred-container space-y-2">
                        <div class="flex items-center">
                            <input type="text" class="transferred-name w-full border rounded py-2 px-3" placeholder="请输入转继承人姓名">
                            <button type="button" onclick="removeTransferred(this)" class="ml-2 text-red-600 hover:text-red-800">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button type="button" onclick="addTransferred(this)" class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                        + 添加转继承人
                    </button>
                </div>
                <div class="mt-4 flex justify-end">
                    <button type="button" onclick="removeChild(this)" class="text-red-600 hover:text-red-800 text-sm">
                        删除此子女
                    </button>
                </div>
            `;
            
            container.appendChild(childDiv);
            
            // 为新的子女行添加事件监听
            const newChildDiv = container.lastElementChild;
            const aliveRadio = newChildDiv.querySelector('.child-alive');
            const predeceasedRadio = newChildDiv.querySelector('.child-predeceased');
            const transferredRadio = newChildDiv.querySelector('.child-transferred');
            const predeceasedDetails = newChildDiv.querySelector('.predeceased-details');
            const transferredDetails = newChildDiv.querySelector('.transferred-details');
            
            aliveRadio.addEventListener('change', function() {
                if (this.checked) {
                    predeceasedDetails.classList.add('hidden');
                    transferredDetails.classList.add('hidden');
                }
            });
            
            predeceasedRadio.addEventListener('change', function() {
                if (this.checked) {
                    predeceasedDetails.classList.remove('hidden');
                    transferredDetails.classList.add('hidden');
                }
            });
            
            transferredRadio.addEventListener('change', function() {
                if (this.checked) {
                    transferredDetails.classList.remove('hidden');
                    predeceasedDetails.classList.add('hidden');
                }
            });
        }

        // 删除子女行
        function removeChild(button) {
            const childDiv = button.closest('.child-item');
            childDiv.style.opacity = '0';
            childDiv.style.transform = 'translateX(-20px)';
            setTimeout(() => {
                childDiv.remove();
                
                // 更新剩余子女的编号
                const children = document.querySelectorAll('#childrenList .child-item');
                children.forEach((child, index) => {
                    const label = child.querySelector('label[for]');
                    const input = child.querySelector('.child-name');
                    if (label && input) {
                        label.textContent = `子女姓名（子女${index + 1}）`;
                        input.placeholder = `请输入子女姓名`;
                    }
                });
                
                // 如果没有子女行了，自动选择"无子女"
                if (children.length === 0) {
                    document.getElementById('hasChildrenNo').checked = true;
                    document.getElementById('childrenContainer').classList.add('hidden');
                }
            }, 300);
        }

        // 添加兄弟姐妹行
        function addSibling() {
            const container = document.getElementById('siblingsList');
            const siblingCount = container.querySelectorAll('.sibling-item').length + 1;
            
            const siblingDiv = document.createElement('div');
            siblingDiv.className = 'sibling-item p-3 border rounded-lg fade-in';
            siblingDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-grow mr-4">
                        <label class="block text-sm font-medium mb-1">兄弟姐妹姓名（兄弟姐妹${siblingCount}）</label>
                        <input type="text" class="sibling-name w-full border rounded py-2 px-3" placeholder="请输入姓名">
                    </div>
                    <button type="button" onclick="removeSibling(this)" class="text-red-600 hover:text-red-800 text-sm">
                        删除
                    </button>
                </div>
            `;
            
            container.appendChild(siblingDiv);
        }

        // 删除兄弟姐妹行
        function removeSibling(button) {
            const siblingDiv = button.closest('.sibling-item');
            siblingDiv.style.opacity = '0';
            siblingDiv.style.transform = 'translateX(-20px)';
            setTimeout(() => {
                siblingDiv.remove();
                
                // 更新剩余兄弟姐妹的编号
                const siblings = document.querySelectorAll('#siblingsList .sibling-item');
                siblings.forEach((sibling, index) => {
                    const label = sibling.querySelector('label');
                    if (label) {
                        label.textContent = `兄弟姐妹姓名（兄弟姐妹${index + 1}）`;
                    }
                });
            }, 300);
        }

        // 添加配偶转继承人
        function addSpouseTransferred() {
            const container = document.getElementById('spouseTransferredList');
            const transferredCount = container.querySelectorAll('.transferred-item').length + 1;
            
            const transferredDiv = document.createElement('div');
            transferredDiv.className = 'transferred-item p-3 border rounded-lg fade-in';
            transferredDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-grow mr-4">
                        <label class="block text-sm font-medium mb-1">转继承人姓名（转继承人${transferredCount}）</label>
                        <input type="text" class="transferred-name w-full border rounded py-2 px-3" placeholder="请输入转继承人姓名">
                    </div>
                    <button type="button" onclick="removeTransferredItem(this)" class="text-red-600 hover:text-red-800 text-sm">
                        删除
                    </button>
                </div>
            `;
            
            container.appendChild(transferredDiv);
        }

        // 添加父亲转继承人
        function addFatherTransferred() {
            const container = document.getElementById('fatherTransferredList');
            const transferredCount = container.querySelectorAll('.transferred-item').length + 1;
            
            const transferredDiv = document.createElement('div');
            transferredDiv.className = 'transferred-item p-2 border rounded-lg fade-in';
            transferredDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-grow mr-2">
                        <label class="block text-xs font-medium mb-1">转继承人${transferredCount}</label>
                        <input type="text" class="transferred-name w-full border rounded py-1 px-2 text-sm" placeholder="例如：张小一、张小二（被继承人的子女）">
                    </div>
                    <button type="button" onclick="removeTransferredItem(this)" class="text-red-600 hover:text-red-800 text-xs">
                        删除
                    </button>
                </div>
            `;
            
            container.appendChild(transferredDiv);
        }

        // 添加母亲转继承人
        function addMotherTransferred() {
            const container = document.getElementById('motherTransferredList');
            const transferredCount = container.querySelectorAll('.transferred-item').length + 1;
            
            const transferredDiv = document.createElement('div');
            transferredDiv.className = 'transferred-item p-2 border rounded-lg fade-in';
            transferredDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-grow mr-2">
                        <label class="block text-xs font-medium mb-1">转继承人${transferredCount}</label>
                        <input type="text" class="transferred-name w-full border rounded py-1 px-2 text-sm" placeholder="例如：张小一、张小二（被继承人的子女）">
                    </div>
                    <button type="button" onclick="removeTransferredItem(this)" class="text-red-600 hover:text-red-800 text-xs">
                        删除
                    </button>
                </div>
            `;
            
            container.appendChild(transferredDiv);
        }

        // 删除转继承人（通用）
        function removeTransferredItem(button) {
            const transferredDiv = button.closest('.transferred-item');
            transferredDiv.style.opacity = '0';
            transferredDiv.style.transform = 'translateX(-20px)';
            setTimeout(() => {
                transferredDiv.remove();
            }, 300);
        }

        // 添加代位继承人
        function addSuccessor(button) {
            const container = button.previousElementSibling;
            const successorDiv = document.createElement('div');
            successorDiv.className = 'flex items-center';
            successorDiv.innerHTML = `
                <input type="text" class="successor-name w-full border rounded py-2 px-3" placeholder="请输入代位继承人姓名">
                <button type="button" onclick="removeSuccessor(this)" class="ml-2 text-red-600 hover:text-red-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                </button>
            `;
            container.appendChild(successorDiv);
        }

        // 添加转继承人（子女）
        function addTransferred(button) {
            const container = button.previousElementSibling;
            const transferredDiv = document.createElement('div');
            transferredDiv.className = 'flex items-center';
            transferredDiv.innerHTML = `
                <input type="text" class="transferred-name w-full border rounded py-2 px-3" placeholder="请输入转继承人姓名">
                <button type="button" onclick="removeTransferred(this)" class="ml-2 text-red-600 hover:text-red-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                </button>
            `;
            container.appendChild(transferredDiv);
        }

        // 删除代位继承人
        function removeSuccessor(button) {
            button.closest('.flex.items-center').remove();
        }

        // 删除转继承人（子女）
        function removeTransferred(button) {
            button.closest('.flex.items-center').remove();
        }

        // 更新信息确认页内容
        function updateInfoSummary() {
            const summaryDiv = document.getElementById('infoSummary');
            let html = '';
            
            // 1. 被继承人基本情况
            const hasWill = document.querySelector('input[name="hasWill"]:checked');
            let willText = '';
            if (hasWill) {
                if (hasWill.value === 'no') willText = '无遗嘱（按法定继承计算）';
                else if (hasWill.value === 'yes') willText = '有遗嘱（需注意法律规定的特殊情况）';
            }
            
            html += `
                <div class="info-summary-item p-4 border rounded-lg">
                    <h3 class="font-medium text-blue-800 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                        被继承人基本情况
                    </h3>
                    <p class="text-gray-700"><strong>遗嘱情况：</strong>${willText}</p>
                </div>
            `;
            
            // 2. 配偶情况
            const spouseStatus = document.querySelector('input[name="spouse"]:checked');
            let spouseText = '';
            if (spouseStatus) {
                if (spouseStatus.value === 'alive') spouseText = '配偶在世';
                else if (spouseStatus.value === 'deceased_before') spouseText = '配偶已故（在被继承人之前去世）';
                else if (spouseStatus.value === 'deceased_after') spouseText = '配偶已故（在被继承人之后去世）';
                else if (spouseStatus.value === 'divorced') spouseText = '配偶已离婚';
            }
            
            const spouseName = document.getElementById('spouseName').value.trim() || '配偶';
            
            // 收集配偶转继承人信息
            let spouseTransferredText = '';
            if (spouseStatus && spouseStatus.value === 'deceased_after') {
                const transferredNames = document.querySelectorAll('#spouseTransferredList .transferred-name');
                const names = [];
                transferredNames.forEach(input => {
                    if (input.value.trim()) names.push(input.value.trim());
                });
                if (names.length > 0) {
                    spouseTransferredText = `，转继承人：${names.join('、')}`;
                }
            }
            
            html += `
                <div class="info-summary-item p-4 border rounded-lg">
                    <h3 class="font-medium text-blue-800 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        被继承人配偶情况
                    </h3>
                    <p class="text-gray-700"><strong>配偶姓名：</strong>${spouseName}</p>
                    <p class="text-gray-700"><strong>配偶状态：</strong>${spouseText}${spouseTransferredText}</p>
                </div>
            `;
            
            // 3. 子女情况
            const hasChildren = document.getElementById('hasChildrenYes').checked;
            let childrenText = hasChildren ? '有子女' : '无子女';
            
            // 收集子女信息
            const childrenItems = document.querySelectorAll('#childrenList .child-item');
            let childrenDetails = [];
            
            if (hasChildren && childrenItems.length > 0) {
                childrenItems.forEach((item, index) => {
                    const name = item.querySelector('.child-name').value.trim() || `子女${index + 1}`;
                    const alive = item.querySelector('.child-alive').checked;
                    const predeceased = item.querySelector('.child-predeceased').checked;
                    const transferred = item.querySelector('.child-transferred').checked;
                    
                    let status = '在世';
                    if (predeceased) status = '先于被继承人去世（代位继承）';
                    else if (transferred) status = '在被继承人之后去世（转继承）';
                    
                    childrenDetails.push(`${name}（${status}）`);
                });
                
                if (childrenDetails.length > 0) {
                    childrenText += '：' + childrenDetails.join('；');
                }
            }
            
            html += `
                <div class="info-summary-item p-4 border rounded-lg">
                    <h3 class="font-medium text-blue-800 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
                        </svg>
                        被继承人子女情况
                    </h3>
                    <p class="text-gray-700"><strong>子女情况：</strong>${childrenText}</p>
                </div>
            `;
            
            // 4. 父母情况
            const fatherStatus = document.querySelector('input[name="father"]:checked');
            const motherStatus = document.querySelector('input[name="mother"]:checked');
            
            let fatherText = '';
            if (fatherStatus) {
                if (fatherStatus.value === 'alive') fatherText = '在世';
                else if (fatherStatus.value === 'deceased_before') fatherText = '已故（在被继承人之前去世）';
                else if (fatherStatus.value === 'deceased_after') fatherText = '已故（在被继承人之后去世）';
            }
            
            let motherText = '';
            if (motherStatus) {
                if (motherStatus.value === 'alive') motherText = '在世';
                else if (motherStatus.value === 'deceased_before') motherText = '已故（在被继承人之前去世）';
                else if (motherStatus.value === 'deceased_after') motherText = '已故（在被继承人之后去世）';
            }
            
            // 收集父亲转继承人信息
            let fatherTransferredText = '';
            if (fatherStatus && fatherStatus.value === 'deceased_after') {
                const transferredNames = document.querySelectorAll('#fatherTransferredList .transferred-name');
                const names = [];
                transferredNames.forEach(input => {
                    if (input.value.trim()) names.push(input.value.trim());
                });
                if (names.length > 0) {
                    fatherTransferredText = `，转继承人：${names.join('、')}`;
                }
            }
            
            // 收集母亲转继承人信息
            let motherTransferredText = '';
            if (motherStatus && motherStatus.value === 'deceased_after') {
                const transferredNames = document.querySelectorAll('#motherTransferredList .transferred-name');
                const names = [];
                transferredNames.forEach(input => {
                    if (input.value.trim()) names.push(input.value.trim());
                });
                if (names.length > 0) {
                    motherTransferredText = `，转继承人：${names.join('、')}`;
                }
            }
            
            const fatherName = document.getElementById('fatherName').value.trim() || '父亲';
            const motherName = document.getElementById('motherName').value.trim() || '母亲';
            
            html += `
                <div class="info-summary-item p-4 border rounded-lg">
                    <h3 class="font-medium text-blue-800 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        被继承人父母情况
                    </h3>
                    <p class="text-gray-700"><strong>父亲：</strong>${fatherName} - ${fatherText}${fatherTransferredText}</p>
                    <p class="text-gray-700"><strong>母亲：</strong>${motherName} - ${motherText}${motherTransferredText}</p>
                </div>
            `;
            
            // 5. 第二顺序继承人情况（如果有）
            const hasSiblings = document.getElementById('hasSiblings').checked;
            const hasPaternalGrandfather = document.getElementById('hasPaternalGrandfather').checked;
            const hasPaternalGrandmother = document.getElementById('hasPaternalGrandmother').checked;
            const hasMaternalGrandfather = document.getElementById('hasMaternalGrandfather').checked;
            const hasMaternalGrandmother = document.getElementById('hasMaternalGrandmother').checked;
            
            let secondOrderText = '';
            if (hasSiblings || hasPaternalGrandfather || hasPaternalGrandmother || hasMaternalGrandfather || hasMaternalGrandmother) {
                const parts = [];
                if (hasSiblings) {
                    const siblingNames = document.querySelectorAll('#siblingsList .sibling-name');
                    const names = [];
                    siblingNames.forEach(input => {
                        if (input.value.trim()) names.push(input.value.trim());
                    });
                    if (names.length > 0) {
                        parts.push(`兄弟姐妹：${names.join('、')}`);
                    } else {
                        parts.push('有兄弟姐妹');
                    }
                }
                if (hasPaternalGrandfather) parts.push('祖父在世');
                if (hasPaternalGrandmother) parts.push('祖母在世');
                if (hasMaternalGrandfather) parts.push('外祖父在世');
                if (hasMaternalGrandmother) parts.push('外祖母在世');
                
                if (parts.length > 0) {
                    secondOrderText = parts.join('；');
                }
            }
            
            if (secondOrderText) {
                html += `
                    <div class="info-summary-item p-4 border rounded-lg">
                        <h3 class="font-medium text-blue-800 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                            被继承人第二顺序继承人情况
                        </h3>
                        <p class="text-gray-700">${secondOrderText}</p>
                    </div>
                `;
            }
            
            // 6. 遗产情况
            const isCommunityProperty = document.querySelector('input[name="isCommunityProperty"]:checked');
            let estateText = '';
            if (isCommunityProperty) {
                if (isCommunityProperty.value === 'yes') {
                    const communityAmount = document.getElementById('communityPropertyAmount').value;
                    estateText = `包含夫妻共同财产，共同财产总额：${communityAmount ? '¥' + parseFloat(communityAmount).toLocaleString('zh-CN') : '未填写'}`;
                } else {
                    estateText = '全部为被继承人个人财产';
                }
            }
            
            const estateAmount = document.getElementById('estateAmount').value;
            if (estateAmount) {
                estateText += `，遗产总额：¥${parseFloat(estateAmount).toLocaleString('zh-CN')}`;
            }
            
            html += `
                <div class="info-summary-item p-4 border rounded-lg">
                    <h3 class="font-medium text-blue-800 mb-3 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        被继承人遗产情况
                    </h3>
                    <p class="text-gray-700">${estateText}</p>
                </div>
            `;
            
            // 7. 特殊情况
            const specialCases = [
                { id: 'specialCase1', text: '继承人对被继承人尽了主要扶养义务' },
                { id: 'specialCase2', text: '继承人生活有特殊困难且缺乏劳动能力' },
                { id: 'specialCase3', text: '有扶养能力和条件的继承人，未尽扶养义务' },
                { id: 'specialCase4', text: '存在胎儿继承权' },
                { id: 'specialCase5', text: '丧偶儿媳/女婿尽了主要赡养义务' },
                { id: 'specialCase6', text: '继承人以外的人可分得遗产' }
            ];
            
            const selectedSpecialCases = specialCases.filter(caseItem => {
                return document.getElementById(caseItem.id).checked;
            }).map(caseItem => caseItem.text);
            
            if (selectedSpecialCases.length > 0) {
                html += `
                    <div class="info-summary-item p-4 border rounded-lg">
                        <h3 class="font-medium text-blue-800 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            继承人的特殊情况
                        </h3>
                        <ul class="text-gray-700 list-disc pl-5 space-y-1">
                            ${selectedSpecialCases.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            summaryDiv.innerHTML = html;
        }

        // 核心计算函数 - 修复了配偶金额计算问题
        function calculateInheritance() {
            // 收集用户输入
            const hasWill = document.querySelector('input[name="hasWill"]:checked').value;
            const spouseStatus = document.querySelector('input[name="spouse"]:checked').value;
            const spouseName = document.getElementById('spouseName').value.trim() || '配偶';
            
            // 收集配偶转继承人信息
            let spouseTransferred = [];
            if (spouseStatus === 'deceased_after') {
                const transferredNames = document.querySelectorAll('#spouseTransferredList .transferred-name');
                transferredNames.forEach(input => {
                    if (input.value.trim()) {
                        spouseTransferred.push({
                            name: input.value.trim(),
                            parentName: spouseName,
                            share: 0
                        });
                    }
                });
            }
            
            // 收集子女信息
            const hasChildren = document.getElementById('hasChildrenYes').checked;
            let children = [];
            let successors = []; // 代位继承人
            let childrenTransferred = []; // 子女转继承人
            
            if (hasChildren) {
                const childrenItems = document.querySelectorAll('#childrenList .child-item');
                
                childrenItems.forEach((item, index) => {
                    const nameInput = item.querySelector('.child-name');
                    const name = nameInput.value.trim() || `子女${index + 1}`;
                    const alive = item.querySelector('.child-alive').checked;
                    const predeceased = item.querySelector('.child-predeceased').checked;
                    const transferred = item.querySelector('.child-transferred').checked;
                    
                    if (predeceased) {
                        // 代位继承
                        const successorNames = item.querySelectorAll('.successor-name');
                        successorNames.forEach(successor => {
                            if (successor.value.trim()) {
                                successors.push({
                                    name: successor.value.trim(),
                                    parentName: name,
                                    share: 0
                                });
                            }
                        });
                    } else if (transferred) {
                        // 转继承
                        const transferredNames = item.querySelectorAll('.transferred-name');
                        transferredNames.forEach(transferredPerson => {
                            if (transferredPerson.value.trim()) {
                                childrenTransferred.push({
                                    name: transferredPerson.value.trim(),
                                    parentName: name,
                                    share: 0
                                });
                            }
                        });
                    } else if (alive) {
                        // 在世子女
                        children.push({
                            name: name,
                            share: 0
                        });
                    }
                });
            }
            
            // 收集父母信息
            const fatherStatus = document.querySelector('input[name="father"]:checked').value;
            const motherStatus = document.querySelector('input[name="mother"]:checked').value;
            const fatherName = document.getElementById('fatherName').value.trim() || '父亲';
            const motherName = document.getElementById('motherName').value.trim() || '母亲';
            
            // 收集父亲转继承人信息
            let fatherTransferred = [];
            if (fatherStatus === 'deceased_after') {
                const transferredNames = document.querySelectorAll('#fatherTransferredList .transferred-name');
                transferredNames.forEach(input => {
                    if (input.value.trim()) {
                        fatherTransferred.push({
                            name: input.value.trim(),
                            parentName: fatherName,
                            share: 0
                        });
                    }
                });
            }
            
            // 收集母亲转继承人信息
            let motherTransferred = [];
            if (motherStatus === 'deceased_after') {
                const transferredNames = document.querySelectorAll('#motherTransferredList .transferred-name');
                transferredNames.forEach(input => {
                    if (input.value.trim()) {
                        motherTransferred.push({
                            name: input.value.trim(),
                            parentName: motherName,
                            share: 0
                        });
                    }
                });
            }
            
            // 收集第二顺序继承人信息
            const hasSiblings = document.getElementById('hasSiblings').checked;
            let siblings = [];
            
            if (hasSiblings) {
                const siblingItems = document.querySelectorAll('#siblingsList .sibling-item');
                siblingItems.forEach((item, index) => {
                    const nameInput = item.querySelector('.sibling-name');
                    const name = nameInput.value.trim() || `兄弟姐妹${index + 1}`;
                    siblings.push({
                        name: name,
                        share: 0
                    });
                });
            }
            
            const hasPaternalGrandfather = document.getElementById('hasPaternalGrandfather').checked;
            const hasPaternalGrandmother = document.getElementById('hasPaternalGrandmother').checked;
            const hasMaternalGrandfather = document.getElementById('hasMaternalGrandfather').checked;
            const hasMaternalGrandmother = document.getElementById('hasMaternalGrandmother').checked;
            
            // 收集遗产信息
            const isCommunityProperty = document.querySelector('input[name="isCommunityProperty"]:checked').value === 'yes';
            const communityPropertyAmount = isCommunityProperty ? 
                parseFloat(document.getElementById('communityPropertyAmount').value) || 0 : 0;
            const estateAmountInput = document.getElementById('estateAmount').value;
            const estateAmount = estateAmountInput ? parseFloat(estateAmountInput) : null;
            
            // 收集特殊情况
            const specialCases = {
                mainSupport: document.getElementById('specialCase1').checked,
                hardship: document.getElementById('specialCase2').checked,
                noSupport: document.getElementById('specialCase3').checked,
                fetus: document.getElementById('specialCase4').checked,
                sonInLawDaughterInLaw: document.getElementById('specialCase5').checked,
                outsidePerson: document.getElementById('specialCase6').checked
            };
            
            // 计算逻辑
            let heirs = [];
            let totalShares = 0;
            let notes = [];
            let isSecondOrder = false;
            
            // 处理遗嘱情况
            if (hasWill === 'yes') {
                notes.push("被继承人留有有效遗嘱，遗嘱继承优先于法定继承。以下计算仅供参考。");
            }
            
            // 处理配偶情况
            let spouseSeparateShare = 0;
            let spouseAlive = spouseStatus === 'alive';
            let spouseDivorced = spouseStatus === 'divorced';
            
            if (spouseDivorced) {
                notes.push("配偶已离婚，无权继承遗产。");
            }
            
            // 处理夫妻共同财产
            let actualEstateAmount = estateAmount;
            if (isCommunityProperty && communityPropertyAmount > 0 && spouseAlive && !spouseDivorced) {
                const spouseHalf = communityPropertyAmount / 2;
                spouseSeparateShare = spouseHalf;
                
                // 如果用户输入的遗产总额包含了夫妻共同财产，需要调整
                if (estateAmount !== null) {
                    // 假设用户输入的是遗产总额（即共同财产的一半加上其他个人财产）
                    // 所以实际可用于分配的遗产就是用户输入的estateAmount
                    actualEstateAmount = estateAmount;
                    notes.push(`夫妻共同财产总额：¥${communityPropertyAmount.toLocaleString('zh-CN')}，其中¥${spouseHalf.toLocaleString('zh-CN')}归配偶所有。`);
                }
            }
            
            // 确定第一顺序继承人（配偶、子女、父母）
            const firstOrderHeirs = [];
            
            // 配偶（如果在世）
            if (spouseAlive && !spouseDivorced) {
                firstOrderHeirs.push({ 
                    type: '配偶', 
                    name: spouseName, 
                    share: 1,
                    sources: ['配偶身份继承']
                });
                totalShares += 1;
            }
            // 配偶转继承
            else if (spouseStatus === 'deceased_after' && spouseTransferred.length > 0) {
                const sharePerTransferred = 1 / spouseTransferred.length;
                spouseTransferred.forEach(transferred => {
                    firstOrderHeirs.push({ 
                        type: '配偶转继承人', 
                        name: transferred.name, 
                        share: sharePerTransferred,
                        sources: [`转继承${spouseName}份额`]
                    });
                    totalShares += sharePerTransferred;
                });
                notes.push("配偶在被继承人之后去世，其应继承份额由转继承人继承。");
            }
            
            // 子女（在世子女）
            children.forEach(child => {
                firstOrderHeirs.push({ 
                    type: '子女', 
                    name: child.name, 
                    share: 1,
                    sources: ['子女身份继承']
                });
                totalShares += 1;
            });
            
            // 子女转继承
            if (childrenTransferred.length > 0) {
                // 按父/母分组计算
                const transferredByParent = {};
                childrenTransferred.forEach(transferred => {
                    if (!transferredByParent[transferred.parentName]) {
                        transferredByParent[transferred.parentName] = [];
                    }
                    transferredByParent[transferred.parentName].push({
                        name: transferred.name,
                        parentName: transferred.parentName
                    });
                });
                
                // 为每个父/母的转继承人添加继承份额
                for (const parentName in transferredByParent) {
                    const parentTransferred = transferredByParent[parentName];
                    const sharePerTransferred = 1 / parentTransferred.length;
                    
                    parentTransferred.forEach(transferred => {
                        firstOrderHeirs.push({ 
                            type: '子女转继承人', 
                            name: transferred.name, 
                            share: sharePerTransferred,
                            sources: [`转继承${parentName}份额`]
                        });
                        totalShares += sharePerTransferred;
                    });
                }
                
                notes.push("有子女在被继承人之后去世，其应继承份额由转继承人继承。");
            }
            
            // 代位继承人（继承先于被继承人去世子女的份额）
            const successorCount = successors.length;
            if (successorCount > 0) {
                // 按父/母分组计算
                const successorsByParent = {};
                successors.forEach(successor => {
                    if (!successorsByParent[successor.parentName]) {
                        successorsByParent[successor.parentName] = [];
                    }
                    successorsByParent[successor.parentName].push(successor.name);
                });
                
                // 为每个父/母的代位继承人添加继承份额
                for (const parentName in successorsByParent) {
                    const parentSuccessors = successorsByParent[parentName];
                    const sharePerSuccessor = 1 / parentSuccessors.length;
                    
                    parentSuccessors.forEach(successorName => {
                        firstOrderHeirs.push({ 
                            type: '代位继承人', 
                            name: successorName, 
                            share: sharePerSuccessor,
                            sources: [`代位继承${parentName}`]
                        });
                        totalShares += sharePerSuccessor;
                    });
                }
                
                if (successorCount > 0) {
                    notes.push(`有${Object.keys(successorsByParent).length}名子女先于被继承人去世，由其${successorCount}名代位继承人继承相应份额。`);
                }
            }
            
            // 父母（如果在世）
            if (fatherStatus === 'alive') {
                firstOrderHeirs.push({ 
                    type: '父母', 
                    name: fatherName, 
                    share: 1,
                    sources: ['父亲身份继承']
                });
                totalShares += 1;
            }
            // 父亲转继承
            else if (fatherStatus === 'deceased_after' && fatherTransferred.length > 0) {
                const sharePerTransferred = 1 / fatherTransferred.length;
                fatherTransferred.forEach(transferred => {
                    firstOrderHeirs.push({ 
                        type: '父亲转继承人', 
                        name: transferred.name, 
                        share: sharePerTransferred,
                        sources: [`转继承${fatherName}份额`]
                    });
                    totalShares += sharePerTransferred;
                });
                notes.push("父亲在被继承人之后去世，其应继承份额由转继承人继承。");
            }
            
            if (motherStatus === 'alive') {
                firstOrderHeirs.push({ 
                    type: '父母', 
                    name: motherName, 
                    share: 1,
                    sources: ['母亲身份继承']
                });
                totalShares += 1;
            }
            // 母亲转继承
            else if (motherStatus === 'deceased_after' && motherTransferred.length > 0) {
                const sharePerTransferred = 1 / motherTransferred.length;
                motherTransferred.forEach(transferred => {
                    firstOrderHeirs.push({ 
                        type: '母亲转继承人', 
                        name: transferred.name, 
                        share: sharePerTransferred,
                        sources: [`转继承${motherName}份额`]
                    });
                    totalShares += sharePerTransferred;
                });
                notes.push("母亲在被继承人之后去世，其应继承份额由转继承人继承。");
            }
            
            // 检查是否有第一顺序继承人
            if (totalShares === 0) {
                // 没有第一顺序继承人，启用第二顺序继承人
                isSecondOrder = true;
                notes.push("没有第一顺序继承人，由第二顺序继承人继承。");
                
                // 第二顺序继承人：兄弟姐妹、祖父母、外祖父母
                const secondOrderHeirs = [];
                let secondOrderTotalShares = 0;
                
                // 兄弟姐妹
                siblings.forEach(sibling => {
                    secondOrderHeirs.push({ 
                        type: '兄弟姐妹', 
                        name: sibling.name, 
                        share: 1,
                        sources: ['兄弟姐妹身份继承']
                    });
                    secondOrderTotalShares += 1;
                });
                
                // 祖父母（父亲的父母）
                if (hasPaternalGrandfather) {
                    secondOrderHeirs.push({ 
                        type: '祖父母', 
                        name: '祖父', 
                        share: 1,
                        sources: ['祖父身份继承']
                    });
                    secondOrderTotalShares += 1;
                }
                
                if (hasPaternalGrandmother) {
                    secondOrderHeirs.push({ 
                        type: '祖父母', 
                        name: '祖母', 
                        share: 1,
                        sources: ['祖母身份继承']
                    });
                    secondOrderTotalShares += 1;
                }
                
                // 外祖父母（母亲的父母）
                if (hasMaternalGrandfather) {
                    secondOrderHeirs.push({ 
                        type: '外祖父母', 
                        name: '外祖父', 
                        share: 1,
                        sources: ['外祖父身份继承']
                    });
                    secondOrderTotalShares += 1;
                }
                
                if (hasMaternalGrandmother) {
                    secondOrderHeirs.push({ 
                        type: '外祖父母', 
                        name: '外祖母', 
                        share: 1,
                        sources: ['外祖母身份继承']
                    });
                    secondOrderTotalShares += 1;
                }
                
                if (secondOrderTotalShares === 0) {
                    notes.push("没有第二顺序继承人，遗产可能归国家或集体所有制组织所有。");
                } else {
                    heirs = secondOrderHeirs;
                    totalShares = secondOrderTotalShares;
                }
            } else {
                heirs = firstOrderHeirs;
            }
            
            // 处理特殊情况
            if (specialCases.mainSupport) {
                notes.push("有继承人对被继承人尽了主要扶养义务，可以多分遗产。");
            }
            
            if (specialCases.hardship) {
                notes.push("有继承人生活有特殊困难且缺乏劳动能力，分配遗产时应予以照顾。");
            }
            
            if (specialCases.noSupport) {
                notes.push("有扶养能力和条件的继承人，未尽扶养义务，应当不分或者少分。");
            }
            
            if (specialCases.fetus) {
                notes.push("被继承人死亡时留有胎儿，应为胎儿保留继承份额。");
                heirs.push({ 
                    type: '胎儿', 
                    name: '胎儿', 
                    share: 1,
                    sources: ['胎儿保留份额']
                });
                totalShares += 1;
            }
            
            if (specialCases.sonInLawDaughterInLaw) {
                notes.push("丧偶儿媳对公婆、丧偶女婿对岳父母，尽了主要赡养义务的，可作为第一顺序继承人。此种情况由法院个案分析。");
            }
            
            if (specialCases.outsidePerson) {
                notes.push("对继承人以外的依靠被继承人扶养的人，或者继承人以外的对被继承人扶养较多的人，可以分给适当的遗产。此种情况由法院个案分析。");
            }
            
            // 合并相同姓名的继承人份额
            const mergedHeirs = {};
            heirs.forEach(heir => {
                const key = heir.name;
                if (!mergedHeirs[key]) {
                    mergedHeirs[key] = {
                        name: heir.name,
                        totalShare: 0,
                        sources: [],
                        types: [],
                        details: []
                    };
                }
                
                mergedHeirs[key].totalShare += heir.share;
                mergedHeirs[key].types.push(heir.type);
                mergedHeirs[key].sources = [...new Set([...mergedHeirs[key].sources, ...heir.sources])];
                mergedHeirs[key].details.push({
                    type: heir.type,
                    share: heir.share,
                    sources: heir.sources
                });
            });
            
            // 转换为数组并计算百分比和金额
            const resultDetails = Object.values(mergedHeirs).map(heir => {
                const percentage = totalShares > 0 ? (heir.totalShare / totalShares * 100).toFixed(2) : 0;
                let amount = null;
                
                if (actualEstateAmount !== null) {
                    // 计算每个继承人的实际金额
                    amount = (actualEstateAmount * (percentage / 100)).toFixed(2);
                }
                
                return {
                    name: heir.name,
                    totalShare: heir.totalShare,
                    percentage: parseFloat(percentage),
                    amount: amount,
                    types: heir.types,
                    sources: heir.sources,
                    details: heir.details
                };
            });
            
            // 保存结果
            inheritanceResult = {
                heirs: resultDetails,
                totalShares: totalShares,
                estateAmount: actualEstateAmount,
                spouseSeparateShare: spouseSeparateShare,
                isCommunityProperty: isCommunityProperty,
                communityPropertyAmount: communityPropertyAmount,
                notes: notes,
                hasWill: hasWill,
                spouseAlive: spouseAlive,
                spouseDivorced: spouseDivorced,
                hasChildren: hasChildren,
                isSecondOrder: isSecondOrder,
                spouseTransferred: spouseTransferred.length > 0,
                childrenTransferred: childrenTransferred.length > 0,
                fatherTransferred: fatherTransferred.length > 0,
                motherTransferred: motherTransferred.length > 0
            };
            
            // 显示结果
            displayResult();
            nextStep();
        }

        // 显示计算结果
        function displayResult() {
            const resultDiv = document.getElementById('calculationResult');
            let html = '';
            
            // 遗嘱情况提示
            if (inheritanceResult.hasWill === 'yes') {
                html += `
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-700">
                                    <strong>注意：</strong>被继承人留有遗嘱，遗嘱继承优先于法定继承。以下计算结果仅供参考，实际继承应以遗嘱为准。
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 夫妻共同财产提示
            if (inheritanceResult.isCommunityProperty && inheritanceResult.communityPropertyAmount > 0 && inheritanceResult.spouseAlive && !inheritanceResult.spouseDivorced) {
                html += `
                    <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-6">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-green-700">
                                    <strong>夫妻共同财产分割：</strong>¥${inheritanceResult.communityPropertyAmount.toLocaleString('zh-CN')}夫妻共同财产中，<strong>¥${inheritanceResult.spouseSeparateShare.toLocaleString('zh-CN')}归配偶所有</strong>，剩余部分作为遗产分配。
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 配偶无权继承提示
            if (inheritanceResult.spouseDivorced) {
                html += `
                    <div class="bg-gray-100 border-l-4 border-gray-400 p-4 mb-6">
                        <p class="text-sm text-gray-700">
                            <strong>说明：</strong>配偶已离婚，无权继承遗产。
                        </p>
                    </div>
                `;
            }
            
            // 转继承提示
            if (inheritanceResult.spouseTransferred || inheritanceResult.childrenTransferred || inheritanceResult.fatherTransferred || inheritanceResult.motherTransferred) {
                html += `
                    <div class="bg-purple-50 border-l-4 border-purple-400 p-4 mb-6">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-purple-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-purple-700">
                                    <strong>转继承说明：</strong>部分继承人涉及转继承情况，其应继承的份额已转由转继承人继承。
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 第二顺序继承人提示
            if (inheritanceResult.isSecondOrder) {
                html += `
                    <div class="bg-orange-50 border-l-4 border-orange-400 p-4 mb-6">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-orange-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-orange-700">
                                    <strong>说明：</strong>因没有第一顺序继承人（配偶、子女、父母），遗产由第二顺序继承人（兄弟姐妹、祖父母、外祖父母）继承。
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (inheritanceResult.heirs.length === 0) {
                html += `
                    <div class="text-center py-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h3 class="text-xl font-bold text-gray-700 mb-2">没有找到法定继承人</h3>
                        <p class="text-gray-600">根据您提供的信息，未找到法定继承人。遗产可能归国家或集体所有制组织所有。</p>
                    </div>
                `;
            } else {
                // 显示继承份额图
                html += `
                    <div>
                        <h3 class="text-lg font-bold mb-4">继承份额分配图</h3>
                        <div class="mb-8">
                            <canvas id="inheritanceChart" height="100"></canvas>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-bold mb-4">详细分配结果</h3>
                `;
                
                // 显示合并后的继承人
                html += `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">继承人</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">继承份额</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">百分比</th>
                                    ${inheritanceResult.estateAmount ? '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">继承金额</th>' : ''}
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">份额来源</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                inheritanceResult.heirs.forEach(heir => {
                    const sourcesText = heir.sources.join('、');
                    const hasMultipleSources = heir.details.length > 1;
                    
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${heir.name}</div>
                                ${hasMultipleSources ? '<div class="text-xs text-gray-500">（合并多个继承份额）</div>' : ''}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${heir.totalShare}份</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${heir.percentage.toFixed(2)}%</td>
                            ${inheritanceResult.estateAmount ? 
                                `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">¥${parseFloat(heir.amount).toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>` : 
                                ''
                            }
                            <td class="px-6 py-4 text-sm text-gray-500">
                                <div class="space-y-1">
                                    ${heir.sources.map(source => `<div>${source}</div>`).join('')}
                                </div>
                                ${hasMultipleSources ? 
                                    `<div class="mt-2 text-xs text-gray-400">
                                        <details>
                                            <summary class="cursor-pointer hover:text-gray-600">查看详细构成</summary>
                                            <ul class="mt-1 pl-4 list-disc">
                                                ${heir.details.map(detail => 
                                                    `<li>${detail.type}：${detail.share}份（${detail.sources.join('、')}）</li>`
                                                ).join('')}
                                            </ul>
                                        </details>
                                    </div>` : ''
                                }
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                // 显示配偶特殊份额（夫妻共同财产的一半）
                if (inheritanceResult.spouseSeparateShare > 0 && inheritanceResult.spouseAlive && !inheritanceResult.spouseDivorced) {
                    html += `
                        <div class="bg-blue-50 p-4 rounded-lg mb-6">
                            <h4 class="font-medium text-blue-800 mb-2">配偶特殊财产</h4>
                            <p class="text-sm text-blue-700">
                                除上述继承份额外，配偶另享有夫妻共同财产的一半：<strong>¥${inheritanceResult.spouseSeparateShare.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                            </p>
                        </div>
                    `;
                }
                
                // 显示备注
                if (inheritanceResult.notes.length > 0) {
                    html += `
                        <div>
                            <h3 class="text-lg font-bold mb-4">计算说明</h3>
                            <ul class="list-disc pl-5 space-y-2">
                    `;
                    
                    inheritanceResult.notes.forEach(note => {
                        html += `<li class="text-gray-700 text-sm">${note}</li>`;
                    });
                    
                    html += `
                            </ul>
                        </div>
                    `;
                }
            }
            
            resultDiv.innerHTML = html;
            
            // 如果存在继承人，绘制图表
            if (inheritanceResult.heirs.length > 0) {
                setTimeout(() => {
                    drawChart();
                }, 100);
            }
        }

        // 绘制饼图
        function drawChart() {
            const ctx = document.getElementById('inheritanceChart').getContext('2d');
            const labels = inheritanceResult.heirs.map(heir => heir.name);
            const data = inheritanceResult.heirs.map(heir => heir.percentage);
            const backgroundColors = [
                '#3B82F6', '#10B981', '#EF4444', '#F59E0B', '#8B5CF6', 
                '#EC4899', '#14B8A6', '#F97316', '#6366F1', '#84CC16'
            ];
            
            // 注册插件
            Chart.register(ChartDataLabels);
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 11
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const heir = inheritanceResult.heirs[context.dataIndex];
                                    const amount = inheritanceResult.estateAmount && heir.amount ? 
                                        ` (¥${parseFloat(heir.amount).toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2})})` : '';
                                    return `${label}: ${value.toFixed(2)}%${amount}`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            formatter: function(value, context) {
                                const heir = inheritanceResult.heirs[context.dataIndex];
                                let text = heir.name.substring(0, 4) + (heir.name.length > 4 ? '...' : '') + '\n' + value.toFixed(1) + '%';
                                if (inheritanceResult.estateAmount && heir.amount) {
                                    const amount = parseFloat(heir.amount);
                                    // 简化金额显示
                                    if (amount >= 1000000) {
                                        text += '\n¥' + (amount / 1000000).toFixed(1) + '百万';
                                    } else if (amount >= 10000) {
                                        text += '\n¥' + (amount / 10000).toFixed(1) + '万';
                                    } else if (amount >= 1000) {
                                        text += '\n¥' + (amount / 1000).toFixed(1) + '千';
                                    } else {
                                        text += '\n¥' + amount.toFixed(0);
                                    }
                                }
                                return text;
                            },
                            padding: 4,
                            textAlign: 'center',
                            display: function(context) {
                                // 只在饼块足够大时显示标签
                                return context.dataset.data[context.dataIndex] > 5;
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // 复制微信号
        function copyWechatId() {
            const wechatId = document.getElementById('wechatId').textContent;
            navigator.clipboard.writeText(wechatId).then(() => {
                alert('微信号已复制到剪贴板！请打开微信添加好友。');
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制微信号：' + wechatId);
            });
        }

        // 保存结果
        function saveResult() {
            alert('免费版暂不支持保存功能。添加上方微信可获取完整PDF报告。');
        }

        // 分享结果
        function shareResult() {
            if (navigator.share) {
                navigator.share({
                    title: '遗产份额计算结果',
                    text: '我使用遗产份额计算器得到了继承分配结果，快来试试吧！',
                    url: window.location.href
                }).catch(err => {
                    console.log('分享失败:', err);
                    alert('分享失败，请手动分享链接。');
                });
            } else {
                alert('请手动复制链接分享给家人：' + window.location.href);
            }
        }

        // 重新开始计算
        function restartCalculator() {
            // 重置所有表单
            document.querySelector('input[name="hasWill"][value="no"]').checked = true;
            document.querySelectorAll('input[name="spouse"]')[1].checked = true; // deceased_before
            document.getElementById('spouseName').value = '';
            document.getElementById('hasChildrenNo').checked = true;
            document.getElementById('hasChildrenYes').checked = false;
            document.querySelectorAll('input[name="father"]')[1].checked = true; // deceased_before
            document.querySelectorAll('input[name="mother"]')[1].checked = true; // deceased_before
            document.getElementById('hasSiblings').checked = false;
            document.getElementById('hasPaternalGrandfather').checked = false;
            document.getElementById('hasPaternalGrandmother').checked = false;
            document.getElementById('hasMaternalGrandfather').checked = false;
            document.getElementById('hasMaternalGrandmother').checked = false;
            document.querySelector('input[name="isCommunityProperty"][value="no"]').checked = true;
            
            document.getElementById('fatherName').value = '';
            document.getElementById('motherName').value = '';
            document.getElementById('communityPropertyAmount').value = '';
            document.getElementById('estateAmount').value = '';
            
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                if (cb.id.startsWith('specialCase')) cb.checked = false;
            });
            
            // 清除子女
            document.getElementById('childrenList').innerHTML = '';
            document.getElementById('childrenContainer').classList.add('hidden');
            
            // 清除兄弟姐妹
            document.getElementById('siblingsList').innerHTML = '';
            document.getElementById('siblingsContainer').classList.add('hidden');
            
            // 清除转继承人信息
            document.getElementById('spouseTransferredList').innerHTML = '';
            document.getElementById('spouseTransferredContainer').classList.add('hidden');
            document.getElementById('fatherTransferredList').innerHTML = '';
            document.getElementById('fatherTransferredContainer').classList.add('hidden');
            document.getElementById('motherTransferredList').innerHTML = '';
            document.getElementById('motherTransferredContainer').classList.add('hidden');
            
            // 回到第一步
            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep = 1;
            document.getElementById(`step${currentStep}`).classList.add('active');
            updateProgress();
        }
    </script>
</body>
</html>