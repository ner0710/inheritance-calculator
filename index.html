<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—äº§ç»§æ‰¿è®¡ç®—å™¨</title>
    <meta name="description" content="åŸºäºã€Šæ°‘æ³•å…¸ã€‹çš„æ™ºèƒ½é—äº§ç»§æ‰¿è®¡ç®—å™¨ï¼Œå‡†ç¡®å¤„ç†å¤«å¦»å…±åŒè´¢äº§åˆ†å‰²ã€ä»£ä½ç»§æ‰¿ã€è½¬ç»§æ‰¿ç­‰å¤æ‚æƒ…å†µ">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
        .step { display: none; }
        .step.active { display: block; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* è¿›åº¦æ¡ */
        .progress-container {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 2rem 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #3b82f6, #1d4ed8);
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        
        /* é‡‘é¢è¾“å…¥æ ·å¼ */
        .money-input-container {
            position: relative;
        }
        
        .money-input-container span {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e40af;
        }
        
        .money-input-container input {
            padding-left: 40px;
        }
        
        /* é€‰ä¸­å¡ç‰‡æ ·å¼ */
        .property-card {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .property-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .property-card .card-content {
            position: relative;
            z-index: 1;
        }
        
        .property-card .selection-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            position: absolute;
            top: -12px;
            right: -12px;
            background-color: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.5);
        }
        
        /* ç¡®ä¿å¯¹å‹¾æ˜¯ç™½è‰²çš„ */
        .property-card .selection-indicator svg {
            width: 16px;
            height: 16px;
            color: white !important;
            fill: white !important;
            stroke: white !important;
        }
        
        /* ä½œè€…ä¿¡æ¯æ ·å¼ */
        .author-info {
            font-size: 12px;
            color: #6b7280;
            text-align: right;
            margin-top: -15px;
            margin-bottom: 10px;
            padding-right: 5px;
        }
        
        .author-info strong {
            color: #1e40af;
        }
        
        /* å¯æ’åºé¡¹ç›®æ ·å¼ */
        .sortable-item {
            user-select: none;
            cursor: move;
            transition: all 0.3s ease;
        }
        
        .sortable-item:hover {
            background-color: #f3f4f6;
        }
        
        .sortable-item.dragging {
            opacity: 0.5;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .sortable-item.over {
            background-color: #e5e7eb;
        }
        
        /* å¾®ä¿¡äºŒç»´ç æ ·å¼ */
        .wechat-qr-container {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .wechat-qr-title {
            color: #1e40af;
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 20px;
        }
        
        .wechat-qr-code {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .wechat-id {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-top: 15px;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        
        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            position: relative;
            height: 320px;
            margin: 2rem 0;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .chart-bar {
            position: absolute;
            bottom: 0;
            transition: all 0.8s ease;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .chart-bar:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .chart-label {
            position: absolute;
            bottom: -30px;
            width: 100%;
            text-align: center;
            font-size: 13px;
            color: #4b5563;
            font-weight: 500;
            word-break: break-all;
        }
        
        .chart-value {
            position: absolute;
            top: -30px;
            width: 100%;
            text-align: center;
            font-size: 13px;
            font-weight: 700;
            color: #1e40af;
        }
        
        /* æç¤ºæ¡†å†…è™šåŒ–æ–‡å­— */
        .input-placeholder-hint {
            font-size: 12px;
            color: #9ca3af;
            font-style: italic;
            margin-top: 6px;
            padding-left: 6px;
        }
        
        /* ç‰¹æ®Šæç¤ºæ ·å¼ */
        .special-hint {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #fbbf24;
            border-radius: 10px;
            padding: 16px;
            margin: 16px 0;
            box-shadow: 0 4px 6px -1px rgba(251, 191, 36, 0.1);
        }
        
        .special-hint-title {
            color: #92400e;
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .special-hint-title::before {
            content: "ğŸ’¡";
            font-size: 16px;
        }
        
        .special-hint-content {
            color: #92400e;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .important-note {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 1px solid #f87171;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 12px 0;
            font-size: 13px;
            color: #dc2626;
            font-weight: 500;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            font-weight: 600;
            padding: 12px 32px;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #4b5563;
            font-weight: 600;
            padding: 12px 32px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-weight: 600;
            padding: 12px 32px;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }
        
        /* å¡ç‰‡æ ·å¼ */
        .info-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }
        
        .info-card-title {
            color: #1e40af;
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-card-title::before {
            content: "ğŸ“‹";
            font-size: 20px;
        }
        
        /* æ ‡ç­¾æ ·å¼ */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-alive {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
        }
        
        .status-predeceased {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
        }
        
        .status-postdeceased {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #dc2626;
        }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        .form-input {
            width: 100%;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .chart-container {
                height: 280px;
                padding: 15px;
            }
            
            .chart-label {
                font-size: 11px;
                bottom: -35px;
            }
            
            .chart-value {
                font-size: 11px;
                top: -35px;
            }
            
            .wechat-qr-code {
                width: 160px;
                height: 160px;
            }
            
            .wechat-qr-title {
                font-size: 18px;
            }
            
            .btn-primary, .btn-secondary, .btn-success {
                padding: 10px 24px;
                font-size: 14px;
            }
        }
        
        /* ä»½é¢æ¥æºæ ·å¼ */
        .share-source {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.5;
        }
        
        .share-source-item {
            margin-bottom: 4px;
            padding-left: 12px;
            position: relative;
        }
        
        .share-source-item::before {
            content: "â†’";
            position: absolute;
            left: 0;
            color: #9ca3af;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-gray-100 text-gray-800 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-lg py-4 sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-gradient-to-br from-blue-600 to-blue-800 text-white p-3 rounded-lg mr-3 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-blue-700">é—äº§ç»§æ‰¿è®¡ç®—å™¨</h1>
                        <p class="text-xs text-blue-600 font-medium">åŸºäºã€Šæ°‘æ³•å…¸ã€‹Â·æ™ºèƒ½æ³•å¾‹è®¡ç®—å·¥å…·</p>
                    </div>
                </div>
            </div>
            <div class="author-info">
                <strong>é»„å† é›„å¾‹å¸ˆå›¢é˜Ÿ</strong>å‡ºå“ | å¯æ·»åŠ å¾®ä¿¡å·ï¼šner_0710è¯¦è¯¢
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒº -->
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
        <div class="info-card mb-8">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-lg font-bold text-blue-800">è®¡ç®—è¿›åº¦</h2>
                    <p class="text-sm text-blue-600">è·ŸéšæŒ‡å¼•å®Œæˆæ‰€æœ‰æ­¥éª¤</p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-blue-700">ç¬¬ <span id="current-step">1</span> æ­¥ / 7</div>
                    <div class="text-sm text-blue-600">è¯·æŒ‰é¡ºåºå¡«å†™ä¿¡æ¯</div>
                </div>
            </div>
            <div class="progress-container">
                <div id="progress-bar" class="progress-bar" style="width: 14%"></div>
            </div>
        </div>

        <!-- è®¡ç®—å™¨è¡¨å• -->
        <div class="info-card mb-8">
            <!-- æ­¥éª¤1: è¢«ç»§æ‰¿äººä¿¡æ¯ -->
            <div id="step1" class="step active">
                <h2 class="text-2xl font-bold mb-2 text-blue-800">ç¬¬ä¸€æ­¥ï¼šè¢«ç»§æ‰¿äººä¿¡æ¯</h2>
                <div class="author-info">é»„å† é›„å¾‹å¸ˆå›¢é˜Ÿå‡ºå“ | å¯æ·»åŠ å¾®ä¿¡å·ï¼šner_0710è¯¦è¯¢</div>
                <p class="text-gray-600 mb-8 text-lg">è¯·è¾“å…¥è¢«ç»§æ‰¿äººçš„åŸºæœ¬ä¿¡æ¯</p>
                
                <div class="space-y-8">
                    <div>
                        <label class="block text-lg font-medium mb-3 text-blue-700">è¢«ç»§æ‰¿äººå§“å</label>
                        <input type="text" id="deceased-name" class="form-input text-lg" 
                               placeholder="è¯·è¾“å…¥è¢«ç»§æ‰¿äººå§“å" required>
                        <p class="text-gray-500 text-sm mt-2 pl-2">è¯·å¡«å†™è¢«ç»§æ‰¿äººçš„çœŸå®å§“å</p>
                    </div>
                </div>
                
                <div class="flex justify-end mt-12">
                    <button id="step1-next" class="btn-primary">
                        ä¸‹ä¸€æ­¥
                    </button>
                </div>
            </div>

            <!-- æ­¥éª¤2: è´¢äº§æ€§è´¨ç¡®è®¤ -->
            <div id="step2" class="step">
                <h2 class="text-2xl font-bold mb-2 text-blue-800">ç¬¬äºŒæ­¥ï¼šè´¢äº§æ€§è´¨ç¡®è®¤</h2>
                <div class="author-info">é»„å† é›„å¾‹å¸ˆå›¢é˜Ÿå‡ºå“ | å¯æ·»åŠ å¾®ä¿¡å·ï¼šner_0710è¯¦è¯¢</div>
                <p class="text-gray-600 mb-8 text-lg">è¯·ç¡®è®¤è¢«ç»§æ‰¿äººçš„è´¢äº§æ€§è´¨</p>
                
                <!-- ä¸“ä¸šå’¨è¯¢æç¤º -->
                <div class="special-hint mb-8">
                    <div class="special-hint-title">ä¸“ä¸šå»ºè®®</div>
                    <div class="special-hint-content">
                        ä¸æ¸…æ¥šè´¢äº§æ€§è´¨å¦‚ä½•ç•Œå®šï¼Ÿå»ºè®®å’¨è¯¢ä¸“ä¸šå¾‹å¸ˆã€‚æ·»åŠ å¾®ä¿¡å· <span class="font-bold">ner_0710</span> è·å–ä¸“ä¸šå’¨è¯¢ã€‚
                    </div>
                </div>
                
                <div class="space-y-8">
                    <!-- è´¢äº§æ€§è´¨é€‰æ‹© -->
                    <div>
                        <label class="block text-lg font-medium mb-6 text-blue-700">è¢«ç»§æ‰¿äººçš„é—äº§æ˜¯å¦åŒ…å«å¤«å¦»å…±åŒè´¢äº§ï¼Ÿ</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="property-card">
                                <label class="block h-full cursor-pointer">
                                    <input type="radio" name="property-type" value="community" class="sr-only property-type-radio" checked>
                                    <div class="card-content h-full border-2 border-blue-500 rounded-xl p-6 hover:bg-blue-50 transition duration-300 bg-white">
                                        <div class="selection-indicator">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </div>
                                        <div class="flex items-center mb-4">
                                            <div class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center mr-4">
                                                <span class="text-2xl">ğŸ </span>
                                            </div>
                                            <h3 class="font-bold text-xl text-blue-700">åŒ…å«å¤«å¦»å…±åŒè´¢äº§</h3>
                                        </div>
                                        <p class="text-gray-600">å©šåè´­ä¹°çš„æˆ¿äº§ã€è½¦è¾†ã€å­˜æ¬¾ç­‰å±äºå¤«å¦»å…±åŒè´¢äº§</p>
                                        <div class="mt-4 text-sm text-blue-600 font-medium">æ¨èé€‰æ‹©æ­¤é¡¹</div>
                                    </div>
                                </label>
                            </div>
                            
                            <div class="property-card">
                                <label class="block h-full cursor-pointer">
                                    <input type="radio" name="property-type" value="personal" class="sr-only property-type-radio">
                                    <div class="card-content h-full border-2 border-gray-300 rounded-xl p-6 hover:bg-gray-50 transition duration-300 bg-white">
                                        <div class="flex items-center mb-4">
                                            <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center mr-4">
                                                <span class="text-2xl">ğŸ‘¤</span>
                                            </div>
                                            <h3 class="font-bold text-xl text-gray-700">å…¨éƒ¨ä¸ºè¢«ç»§æ‰¿äººä¸ªäººè´¢äº§</h3>
                                        </div>
                                        <p class="text-gray-600">å©šå‰ä¸ªäººè´¢äº§æˆ–æ˜ç¡®å½’ä¸ªäººæ‰€æœ‰çš„è´¢äº§</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-12">
                    <button id="step2-prev" class="btn-secondary">
                        ä¸Šä¸€æ­¥
                    </button>
                    <button id="step2-next" class="btn-primary">
                        ä¸‹ä¸€æ­¥
                    </button>
                </div>
            </div>

            <!-- æ­¥éª¤3: è´¢äº§é‡‘é¢è¾“å…¥ï¼ˆç²¾ç®€ç‰ˆï¼‰ -->
            <div id="step3" class="step">
                <h2 class="text-2xl font-bold mb-2 text-blue-800">ç¬¬ä¸‰æ­¥ï¼šè´¢äº§é‡‘é¢è¾“å…¥</h2>
                <div class="author-info">é»„å† é›„å¾‹å¸ˆå›¢é˜Ÿå‡ºå“ | å¯æ·»åŠ å¾®ä¿¡å·ï¼šner_0710è¯¦è¯¢</div>
                <p class="text-gray-600 mb-8 text-lg">è¯·æ ¹æ®è´¢äº§æ€§è´¨å¡«å†™ç›¸åº”çš„è´¢äº§é‡‘é¢</p>
                
                <div class="space-y-8">
                    <!-- åŒ…å«å¤«å¦»å…±åŒè´¢äº§çš„æƒ…å†µ -->
                    <div id="community-property-container">
                        <div class="space-y-8">
                            <!-- å¤«å¦»å…±åŒè´¢äº§æ€»é¢ -->
                            <div class="info-card bg-gradient-to-br from-blue-50 to-blue-100 border-blue-300">
                                <div class="info-card-title">å¤«å¦»å…±åŒè´¢äº§æ€»é¢</div>
                                <p class="text-blue-700 mb-6">è¯·è¾“å…¥è¢«ç»§æ‰¿äººä¸é…å¶çš„å…±åŒè´¢äº§æ€»é¢</p>
                                <div class="money-input-container">
                                    <span>Â¥</span>
                                    <input type="number" id="community-property-amount" min="0" placeholder="ä¾‹å¦‚ï¼š2,000,000" 
                                           class="form-input text-xl font-bold">
                                </div>
                                
                                <!-- é…å¶ä¸ªäººè´¢äº§ -->
                                <div class="mt-8 p-6 rounded-lg border border-blue-200 bg-white">
                                    <h4 class="font-bold text-blue-800 mb-4">é…å¶ä¸ªäººè´¢äº§</h4>
                                    <p class="text-blue-700 mb-4 text-sm">å¤«å¦»å…±åŒè´¢äº§çš„ä¸€åŠå½’é…å¶æ‰€æœ‰ï¼Œä¸å±äºé—äº§</p>
                                    <div class="bg-white p-4 rounded-lg border border-blue-300">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <div class="text-sm text-gray-500 font-medium">é…å¶ä¸ªäººè´¢äº§é‡‘é¢</div>
                                                <div id="spouse-personal-display" class="text-xl font-bold text-green-600">Â¥0</div>
                                            </div>
                                            <div class="text-3xl text-blue-400">ğŸ‘¤</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- è¢«ç»§æ‰¿äººä¸ªäººè´¢äº§æ€»é¢ -->
                            <div class="info-card bg-gradient-to-br from-gray-50 to-gray-100 border-gray-300">
                                <div class="info-card-title">è¢«ç»§æ‰¿äººä¸ªäººè´¢äº§æ€»é¢</div>
                                <p class="text-gray-700 mb-6">
                                    <strong>å¤«å¦»å…±åŒè´¢äº§å¤–çš„</strong>ä¸ªäººè´¢äº§ï¼Œå¦‚å©šå‰è´¢äº§ã€ä¸ªäººèµ ä¸æˆ–ç»§æ‰¿æ‰€å¾—ç­‰
                                </p>
                                <div class="money-input-container">
                                    <span>Â¥</span>
                                    <input type="number" id="personal-property-amount" min="0" placeholder="ä¾‹å¦‚ï¼š500,000" 
                                           class="form-input text-xl font-bold">
                                </div>
                            </div>
                            
                            <!-- é—äº§æ€»é¢è®¡ç®— -->
                            <div class="info-card bg-gradient-to-br from-green-50 to-green-100 border-green-300">
                                <div class="info-card-title">é—äº§æ€»é¢è®¡ç®—</div>
                                <div class="p-6 rounded-lg border border-green-300 bg-white">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <div class="text-sm font-medium text-green-700">é—äº§æ€»é¢ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰</div>
                                            <div class="text-xs text-green-600">(å…±åŒè´¢äº§ä¸€åŠ + ä¸ªäººè´¢äº§)</div>
                                        </div>
                                        <div id="estate-total-display" class="text-3xl font-bold text-green-700">Â¥0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å…¨éƒ¨ä¸ºä¸ªäººè´¢äº§çš„æƒ…å†µ -->
                    <div id="personal-property-container" class="hidden">
                        <div class="info-card bg-gradient-to-br from-gray-50 to-gray-100 border-gray-300">
                            <div class="info-card-title">é—äº§æ€»é¢</div>
                            <p class="text-gray-700 mb-6">
                                å…¨éƒ¨è´¢äº§å‡ä½œä¸ºé—äº§è¿›è¡Œåˆ†é…
                            </p>
                            <div class="money-input-container">
                                <span>Â¥</span>
                                <input type="number" id="personal-estate-amount" min="0" placeholder="ä¾‹å¦‚ï¼š1,000,000" 
                                       class="form-input text-xl font-bold">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-12">
                    <button id="step3-prev" class="btn-secondary">
                        ä¸Šä¸€æ­¥
                    </button>
                    <button id="step3-next" class="btn-primary">
                        ä¸‹ä¸€æ­¥
                    </button>
                </div>
            </div>

            <!-- æ­¥éª¤4: ä¸»è¦ç»§æ‰¿äººä¿¡æ¯ -->
            <div id="step4" class="step">
                <h2 class="text-2xl font-bold mb-2 text-blue-800">ç¬¬å››æ­¥ï¼šç»§æ‰¿äººä¿¡æ¯</h2>
                <div class="author-info">é»„å† é›„å¾‹å¸ˆå›¢é˜Ÿå‡ºå“ | å¯æ·»åŠ å¾®ä¿¡å·ï¼šner_0710è¯¦è¯¢</div>
                <p class="text-gray-600 mb-8 text-lg">è¯·å¡«å†™è¢«ç»§æ‰¿äººçš„é…å¶ã€çˆ¶æ¯ã€å­å¥³ä¿¡æ¯</p>
                
                <div class="space-y-8">
                    <!-- é…å¶ä¿¡æ¯ -->
                    <div class="info-card border-blue-200">
                        <h3 class="info-card-title">è¢«ç»§æ‰¿äººé…å¶ä¿¡æ¯</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <label class="block font-medium mb-3 text-blue-700">é…å¶å§“å</label>
                                <input type="text" id="spouse-name" class="form-input" 
                                       placeholder="è¯·è¾“å…¥é…å¶å§“å" value="">
                            </div>
                            <div>
                                <label class="block font-medium mb-3 text-blue-700">é…å¶çŠ¶æ€</label>
                                <select id="spouse-status" class="form-input">
                                    <option value="alive">åœ¨ä¸–</option>
                                    <option value="predeceased">å·²æ•…ï¼ˆåœ¨è¢«ç»§æ‰¿äººä¹‹å‰å»ä¸–ï¼‰</option>
                                    <option value="postdeceased">å·²æ•…ï¼ˆåœ¨è¢«ç»§æ‰¿äººä¹‹åå»ä¸–ï¼‰</option>
                                    <option value="none">æ— é…å¶</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- çˆ¶æ¯ä¿¡æ¯ -->
                    <div class="info-card border-green-200">
                        <h3 class="info-card-title">è¢«ç»§æ‰¿äººçˆ¶æ¯ä¿¡æ¯</h3>
                        <div class="space-y-6">
                            <!-- çˆ¶äº²ä¿¡æ¯ -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <label class="block font-medium mb-3 text-green-700">çˆ¶äº²å§“å</label>
                                    <input type="text" id="father-name" class="form-input" 
                                           placeholder="è¯·è¾“å…¥çˆ¶äº²å§“å" value="">
                                </div>
                                <div>
                                    <label class="block font-medium mb-3 text-green-700">çˆ¶äº²çŠ¶æ€</label>
                                    <select id="father-status" class="form-input">
                                        <option value="alive">åœ¨ä¸–</option>
                                        <option value="predeceased">å·²æ•…ï¼ˆåœ¨è¢«ç»§æ‰¿äººä¹‹å‰å»ä¸–ï¼‰</option>
                                        <option value="postdeceased">å·²æ•…ï¼ˆåœ¨è¢«ç»§æ‰¿äººä¹‹åå»ä¸–ï¼‰</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- æ¯äº²ä¿¡æ¯ -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div>
                                    <label class="block font-medium mb-3 text-green-700">æ¯äº²å§“å</label>
                                    <input type="text" id="mother-name" class="form-input" 
                                           placeholder="è¯·è¾“å…¥æ¯äº²å§“å" value="">
                                </div>
                                <div>
                                    <label class="block font-medium mb-3 text-green-700">æ¯äº²çŠ¶æ€</label>
                                    <select id="mother-status" class="form-input">
                                        <option value="alive">åœ¨ä¸–</option>
                                        <option value="predeceased">å·²æ•…ï¼ˆåœ¨è¢«ç»§æ‰¿äººä¹‹å‰å»ä¸–ï¼‰</option>
                                        <option value="postdeceased">å·²æ•…ï¼ˆåœ¨è¢«ç»§æ‰¿äººä¹‹åå»ä¸–ï¼‰</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å­å¥³ä¿¡æ¯ -->
                    <div class="info-card border-purple-200">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="info-card-title">è¢«ç»§æ‰¿äººå­å¥³ä¿¡æ¯</h3>
                            <button type="button" id="add-child-btn" class="btn-primary text-sm py-2 px-4">
                                + æ·»åŠ å­å¥³
                            </button>
                        </div>
                        
                        <div id="children-list" class="space-y-6">
                            <!-- åŠ¨æ€æ·»åŠ çš„å­å¥³å¡ç‰‡ -->
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-12">
                    <button id="step4-prev" class="btn-secondary">
                        ä¸Šä¸€æ­¥
                    </button>
                    <button id="step4-next" class="btn-primary">
                        ä¸‹ä¸€æ­¥
                    </button>
                </div>
            </div>

            <!-- æ­¥éª¤5: ç»§æ‰¿äººçŠ¶æ€è¯¦ç»†åˆ†ç±» -->
            <div id="step5" class="step">
                <h2 class="text-2xl font-bold mb-2 text-blue-800">ç¬¬äº”æ­¥ï¼šç»§æ‰¿äººçŠ¶æ€åˆ†ç±»</h2>
                <div class="author-info">é»„å† é›„å¾‹å¸ˆå›¢é˜Ÿå‡ºå“ | å¯æ·»åŠ å¾®ä¿¡å·ï¼šner_0710è¯¦è¯¢</div>
                <p class="text-gray-600 mb-8 text-lg">ç³»ç»Ÿå·²æ ¹æ®æ‚¨å¡«å†™çš„ä¿¡æ¯è‡ªåŠ¨åˆ†ç±»</p>
                
                <div class="space-y-8">
                    <!-- åœ¨ä¸–ç»§æ‰¿äºº -->
                    <div class="info-card border-green-300 bg-gradient-to-br from-green-50 to-emerald-50">
                        <h3 class="text-xl font-bold mb-6 text-green-800">ğŸ‘¥ åœ¨ä¸–ç»§æ‰¿äºº</h3>
                        <p class="text-green-700 mb-6">è¿™äº›ç»§æ‰¿äººå°†ç›´æ¥ç»§æ‰¿ç›¸åº”ä»½é¢</p>
                        
                        <div id="alive-heirs-list" class="space-y-4">
                            <!-- åŠ¨æ€ç”Ÿæˆåœ¨ä¸–ç»§æ‰¿äººåˆ—è¡¨ -->
                        </div>
                        
                        <div id="no-alive-heirs" class="hidden text-center py-8 text-gray-500">
                            <div class="text-4xl mb-4">ğŸ“­</div>
                            <p class="text-lg">æ²¡æœ‰åœ¨ä¸–çš„ç»§æ‰¿äºº</p>
                        </div>
                    </div>
                    
                    <!-- åœ¨è¢«ç»§æ‰¿äººä¹‹å‰å»ä¸–çš„ç»§æ‰¿äºº -->
                    <div class="info-card border-yellow-300 bg-gradient-to-br from-yellow-50 to-amber-50">
                        <h3 class="text-xl font-bold mb-6 text-yellow-800">â° åœ¨è¢«ç»§æ‰¿äººä¹‹å‰å»ä¸–çš„ç»§æ‰¿äºº</h3>
                        <p class="text-yellow-700 mb-6">å¦‚æœæ˜¯å­å¥³ï¼Œå°†ç”±å­å¥³çš„å­å¥³ç»§æ‰¿</p>
                        
                        <div id="predeceased-heirs-list" class="space-y-4">
                            <!-- åŠ¨æ€ç”Ÿæˆå…ˆå»ä¸–ç»§æ‰¿äººåˆ—è¡¨ -->
                        </div>
                        
                        <div id="no-predeceased-heirs" class="hidden text-center py-8 text-gray-500">
                            <div class="text-4xl mb-4">ğŸ“…</div>
                            <p class="text-lg">æ²¡æœ‰è¢«ç»§æ‰¿äººä¹‹å‰å»ä¸–çš„ç»§æ‰¿äºº</p>
                        </div>
                    </div>
                    
                    <!-- åœ¨è¢«ç»§æ‰¿äººä¹‹åå»ä¸–çš„ç»§æ‰¿äºº -->
                    <div class="info-card border-red-300 bg-gradient-to-br from-red-50 to-pink-50">
                        <h3 class="text-xl font-bold mb-6 text-red-800">ğŸ”„ åœ¨è¢«ç»§æ‰¿äººä¹‹åå»ä¸–çš„ç»§æ‰¿äºº</h3>
                        <p class="text-red-700 mb-6">è¿™äº›ç»§æ‰¿äººå°†åœ¨ä¸‹ä¸€æ­¥å¤„ç†è½¬ç»§æ‰¿</p>
                        
                        <div id="postdeceased-heirs-list" class="space-y-4">
                            <!-- åŠ¨æ€ç”Ÿæˆåå»ä¸–ç»§æ‰¿äººåˆ—è¡¨ -->
                        </div>
                        
                        <div id="no-postdeceased-heirs" class="hidden text-center py-8 text-gray-500">
                            <div class="text-4xl mb-4">â³</div>
                            <p class="text-lg">æ²¡æœ‰è¢«ç»§æ‰¿äººä¹‹åå»ä¸–çš„ç»§æ‰¿äºº</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-12">
                    <button id="step5-prev" class="btn-secondary">
                        ä¸Šä¸€æ­¥
                    </button>
                    <button id="step5-next" class="btn-primary">
                        ä¸‹ä¸€æ­¥
                    </button>
                </div>
            </div>

            <!-- æ­¥éª¤6: å¤„ç†ç¦»ä¸–ç»§æ‰¿äººçš„è¯¦ç»†æƒ…å†µï¼ˆç²¾ç®€ç‰ˆï¼‰ -->
            <div id="step6" class="step">
                <h2 class="text-2xl font-bold mb-2 text-blue-800">ç¬¬å…­æ­¥ï¼šå¤„ç†ç¦»ä¸–ç»§æ‰¿äºº</h2>
                <div class="author-info">é»„å† é›„å¾‹å¸ˆå›¢é˜Ÿå‡ºå“ | å¯æ·»åŠ å¾®ä¿¡å·ï¼šner_0710è¯¦è¯¢</div>
                <p class="text-gray-600 mb-8 text-lg">è¯·è¡¥å……ç¦»ä¸–ç»§æ‰¿äººçš„è¯¦ç»†ä¿¡æ¯</p>
                
                <div class="space-y-8">
                    <!-- A. å¤„ç†å­å¥³çš„å­å¥³ç»§æ‰¿ -->
                    <div id="per-stirpes-section" class="hidden">
                        <div class="info-card border-yellow-400 bg-gradient-to-br from-yellow-50 to-amber-50">
                            <h3 class="text-xl font-bold mb-6 text-yellow-800">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å­å¥³çš„å­å¥³ç»§æ‰¿</h3>
                            <p class="text-yellow-700 mb-6">ä»¥ä¸‹å­å¥³å…ˆäºè¢«ç»§æ‰¿äººå»ä¸–ï¼Œè¯·å¡«å†™å…¶å­å¥³ä¿¡æ¯ï¼š</p>
                            
                            <div id="per-stirpes-list" class="space-y-8">
                                <!-- åŠ¨æ€ç”Ÿæˆå­å¥³çš„å­å¥³ç»§æ‰¿è¾“å…¥ -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- B. å¤„ç†è½¬ç»§æ‰¿ -->
                    <div id="transferred-section" class="hidden">
                        <div class="info-card border-red-400 bg-gradient-to-br from-red-50 to-pink-50">
                            <h3 class="text-xl font-bold mb-6 text-red-800">ğŸ”„ è½¬ç»§æ‰¿å¤„ç†</h3>
                            <p class="text-red-700 mb-6">
                                è¯·å°†ä»¥ä¸‹åœ¨è¢«ç»§æ‰¿äººä¹‹åå»ä¸–çš„ç»§æ‰¿äººï¼ŒæŒ‰ç…§ä»–ä»¬<strong class="text-red-800">å»ä¸–æ—¶é—´çš„å…ˆåé¡ºåº</strong>è¿›è¡Œæ’åºã€‚
                            </p>
                            
                            <div id="postdeceased-sort-instructions" class="mb-8 p-6 bg-white rounded-xl border border-red-200">
                                <p class="text-lg font-medium mb-4 text-red-800">éœ€è¦æ’åºçš„åå»ä¸–ç»§æ‰¿äººï¼ˆè¯·æŒ‰å»ä¸–æ—¶é—´ä»å…ˆåˆ°åæ‹–åŠ¨æ’åºï¼‰ï¼š</p>
                                <div id="postdeceased-sort-list" class="space-y-3">
                                    <!-- åŠ¨æ€ç”Ÿæˆæ’åºåˆ—è¡¨ -->
                                </div>
                                <p class="text-sm text-red-600 mt-4">ğŸ’¡ æç¤ºï¼šæ‹–åŠ¨é¡¹ç›®è°ƒæ•´é¡ºåºï¼Œæœ€å…ˆå»ä¸–çš„æ’ç¬¬1ä½</p>
                            </div>
                            
                            <!-- æ’åºåå¤„ç†è½¬ç»§æ‰¿ -->
                            <div id="transferred-details" class="space-y-8">
                                <!-- åŠ¨æ€ç”Ÿæˆè½¬ç»§æ‰¿è¯¦æƒ… -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- å¡«å†™æç¤º -->
                    <div class="special-hint">
                        <div class="special-hint-title">é‡è¦æç¤º</div>
                        <div class="special-hint-content">
                            è¯·æ ¹æ®å»ä¸–æ—¶é—´çš„å…ˆåé¡ºåºå¡«å†™ç›¸å…³ä¿¡æ¯ã€‚å¦‚æœå¯¹å»ä¸–æ—¶é—´é¡ºåºä¸ç¡®å®šï¼Œå¯å’¨è¯¢å¾‹å¸ˆååŠ©ã€‚
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between mt-12">
                    <button id="step6-prev" class="btn-secondary">
                        ä¸Šä¸€æ­¥
                    </button>
                    <button id="step6-calculate" class="btn-success">
                        ğŸ§® å¼€å§‹è®¡ç®—
                    </button>
                </div>
            </div>

            <!-- æ­¥éª¤7: è®¡ç®—ç»“æœ -->
            <div id="step7" class="step">
                <h2 class="text-2xl font-bold mb-2 text-blue-800">ç»§æ‰¿è®¡ç®—ç»“æœ</h2>
                <div class="author-info">é»„å† é›„å¾‹å¸ˆå›¢é˜Ÿå‡ºå“ | å¯æ·»åŠ å¾®ä¿¡å·ï¼šner_0710è¯¦è¯¢</div>
                
                <div id="calculation-result" class="space-y-8">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„è®¡ç®—ç»“æœ -->
                </div>
                
                <!-- å®£ä¼ å¼•æµéƒ¨åˆ† -->
                <div class="mt-12 pt-8 border-t border-gray-200">
                    <div class="wechat-qr-container">
                        <div class="wechat-qr-title">éœ€è¦ä¸“ä¸šæ³•å¾‹å’¨è¯¢ï¼Ÿ</div>
                        <p class="text-gray-700 mb-6 text-lg">
                            ä»¥ä¸Šè®¡ç®—ç»“æœä»…ä¾›å‚è€ƒï¼Œå¦‚éœ€å¤„ç†å®é™…ç»§æ‰¿äº‹åŠ¡æˆ–é‡åˆ°å¤æ‚æƒ…å†µï¼Œå»ºè®®å’¨è¯¢ä¸“ä¸šå¾‹å¸ˆã€‚
                        </p>
                        
<div class="wechat-qr-code">
    <img src="https://raw.githubusercontent.com/ner0710/inheritance-calculator/refs/heads/main/wechat-qr.jpg" 
         alt="å¾®ä¿¡äºŒç»´ç " 
         class="w-full h-full object-cover rounded-lg">
</div>
                        
                        <div class="wechat-id">å¾®ä¿¡å·ï¼šner_0710</div>
                        
                        <p class="text-gray-600 text-lg mt-6 font-medium">
                            æ·»åŠ å¾®ä¿¡æ—¶è¯·å¤‡æ³¨"é—äº§ç»§æ‰¿å’¨è¯¢"ï¼Œè·å–ä¸“ä¸šæ³•å¾‹æ„è§
                        </p>
                    </div>
                </div>
                
                <div class="flex justify-between mt-12">
                    <button id="step7-prev" class="btn-secondary">
                        ğŸ“ è¿”å›ä¿®æ”¹
                    </button>
                    <button id="restart-calculator" class="btn-primary">
                        ğŸ”„ é‡æ–°è®¡ç®—
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="info-card">
            <h3 class="text-xl font-bold mb-8 text-blue-800">ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <div class="bg-blue-50 p-5 rounded-xl border border-blue-200">
                        <h4 class="font-bold text-blue-700 mb-3 text-lg">1. å¤«å¦»å…±åŒè´¢äº§åˆ†å‰²</h4>
                        <p class="text-gray-600">å¤«å¦»å…±åŒè´¢äº§åº”å…ˆåˆ†å‡ºä¸€åŠå½’é…å¶æ‰€æœ‰ï¼Œå‰©ä½™éƒ¨åˆ†ä½œä¸ºé—äº§è¿›è¡Œåˆ†é…ã€‚</p>
                    </div>
                    <div class="bg-green-50 p-5 rounded-xl border border-green-200">
                        <h4 class="font-bold text-green-700 mb-3 text-lg">2. è½¬ç»§æ‰¿å¡«å†™</h4>
                        <p class="text-gray-600">å¡«å†™è½¬ç»§æ‰¿ä¿¡æ¯æ—¶ï¼Œè¯·æŒ‰ç…§å»ä¸–æ—¶é—´å…ˆåé¡ºåºï¼Œå¹¶å¡«å†™å®é™…ç»§æ‰¿äººå§“åï¼ˆé…å¶ã€çˆ¶æ¯ã€å­å¥³ç­‰ï¼‰ã€‚</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="bg-yellow-50 p-5 rounded-xl border border-yellow-200">
                        <h4 class="font-bold text-yellow-700 mb-3 text-lg">3. ä¸“ä¸šå’¨è¯¢</h4>
                        <p class="text-gray-600">å¦‚éœ€å¤„ç†å®é™…ç»§æ‰¿äº‹åŠ¡æˆ–é‡åˆ°å¤æ‚æƒ…å†µï¼Œå¯æ·»åŠ å¾®ä¿¡å·ï¼šner_0710 è·å–ä¸“ä¸šæ³•å¾‹å’¨è¯¢ã€‚</p>
                    </div>
                    <div class="bg-red-50 p-5 rounded-xl border border-red-200">
                        <h4 class="font-bold text-red-700 mb-3 text-lg">4. å…è´£å£°æ˜</h4>
                        <p class="text-gray-600">æœ¬å·¥å…·è®¡ç®—ç»“æœä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæ­£å¼æ³•å¾‹æ„è§ã€‚å¤æ‚ç»§æ‰¿æ¡ˆä»¶è¯·å’¨è¯¢ä¸“ä¸šå¾‹å¸ˆã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer class="bg-gradient-to-r from-blue-900 to-blue-800 text-white py-12 mt-12">
        <div class="container mx-auto px-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-6">
                    <span class="text-3xl">âš–ï¸</span>
                </div>
                <h2 class="text-2xl font-bold mb-3">é—äº§ç»§æ‰¿è®¡ç®—å™¨</h2>
                <p class="text-blue-200 text-lg mb-6">åŸºäºã€Šæ°‘æ³•å…¸ã€‹ç»§æ‰¿ç¼– Â· æ™ºèƒ½æ³•å¾‹è®¡ç®—å·¥å…·</p>
                <div class="border-t border-blue-700 pt-6 mt-6">
                    <p class="text-blue-300">Â© 2023 æ™ºèƒ½é—äº§ç»§æ‰¿è®¡ç®—å™¨. æœ¬å·¥å…·ä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæ³•å¾‹æ„è§ã€‚</p>
                    <p class="text-blue-300 mt-2"><strong class="text-white">é»„å† é›„å¾‹å¸ˆå›¢é˜Ÿ</strong>å‡ºå“ | ä¸“ä¸šå’¨è¯¢å¾®ä¿¡å·ï¼šner_0710</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript ä»£ç  -->
    <script>
        // å…¨å±€å˜é‡
        let currentStep = 1;
        const totalSteps = 7;
        
        // é‡æ–°è®¾è®¡çš„æ•°æ®ç»“æ„
        let inheritanceDataV2 = {
            deceased: {
                name: '',
                propertyType: 'community',
                communityPropertyAmount: 0,
                personalPropertyAmount: 0,
                estateAmount: 0
            },
            heirs: {
                spouse: { 
                    name: '', 
                    status: 'none',
                    transferredTo: [],
                    hasSpouse: false,
                    transferredFromSpouse: null
                },
                father: { 
                    name: '', 
                    status: 'alive',
                    transferredTo: [],
                    hasSpouse: false,
                    transferredFromSpouse: null
                },
                mother: { 
                    name: '', 
                    status: 'alive',
                    transferredTo: [],
                    hasSpouse: false,
                    transferredFromSpouse: null
                },
                children: []
            },
            postdeceasedOrder: [],
            transferredDetails: {},
            parentsDeathOrder: null
        };
        
        // åˆå§‹åŒ–å‡½æ•°
        function initCalculator() {
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('step1-next').addEventListener('click', nextStep);
            document.getElementById('step2-prev').addEventListener('click', prevStep);
            document.getElementById('step2-next').addEventListener('click', nextStep);
            document.getElementById('step3-prev').addEventListener('click', prevStep);
            document.getElementById('step3-next').addEventListener('click', nextStep);
            document.getElementById('step4-prev').addEventListener('click', prevStep);
            document.getElementById('step4-next').addEventListener('click', nextToStep5);
            document.getElementById('step5-prev').addEventListener('click', prevStep);
            document.getElementById('step5-next').addEventListener('click', nextToStep6);
            document.getElementById('step6-prev').addEventListener('click', prevStep);
            document.getElementById('step6-calculate').addEventListener('click', calculateInheritance);
            document.getElementById('step7-prev').addEventListener('click', prevStep);
            document.getElementById('restart-calculator').addEventListener('click', restartCalculator);
            
            // ç»‘å®šæ·»åŠ å­å¥³æŒ‰é’®äº‹ä»¶
            document.getElementById('add-child-btn').addEventListener('click', addChild);
            
            // è´¢äº§æ€§è´¨é€‰æ‹© - ä¿®å¤å•é€‰æ¡†é€»è¾‘
            const propertyCards = document.querySelectorAll('.property-card');
            
            propertyCards.forEach(card => {
                card.addEventListener('click', function() {
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.checked = true;
                        updatePropertySelection();
                    }
                });
            });
            
            // ç›‘å¬è´¢äº§æ€§è´¨å˜åŒ–
            const propertyRadios = document.querySelectorAll('.property-type-radio');
            propertyRadios.forEach(radio => {
                radio.addEventListener('change', updatePropertySelection);
            });
            
            // åˆå§‹åŒ–è´¢äº§é€‰æ‹©
            updatePropertySelection();
            
            // ç›‘å¬è´¢äº§é‡‘é¢è¾“å…¥å˜åŒ–
            const communityPropertyInput = document.getElementById('community-property-amount');
            const personalPropertyInput = document.getElementById('personal-property-amount');
            const personalEstateInput = document.getElementById('personal-estate-amount');
            
            if (communityPropertyInput) {
                communityPropertyInput.addEventListener('input', function() {
                    const amount = parseFloat(this.value) || 0;
                    inheritanceDataV2.deceased.communityPropertyAmount = amount;
                    updatePropertyCalculations();
                });
            }
            
            if (personalPropertyInput) {
                personalPropertyInput.addEventListener('input', function() {
                    const amount = parseFloat(this.value) || 0;
                    inheritanceDataV2.deceased.personalPropertyAmount = amount;
                    updatePropertyCalculations();
                });
            }
            
            // ä¸ªäººè´¢äº§æ¨¡å¼ä¸‹çš„é—äº§é‡‘é¢è¾“å…¥
            if (personalEstateInput) {
                personalEstateInput.addEventListener('input', function() {
                    const amount = parseFloat(this.value) || 0;
                    inheritanceDataV2.deceased.estateAmount = amount;
                    inheritanceDataV2.deceased.personalPropertyAmount = amount;
                });
            }
            
            // ç›‘å¬è¢«ç»§æ‰¿äººå§“åå˜åŒ–
            const deceasedNameInput = document.getElementById('deceased-name');
            if (deceasedNameInput) {
                deceasedNameInput.addEventListener('input', function() {
                    inheritanceDataV2.deceased.name = this.value.trim();
                });
            }
            
            console.log('è®¡ç®—å™¨åˆå§‹åŒ–å®Œæˆ');
        }
        
        // æ›´æ–°è´¢äº§é€‰æ‹©çŠ¶æ€çš„å‡½æ•°
        function updatePropertySelection() {
            const communityRadio = document.querySelector('input[value="community"]');
            const personalRadio = document.querySelector('input[value="personal"]');
            const communityContainer = document.getElementById('community-property-container');
            const personalContainer = document.getElementById('personal-property-container');
            const propertyCards = document.querySelectorAll('.property-card');
            
            const communityCardContent = document.querySelector('.property-card:first-child .card-content');
            const personalCardContent = document.querySelector('.property-card:last-child .card-content');
            
            if (communityRadio && communityRadio.checked) {
                if (communityContainer) communityContainer.style.display = 'block';
                if (personalContainer) personalContainer.classList.add('hidden');
                inheritanceDataV2.deceased.propertyType = 'community';
                
                propertyCards[0].classList.add('selected');
                if (propertyCards[1]) propertyCards[1].classList.remove('selected');
                
                const communityIndicator = propertyCards[0].querySelector('.selection-indicator');
                if (communityIndicator) {
                    communityIndicator.style.display = 'flex';
                }
                
                const personalIndicator = propertyCards[1]?.querySelector('.selection-indicator');
                if (personalIndicator) {
                    personalIndicator.style.display = 'none';
                }
            } else if (personalRadio && personalRadio.checked) {
                if (communityContainer) communityContainer.style.display = 'none';
                if (personalContainer) personalContainer.classList.remove('hidden');
                inheritanceDataV2.deceased.propertyType = 'personal';
                
                propertyCards[0].classList.remove('selected');
                if (propertyCards[1]) propertyCards[1].classList.add('selected');
                
                const communityIndicator = propertyCards[0].querySelector('.selection-indicator');
                if (communityIndicator) {
                    communityIndicator.style.display = 'none';
                }
                
                let personalIndicator = propertyCards[1]?.querySelector('.selection-indicator');
                if (propertyCards[1] && !personalIndicator) {
                    personalIndicator = document.createElement('div');
                    personalIndicator.className = 'selection-indicator';
                    personalIndicator.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    `;
                    personalCardContent.appendChild(personalIndicator);
                }
                if (personalIndicator) {
                    personalIndicator.style.display = 'flex';
                }
            }
        }
        
        // æ›´æ–°è´¢äº§è®¡ç®—
        function updatePropertyCalculations() {
            const communityAmount = inheritanceDataV2.deceased.communityPropertyAmount;
            const personalAmount = inheritanceDataV2.deceased.personalPropertyAmount;
            const communityHalf = communityAmount / 2;
            const estateAmount = communityHalf + personalAmount;
            
            const communityHalfDisplay = document.getElementById('community-half-display');
            const personalPropertyDisplay = document.getElementById('personal-property-display');
            const estateTotalDisplay = document.getElementById('estate-total-display');
            const spousePersonalDisplay = document.getElementById('spouse-personal-display');
            
            if (communityHalfDisplay) communityHalfDisplay.textContent = 'Â¥' + formatNumber(communityHalf);
            if (personalPropertyDisplay) personalPropertyDisplay.textContent = 'Â¥' + formatNumber(personalAmount);
            if (estateTotalDisplay) estateTotalDisplay.textContent = 'Â¥' + formatNumber(estateAmount);
            if (spousePersonalDisplay) spousePersonalDisplay.textContent = 'Â¥' + formatNumber(communityHalf);
            
            inheritanceDataV2.deceased.estateAmount = estateAmount;
        }
        
        // æ ¼å¼åŒ–æ•°å­—æ˜¾ç¤º
        function formatNumber(num) {
            if (isNaN(num)) return '0';
            return num.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // æ­¥éª¤å¯¼èˆª
        function nextStep() {
            if (!validateStep(currentStep)) {
                return;
            }
            
            saveStepData(currentStep);
            
            if (currentStep < totalSteps) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep++;
                document.getElementById(`step${currentStep}`).classList.add('active');
                updateProgress();
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep--;
                document.getElementById(`step${currentStep}`).classList.add('active');
                updateProgress();
            }
        }
        
        function updateProgress() {
            const progressPercent = ((currentStep - 1) / (totalSteps - 1)) * 100;
            const progressBar = document.getElementById('progress-bar');
            const currentStepSpan = document.getElementById('current-step');
            
            if (progressBar) progressBar.style.width = `${progressPercent}%`;
            if (currentStepSpan) currentStepSpan.textContent = currentStep;
        }
        
        // éªŒè¯æ­¥éª¤
        function validateStep(step) {
            switch(step) {
                case 1:
                    const deceasedName = document.getElementById('deceased-name').value.trim();
                    if (!deceasedName) {
                        alert('è¯·è¾“å…¥è¢«ç»§æ‰¿äººå§“å');
                        return false;
                    }
                    return true;
                    
                case 2:
                    return true;
                    
                case 3:
                    if (inheritanceDataV2.deceased.propertyType === 'community') {
                        const communityAmount = parseFloat(document.getElementById('community-property-amount').value) || 0;
                        if (communityAmount <= 0) {
                            alert('è¯·è¾“å…¥å¤«å¦»å…±åŒè´¢äº§æ€»é¢');
                            return false;
                        }
                        
                        const personalAmount = parseFloat(document.getElementById('personal-property-amount').value) || 0;
                        if (personalAmount < 0) {
                            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è¢«ç»§æ‰¿äººä¸ªäººè´¢äº§æ€»é¢');
                            return false;
                        }
                    } else {
                        const estateAmount = parseFloat(document.getElementById('personal-estate-amount').value) || 0;
                        if (estateAmount <= 0) {
                            alert('è¯·è¾“å…¥é—äº§æ€»é¢');
                            return false;
                        }
                    }
                    return true;
                    
                case 4:
                    return validateStep4();
                    
                case 5:
                    return true;
                    
                case 6:
                    return validateStep6();
                    
                default:
                    return true;
            }
        }
        
        // ä¿å­˜æ­¥éª¤æ•°æ®
        function saveStepData(step) {
            switch(step) {
                case 1:
                    inheritanceDataV2.deceased.name = document.getElementById('deceased-name').value.trim();
                    break;
                    
                case 2:
                    break;
                    
                case 3:
                    if (inheritanceDataV2.deceased.propertyType === 'community') {
                        inheritanceDataV2.deceased.communityPropertyAmount = parseFloat(document.getElementById('community-property-amount').value) || 0;
                        inheritanceDataV2.deceased.personalPropertyAmount = parseFloat(document.getElementById('personal-property-amount').value) || 0;
                        // è®¡ç®—é—äº§æ€»é¢
                        inheritanceDataV2.deceased.estateAmount = (inheritanceDataV2.deceased.communityPropertyAmount / 2) + inheritanceDataV2.deceased.personalPropertyAmount;
                    } else {
                        inheritanceDataV2.deceased.estateAmount = parseFloat(document.getElementById('personal-estate-amount').value) || 0;
                        inheritanceDataV2.deceased.personalPropertyAmount = inheritanceDataV2.deceased.estateAmount;
                    }
                    break;
                    
                case 4:
                    saveStep4Data();
                    break;
                    
                case 5:
                    break;
                    
                case 6:
                    break;
            }
        }
        
        // æ­¥éª¤å¯¼èˆªå‡½æ•°
        function nextToStep5() {
            saveStep4Data();
            
            if (!validateStep4()) {
                return;
            }
            
            classifyHeirs();
            
            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep = 5;
            document.getElementById(`step${currentStep}`).classList.add('active');
            updateProgress();
        }
        
        function nextToStep6() {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep = 6;
            document.getElementById(`step${currentStep}`).classList.add('active');
            updateProgress();
            
            initializeStep6();
        }
        
        // ä¿å­˜ç¬¬å››æ­¥æ•°æ®
        function saveStep4Data() {
            inheritanceDataV2.heirs.spouse = {
                name: document.getElementById('spouse-name').value.trim(),
                status: document.getElementById('spouse-status').value,
                transferredTo: [],
                hasSpouse: false,
                transferredFromSpouse: null
            };
            
            inheritanceDataV2.heirs.father = {
                name: document.getElementById('father-name').value.trim(),
                status: document.getElementById('father-status').value,
                transferredTo: [],
                hasSpouse: false,
                transferredFromSpouse: null
            };
            
            inheritanceDataV2.heirs.mother = {
                name: document.getElementById('mother-name').value.trim(),
                status: document.getElementById('mother-status').value,
                transferredTo: [],
                hasSpouse: false,
                transferredFromSpouse: null
            };
            
            inheritanceDataV2.heirs.children = [];
            const childrenItems = document.querySelectorAll('.child-item');
            childrenItems.forEach((child, index) => {
                const name = child.querySelector('.child-name').value.trim();
                const status = child.querySelector('.child-status').value;
                
                inheritanceDataV2.heirs.children.push({
                    name: name,
                    status: status,
                    perStirpes: [],
                    transferredTo: [],
                    hasSpouse: false,
                    transferredFromSpouse: null
                });
            });
        }
        
        // éªŒè¯ç¬¬å››æ­¥æ•°æ®
        function validateStep4() {
            const spouseStatus = inheritanceDataV2.heirs.spouse.status;
            const spouseName = inheritanceDataV2.heirs.spouse.name;
            
            if (spouseStatus !== 'none' && !spouseName) {
                alert('è¯·è¾“å…¥è¢«ç»§æ‰¿äººé…å¶å§“å');
                return false;
            }
            
            const fatherStatus = inheritanceDataV2.heirs.father.status;
            const fatherName = inheritanceDataV2.heirs.father.name;
            
            if (fatherStatus !== 'none' && !fatherName) {
                alert('è¯·è¾“å…¥è¢«ç»§æ‰¿äººçˆ¶äº²å§“å');
                return false;
            }
            
            const motherStatus = inheritanceDataV2.heirs.mother.status;
            const motherName = inheritanceDataV2.heirs.mother.name;
            
            if (motherStatus !== 'none' && !motherName) {
                alert('è¯·è¾“å…¥è¢«ç»§æ‰¿äººæ¯äº²å§“å');
                return false;
            }
            
            for (let child of inheritanceDataV2.heirs.children) {
                if (!child.name) {
                    alert('è¯·è¾“å…¥æ‰€æœ‰å­å¥³çš„å§“å');
                    return false;
                }
            }
            
            return true;
        }
        
        // éªŒè¯ç¬¬å…­æ­¥æ•°æ®
        function validateStep6() {
            const predeceasedChildren = inheritanceDataV2.heirs.children.filter(child => 
                child.status === 'predeceased'
            );
            
            for (let child of predeceasedChildren) {
                if (child.perStirpes && child.perStirpes.length === 0) {
                    const childName = child.name || 'è¯¥å­å¥³';
                    if (!confirm(`${childName}å…ˆäºè¢«ç»§æ‰¿äººå»ä¸–ï¼Œä½†æœªå¡«å†™å…¶å­å¥³ä¿¡æ¯ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                        return false;
                    }
                }
            }
            
            if (inheritanceDataV2.postdeceasedOrder.length > 0) {
                const sortedHeirs = [...inheritanceDataV2.postdeceasedOrder].sort((a, b) => {
                    const orderA = a.order || 0;
                    const orderB = b.order || 0;
                    return orderA - orderB;
                });
                
                for (let heir of sortedHeirs) {
                    let heirData = null;
                    
                    if (heir.type === 'spouse') {
                        heirData = inheritanceDataV2.heirs.spouse;
                    } else if (heir.type === 'father') {
                        heirData = inheritanceDataV2.heirs.father;
                    } else if (heir.type === 'mother') {
                        heirData = inheritanceDataV2.heirs.mother;
                    } else if (heir.type === 'child') {
                        heirData = inheritanceDataV2.heirs.children[heir.index];
                    }
                    
                    // æ£€æŸ¥è½¬ç»§æ‰¿äººä¿¡æ¯
                    if (heirData && heirData.transferredTo && heirData.transferredTo.length > 0) {
                        for (let transferee of heirData.transferredTo) {
                            if (!transferee.name) {
                                alert('è¯·å¡«å†™å®Œæ•´çš„è½¬ç»§æ‰¿äººä¿¡æ¯');
                                return false;
                            }
                        }
                    }
                }
            }
            
            return true;
        }
        
        // åˆ†ç±»ç»§æ‰¿äººå¹¶åœ¨ç¬¬äº”æ­¥æ˜¾ç¤º
        function classifyHeirs() {
            const aliveHeirsList = document.getElementById('alive-heirs-list');
            const predeceasedHeirsList = document.getElementById('predeceased-heirs-list');
            const postdeceasedHeirsList = document.getElementById('postdeceased-heirs-list');
            
            if (!aliveHeirsList || !predeceasedHeirsList || !postdeceasedHeirsList) return;
            
            aliveHeirsList.innerHTML = '';
            predeceasedHeirsList.innerHTML = '';
            postdeceasedHeirsList.innerHTML = '';
            
            let aliveCount = 0;
            let predeceasedCount = 0;
            let postdeceasedCount = 0;
            
            const spouse = inheritanceDataV2.heirs.spouse;
            if (spouse.status === 'alive') {
                addHeirToCategory(aliveHeirsList, 'è¢«ç»§æ‰¿äººé…å¶', spouse.name, 'alive');
                aliveCount++;
            } else if (spouse.status === 'predeceased') {
                addHeirToCategory(predeceasedHeirsList, 'è¢«ç»§æ‰¿äººé…å¶', spouse.name, 'predeceased');
                predeceasedCount++;
            } else if (spouse.status === 'postdeceased') {
                addHeirToCategory(postdeceasedHeirsList, 'è¢«ç»§æ‰¿äººé…å¶', spouse.name, 'postdeceased');
                postdeceasedCount++;
            }
            
            const father = inheritanceDataV2.heirs.father;
            if (father.status === 'alive') {
                addHeirToCategory(aliveHeirsList, 'è¢«ç»§æ‰¿äººçˆ¶äº²', father.name, 'alive');
                aliveCount++;
            } else if (father.status === 'predeceased') {
                addHeirToCategory(predeceasedHeirsList, 'è¢«ç»§æ‰¿äººçˆ¶äº²', father.name, 'predeceased');
                predeceasedCount++;
            } else if (father.status === 'postdeceased') {
                addHeirToCategory(postdeceasedHeirsList, 'è¢«ç»§æ‰¿äººçˆ¶äº²', father.name, 'postdeceased');
                postdeceasedCount++;
            }
            
            const mother = inheritanceDataV2.heirs.mother;
            if (mother.status === 'alive') {
                addHeirToCategory(aliveHeirsList, 'è¢«ç»§æ‰¿äººæ¯äº²', mother.name, 'alive');
                aliveCount++;
            } else if (mother.status === 'predeceased') {
                addHeirToCategory(predeceasedHeirsList, 'è¢«ç»§æ‰¿äººæ¯äº²', mother.name, 'predeceased');
                predeceasedCount++;
            } else if (mother.status === 'postdeceased') {
                addHeirToCategory(postdeceasedHeirsList, 'è¢«ç»§æ‰¿äººæ¯äº²', mother.name, 'postdeceased');
                postdeceasedCount++;
            }
            
            inheritanceDataV2.heirs.children.forEach((child, index) => {
                if (child.status === 'alive') {
                    addHeirToCategory(aliveHeirsList, 'è¢«ç»§æ‰¿äººå­å¥³', child.name, 'alive', index);
                    aliveCount++;
                } else if (child.status === 'predeceased') {
                    addHeirToCategory(predeceasedHeirsList, 'è¢«ç»§æ‰¿äººå­å¥³', child.name, 'predeceased', index);
                    predeceasedCount++;
                } else if (child.status === 'postdeceased') {
                    addHeirToCategory(postdeceasedHeirsList, 'è¢«ç»§æ‰¿äººå­å¥³', child.name, 'postdeceased', index);
                    postdeceasedCount++;
                }
            });
            
            const noAliveHeirs = document.getElementById('no-alive-heirs');
            const noPredeceasedHeirs = document.getElementById('no-predeceased-heirs');
            const noPostdeceasedHeirs = document.getElementById('no-postdeceased-heirs');
            
            if (noAliveHeirs) noAliveHeirs.classList.toggle('hidden', aliveCount > 0);
            if (noPredeceasedHeirs) noPredeceasedHeirs.classList.toggle('hidden', predeceasedCount > 0);
            if (noPostdeceasedHeirs) noPostdeceasedHeirs.classList.toggle('hidden', postdeceasedCount > 0);
        }
        
        // æ·»åŠ ç»§æ‰¿äººåˆ°åˆ†ç±»åˆ—è¡¨
        function addHeirToCategory(container, type, name, status, index = null) {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-4 bg-white rounded-xl border shadow-sm';
            
            let statusBadge = '';
            let statusClass = '';
            
            if (status === 'alive') {
                statusBadge = '<span class="status-badge status-alive">åœ¨ä¸–</span>';
                statusClass = 'text-green-700';
            } else if (status === 'predeceased') {
                statusBadge = '<span class="status-badge status-predeceased">å…ˆå»ä¸–</span>';
                statusClass = 'text-yellow-700';
            } else if (status === 'postdeceased') {
                statusBadge = '<span class="status-badge status-postdeceased">åå»ä¸–</span>';
                statusClass = 'text-red-700';
            }
            
            const icon = type === 'è¢«ç»§æ‰¿äººé…å¶' ? 'ğŸ‘¤' : type === 'è¢«ç»§æ‰¿äººçˆ¶äº²' ? 'ğŸ‘¨' : type === 'è¢«ç»§æ‰¿äººæ¯äº²' ? 'ğŸ‘©' : 'ğŸ‘¶';
            
            div.innerHTML = `
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center mr-4 shadow-sm">
                        <span class="text-lg">${icon}</span>
                    </div>
                    <div>
                        <div class="font-bold text-lg ${statusClass}">${name}</div>
                        <div class="text-sm text-gray-500">${type}</div>
                    </div>
                </div>
                <div>
                    ${statusBadge}
                </div>
            `;
            
            container.appendChild(div);
        }
        
        // åˆå§‹åŒ–ç¬¬å…­æ­¥
        function initializeStep6() {
            collectPostdeceasedHeirs();
            showPerStirpesSection();
            showTransferredSection();
        }
        
        // æ”¶é›†åå»ä¸–ç»§æ‰¿äººç”¨äºæ’åº
        function collectPostdeceasedHeirs() {
            inheritanceDataV2.postdeceasedOrder = [];
            
            if (inheritanceDataV2.heirs.spouse.status === 'postdeceased') {
                inheritanceDataV2.postdeceasedOrder.push({
                    type: 'spouse',
                    name: inheritanceDataV2.heirs.spouse.name,
                    index: -1,
                    order: 0
                });
            }
            
            if (inheritanceDataV2.heirs.father.status === 'postdeceased') {
                inheritanceDataV2.postdeceasedOrder.push({
                    type: 'father',
                    name: inheritanceDataV2.heirs.father.name,
                    index: -1,
                    order: 0
                });
            }
            
            if (inheritanceDataV2.heirs.mother.status === 'postdeceased') {
                inheritanceDataV2.postdeceasedOrder.push({
                    type: 'mother',
                    name: inheritanceDataV2.heirs.mother.name,
                    index: -1,
                    order: 0
                });
            }
            
            inheritanceDataV2.heirs.children.forEach((child, index) => {
                if (child.status === 'postdeceased') {
                    inheritanceDataV2.postdeceasedOrder.push({
                        type: 'child',
                        name: child.name,
                        index: index,
                        order: 0
                    });
                }
            });
            
            inheritanceDataV2.postdeceasedOrder.forEach((heir, idx) => {
                heir.order = idx + 1;
            });
            
            const sortList = document.getElementById('postdeceased-sort-list');
            const sortInstructions = document.getElementById('postdeceased-sort-instructions');
            
            if (!sortList || !sortInstructions) return;
            
            sortList.innerHTML = '';
            
            if (inheritanceDataV2.postdeceasedOrder.length === 0) {
                sortInstructions.classList.add('hidden');
                return;
            }
            
            sortInstructions.classList.remove('hidden');
            
            inheritanceDataV2.postdeceasedOrder.forEach((heir, idx) => {
                const div = document.createElement('div');
                div.className = 'sortable-item flex items-center p-4 bg-white border rounded-xl cursor-move shadow-sm';
                div.dataset.index = idx;
                const icon = heir.type === 'spouse' ? 'ğŸ‘¤' : heir.type === 'father' ? 'ğŸ‘¨' : heir.type === 'mother' ? 'ğŸ‘©' : 'ğŸ‘¶';
                div.innerHTML = `
                    <div class="flex items-center w-full">
                        <div class="mr-4 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-lg">${heir.name}</div>
                            <div class="text-sm text-gray-500">${heir.type === 'spouse' ? 'è¢«ç»§æ‰¿äººé…å¶' : heir.type === 'father' ? 'è¢«ç»§æ‰¿äººçˆ¶äº²' : heir.type === 'mother' ? 'è¢«ç»§æ‰¿äººæ¯äº²' : 'è¢«ç»§æ‰¿äººå­å¥³'}</div>
                        </div>
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center mr-3">
                                <span class="text-sm font-bold text-red-600">${idx + 1}</span>
                            </div>
                            <div class="text-sm text-gray-500">å·</div>
                        </div>
                    </div>
                `;
                sortList.appendChild(div);
            });
            
            initializeSortableList();
        }
        
        // åˆå§‹åŒ–å¯æ’åºåˆ—è¡¨
        function initializeSortableList() {
            const sortList = document.getElementById('postdeceased-sort-list');
            if (!sortList) return;
            
            let draggedItem = null;
            
            sortList.querySelectorAll('.sortable-item').forEach(item => {
                item.setAttribute('draggable', true);
                
                item.addEventListener('dragstart', function(e) {
                    draggedItem = this;
                    setTimeout(() => {
                        this.classList.add('dragging');
                    }, 0);
                });
                
                item.addEventListener('dragend', function(e) {
                    setTimeout(() => {
                        this.classList.remove('dragging');
                        draggedItem = null;
                        updateSortOrder();
                    }, 0);
                });
                
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                item.addEventListener('dragenter', function(e) {
                    e.preventDefault();
                    if (this !== draggedItem) {
                        this.classList.add('over');
                    }
                });
                
                item.addEventListener('dragleave', function(e) {
                    this.classList.remove('over');
                });
                
                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    if (this !== draggedItem) {
                        this.classList.remove('over');
                        
                        const allItems = Array.from(sortList.querySelectorAll('.sortable-item'));
                        const draggedIndex = allItems.indexOf(draggedItem);
                        const targetIndex = allItems.indexOf(this);
                        
                        if (draggedIndex < targetIndex) {
                            this.parentNode.insertBefore(draggedItem, this.nextSibling);
                        } else {
                            this.parentNode.insertBefore(draggedItem, this);
                        }
                        
                        updateSortOrder();
                    }
                });
            });
        }
        
        // æ›´æ–°æ’åºé¡ºåº
        function updateSortOrder() {
            const sortList = document.getElementById('postdeceased-sort-list');
            if (!sortList) return;
            
            const items = sortList.querySelectorAll('.sortable-item');
            
            items.forEach((item, index) => {
                const orderSpan = item.querySelector('.w-8.h-8 span');
                if (orderSpan) {
                    orderSpan.textContent = index + 1;
                }
                
                const dataIndex = parseInt(item.dataset.index);
                if (inheritanceDataV2.postdeceasedOrder[dataIndex]) {
                    inheritanceDataV2.postdeceasedOrder[dataIndex].order = index + 1;
                }
            });
            
            showTransferredDetails();
        }
        
        // æ˜¾ç¤ºå­å¥³çš„å­å¥³ç»§æ‰¿éƒ¨åˆ†
        function showPerStirpesSection() {
            const perStirpesSection = document.getElementById('per-stirpes-section');
            const perStirpesList = document.getElementById('per-stirpes-list');
            
            if (!perStirpesSection || !perStirpesList) return;
            
            const predeceasedChildren = inheritanceDataV2.heirs.children.filter(child => 
                child.status === 'predeceased'
            );
            
            if (predeceasedChildren.length === 0) {
                perStirpesSection.classList.add('hidden');
                return;
            }
            
            perStirpesSection.classList.remove('hidden');
            perStirpesList.innerHTML = '';
            
            predeceasedChildren.forEach((child, childIndex) => {
                const childDiv = document.createElement('div');
                childDiv.className = 'bg-white p-6 rounded-xl border border-yellow-300 shadow-sm';
                childDiv.innerHTML = `
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-100 to-yellow-200 flex items-center justify-center mr-4">
                            <span class="text-lg">ğŸ‘¶</span>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg text-yellow-800">${child.name}ï¼ˆè¢«ç»§æ‰¿äººå­å¥³ï¼Œå…ˆäºè¢«ç»§æ‰¿äººå»ä¸–ï¼‰</h4>
                            <p class="text-sm text-yellow-600">è¯·å¡«å†™${child.name}çš„å­å¥³ï¼š</p>
                        </div>
                    </div>
                    
                    <div id="per-stirpes-items-${childIndex}" class="space-y-4 mb-4">
                        <div class="flex items-center">
                            <input type="text" class="form-input flex-1" 
                                   placeholder="è¯·è¾“å…¥å­™å­å¥³å§“å" data-child-index="${childIndex}">
                            <button type="button" onclick="removePerStirpesItem(this)" class="btn-secondary ml-3 text-sm py-2 px-3">
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                    
                    <button type="button" onclick="addPerStirpesItem(${childIndex})" class="w-full btn-secondary py-3">
                        + æ·»åŠ å­™è¾ˆ
                    </button>
                `;
                
                perStirpesList.appendChild(childDiv);
                
                const input = childDiv.querySelector('.form-input');
                input.addEventListener('blur', function() {
                    savePerStirpesData(childIndex, 0, this.value);
                });
            });
        }
        
        // æ·»åŠ å­™è¾ˆè¾“å…¥é¡¹
        window.addPerStirpesItem = function(childIndex) {
            const container = document.getElementById(`per-stirpes-items-${childIndex}`);
            if (!container) return;
            
            const itemCount = container.children.length;
            
            const div = document.createElement('div');
            div.className = 'flex items-center';
            div.innerHTML = `
                <input type="text" class="form-input flex-1" 
                       placeholder="è¯·è¾“å…¥å­™å­å¥³å§“å" data-child-index="${childIndex}">
                <button type="button" onclick="removePerStirpesItem(this)" class="btn-secondary ml-3 text-sm py-2 px-3">
                    åˆ é™¤
                </button>
            `;
            
            container.appendChild(div);
            
            const input = div.querySelector('.form-input');
            input.addEventListener('blur', function() {
                savePerStirpesData(childIndex, itemCount, this.value);
            });
        }
        
        // åˆ é™¤å­™è¾ˆè¾“å…¥é¡¹
        window.removePerStirpesItem = function(button) {
            button.closest('.flex.items-center').remove();
        }
        
        // ä¿å­˜å­™è¾ˆæ•°æ®
        function savePerStirpesData(childIndex, itemIndex, value) {
            if (inheritanceDataV2.heirs.children[childIndex]) {
                if (!inheritanceDataV2.heirs.children[childIndex].perStirpes) {
                    inheritanceDataV2.heirs.children[childIndex].perStirpes = [];
                }
                
                // ç¡®ä¿æ•°ç»„é•¿åº¦è¶³å¤Ÿ
                if (itemIndex >= inheritanceDataV2.heirs.children[childIndex].perStirpes.length) {
                    inheritanceDataV2.heirs.children[childIndex].perStirpes.length = itemIndex + 1;
                }
                
                if (value.trim()) {
                    inheritanceDataV2.heirs.children[childIndex].perStirpes[itemIndex] = value.trim();
                } else {
                    inheritanceDataV2.heirs.children[childIndex].perStirpes[itemIndex] = undefined;
                }
                
                // æ¸…ç†ç©ºå€¼
                inheritanceDataV2.heirs.children[childIndex].perStirpes = inheritanceDataV2.heirs.children[childIndex].perStirpes.filter(item => item);
            }
        }
        
        // æ˜¾ç¤ºè½¬ç»§æ‰¿éƒ¨åˆ†
        function showTransferredSection() {
            const transferredSection = document.getElementById('transferred-section');
            
            if (!transferredSection) return;
            
            if (inheritanceDataV2.postdeceasedOrder.length === 0) {
                transferredSection.classList.add('hidden');
                return;
            }
            
            transferredSection.classList.remove('hidden');
            showTransferredDetails();
        }
        
        // æ˜¾ç¤ºè½¬ç»§æ‰¿è¯¦æƒ… - ä¿®æ”¹ä¸ºæ›´ç”¨æˆ·å‹å¥½çš„ç•Œé¢
        function showTransferredDetails() {
            const transferredDetails = document.getElementById('transferred-details');
            if (!transferredDetails) return;
            
            transferredDetails.innerHTML = '';
            
            const sortedHeirs = [...inheritanceDataV2.postdeceasedOrder].sort((a, b) => {
                const orderA = a.order || 0;
                const orderB = b.order || 0;
                return orderA - orderB;
            });
            
            // æ ¹æ®æ’åºç¡®å®šçˆ¶æ¯å»ä¸–é¡ºåº
            const fatherPostdeceased = inheritanceDataV2.heirs.father.status === 'postdeceased';
            const motherPostdeceased = inheritanceDataV2.heirs.mother.status === 'postdeceased';
            
            if (fatherPostdeceased && motherPostdeceased) {
                // æ ¹æ®æ’åºç¡®å®šè°å…ˆå»ä¸–
                const fatherOrder = sortedHeirs.find(h => h.type === 'father')?.order || 0;
                const motherOrder = sortedHeirs.find(h => h.type === 'mother')?.order || 0;
                
                if (fatherOrder < motherOrder) {
                    inheritanceDataV2.parentsDeathOrder = 'father-first';
                } else if (motherOrder < fatherOrder) {
                    inheritanceDataV2.parentsDeathOrder = 'mother-first';
                } else {
                    inheritanceDataV2.parentsDeathOrder = null;
                }
            } else {
                inheritanceDataV2.parentsDeathOrder = null;
            }
            
            sortedHeirs.forEach((heir, index) => {
                const heirDiv = document.createElement('div');
                heirDiv.className = 'bg-white p-6 rounded-xl border border-red-200 shadow-sm';
                
                let heirTitle = '';
                let heirData = null;
                let heirIcon = '';
                
                if (heir.type === 'spouse') {
                    heirTitle = `è¢«ç»§æ‰¿äººé…å¶ï¼š${heir.name}`;
                    heirData = inheritanceDataV2.heirs.spouse;
                    heirIcon = 'ğŸ‘¤';
                } else if (heir.type === 'father') {
                    heirTitle = `è¢«ç»§æ‰¿äººçˆ¶äº²ï¼š${heir.name}`;
                    heirData = inheritanceDataV2.heirs.father;
                    heirIcon = 'ğŸ‘¨';
                } else if (heir.type === 'mother') {
                    heirTitle = `è¢«ç»§æ‰¿äººæ¯äº²ï¼š${heir.name}`;
                    heirData = inheritanceDataV2.heirs.mother;
                    heirIcon = 'ğŸ‘©';
                } else if (heir.type === 'child') {
                    heirTitle = `è¢«ç»§æ‰¿äººå­å¥³ï¼š${heir.name}`;
                    heirData = inheritanceDataV2.heirs.children[heir.index];
                    heirIcon = 'ğŸ‘¶';
                }
                
                const orderText = index === 0 ? 'æœ€å…ˆå»ä¸–' : `ç¬¬${index + 1}ä¸ªå»ä¸–`;
                
                // æ·»åŠ ç‰¹æ®Šæç¤ºï¼ˆé’ˆå¯¹çˆ¶æ¯è½¬ç»§æ‰¿ï¼‰
                let specialHint = '';
                if (heir.type === 'father' || heir.type === 'mother') {
                    specialHint = `
                        <div class="special-hint">
                            <div class="special-hint-title">å¡«å†™è¯´æ˜</div>
                            <div class="special-hint-content">
                                <strong>è¯·å¡«å†™è¢«ç»§æ‰¿äººçš„å­å¥³å§“åï¼š</strong><br>
                                ç”±äºè¢«ç»§æ‰¿äººï¼ˆ${inheritanceDataV2.deceased.name}ï¼‰å…ˆäºå…¶çˆ¶æ¯å»ä¸–ï¼Œ
                                ${heir.name}ï¼ˆ${heir.type === 'father' ? 'è¢«ç»§æ‰¿äººçˆ¶äº²' : 'è¢«ç»§æ‰¿äººæ¯äº²'}ï¼‰çš„ç»§æ‰¿ä»½é¢
                                åº”ç”±è¢«ç»§æ‰¿äººçš„å­å¥³ï¼ˆå³${heir.name}çš„å­™è¾ˆï¼‰ç»§æ‰¿ã€‚
                                <br><br>
                                <strong>ç¤ºä¾‹ï¼š</strong>
                                å¦‚æœè¢«ç»§æ‰¿äººæœ‰å­å¥³ï¼šå¼ ä¸‰ã€æå››ï¼Œè¯·åœ¨ä¸‹æ–¹å¡«å†™"å¼ ä¸‰ã€æå››"
                            </div>
                        </div>
                    `;
                }
                
                // ä¿®æ”¹ï¼šè¢«ç»§æ‰¿äººé…å¶è½¬ç»§æ‰¿çš„å¡«å†™è¯´æ˜ - æ›´æ¸…æ™°åœ°è¯´æ˜å­å¥³å’Œå­™è¾ˆçš„åŒºåˆ«
                let spouseSpecialHint = '';
                if (heir.type === 'spouse') {
                    spouseSpecialHint = `
                        <div class="special-hint">
                            <div class="special-hint-title">å¡«å†™è¯´æ˜</div>
                            <div class="special-hint-content">
                                <strong>è¯·æ ¹æ®ä»¥ä¸‹è§„åˆ™å¡«å†™${heir.name}ï¼ˆè¢«ç»§æ‰¿äººé…å¶ï¼‰çš„ç»§æ‰¿äººå§“åï¼š</strong><br><br>
                                1. å¦‚æœ${heir.name}çš„å­å¥³<strong>åäº${heir.name}å»ä¸–</strong>ï¼Œè¯·å¡«å†™<strong>è¯¥å­å¥³çš„å§“å</strong>ã€‚<br>
                                2. å¦‚æœ${heir.name}çš„å­å¥³<strong>å…ˆäº${heir.name}å»ä¸–</strong>ï¼Œè¯·å¡«å†™<strong>è¯¥å·²æ•…å­å¥³çš„å­å¥³ï¼ˆå³${heir.name}çš„å­™è¾ˆï¼‰çš„å§“å</strong>ã€‚<br><br>
                                ä¸¾ä¾‹è¯´æ˜ï¼š<br>
                                â€¢ å­å¥³"å¼ ä¸‰"åœ¨${heir.name}ä¹‹åå»ä¸– â†’ å¡«å†™"å¼ ä¸‰"<br>
                                â€¢ å­å¥³"æå››"åœ¨${heir.name}ä¹‹å‰å»ä¸–ï¼Œæå››æœ‰å­å¥³"æå°å››" â†’ å¡«å†™"æå°å››"
                            </div>
                        </div>
                    `;
                }
                
                // ä¿®æ”¹ï¼šè¢«ç»§æ‰¿äººé…å¶ä¸éœ€è¦è¯¢é—®æœ‰æ— é…å¶ï¼Œå…¶ä»–è½¬ç»§æ‰¿äººéœ€è¦è¯¢é—®
                let hasSpouseHtml = '';
                if (heir.type !== 'spouse') {
                    hasSpouseHtml = `
                        <div class="mb-6">
                            <label class="block text-lg font-medium text-red-700 mb-3">${heir.name}å»ä¸–æ—¶æ˜¯å¦æœ‰ä»åœ¨ä¸–çš„é…å¶ï¼Ÿ</label>
                            <div class="flex space-x-6">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="has-spouse-${heir.type}-${heir.index}" value="yes" 
                                           class="h-5 w-5 text-red-600 focus:ring-red-500 border-gray-300" 
                                           data-heir-type="${heir.type}" data-heir-index="${heir.index}" 
                                           ${heirData.hasSpouse ? 'checked' : ''}>
                                    <span class="ml-3 text-lg">æœ‰é…å¶</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="has-spouse-${heir.type}-${heir.index}" value="no" 
                                           class="h-5 w-5 text-red-600 focus:ring-red-500 border-gray-300" 
                                           data-heir-type="${heir.type}" data-heir-index="${heir.index}"
                                           ${!heirData.hasSpouse ? 'checked' : ''}>
                                    <span class="ml-3 text-lg">æ— é…å¶</span>
                                </label>
                            </div>
                            <div id="spouse-hint-${heir.type}-${heir.index}" class="important-note hidden mt-3">
                                <strong>è¯·æ³¨æ„ï¼š</strong>å¦‚æœæ‚¨é€‰æ‹©äº†"æœ‰é…å¶"ï¼Œè¯·åœ¨ä¸‹æ–¹å¡«å†™ç»§æ‰¿äººæ—¶ï¼ŒåŠ¡å¿…å°†é…å¶çš„å§“åå¡«å†™åœ¨ç¬¬ä¸€ä½ï¼Œå¦åˆ™ä¼šå½±å“è®¡ç®—ç»“æœçš„å‡†ç¡®æ€§ã€‚
                            </div>
                        </div>
                    `;
                }
                
                heirDiv.innerHTML = `
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-100 to-red-200 flex items-center justify-center mr-4 shadow-sm">
                            <span class="text-2xl">${heirIcon}</span>
                        </div>
                        <div>
                            <h4 class="font-bold text-xl text-red-800">${heirTitle}</h4>
                            <div class="text-lg text-red-600 font-medium">${orderText}</div>
                        </div>
                    </div>
                    
                    <p class="text-lg text-gray-700 mb-6">
                        ${heir.name}å»ä¸–åï¼Œä»–/å¥¹çš„è´¢äº§åº”ç”±å“ªäº›äººç»§æ‰¿ï¼Ÿè¯·å¡«å†™ï¼š
                    </p>
                    
                    ${spouseSpecialHint}
                    ${specialHint}
                    
                    ${hasSpouseHtml}
                    
                    <div id="transferred-items-${heir.type}-${heir.index}" class="space-y-4 mb-6">
                        ${heirData.transferredTo && heirData.transferredTo.length > 0 ? 
                            heirData.transferredTo.map((item, i) => `
                                <div>
                                    <div class="flex items-center">
                                        <input type="text" class="form-input flex-1" 
                                               placeholder="è¯·è¾“å…¥ç»§æ‰¿äººå§“å" data-heir-type="${heir.type}" data-heir-index="${heir.index}" 
                                               value="${item.name || ''}">
                                        <button type="button" onclick="removeTransferredItem(this)" class="btn-secondary ml-3 text-sm py-2 px-3">
                                            åˆ é™¤
                                        </button>
                                    </div>
                                    <div class="input-placeholder-hint">
                                        æç¤ºï¼šè¯·å¡«å†™${heir.name}çš„ç»§æ‰¿äººå§“åï¼ˆé…å¶ã€çˆ¶æ¯ã€å­å¥³ç­‰ï¼‰
                                    </div>
                                </div>
                            `).join('') : 
                            `
                            <div>
                                <div class="flex items-center">
                                    <input type="text" class="form-input flex-1" 
                                           placeholder="è¯·è¾“å…¥ç»§æ‰¿äººå§“å" data-heir-type="${heir.type}" data-heir-index="${heir.index}">
                                    <button type="button" onclick="removeTransferredItem(this)" class="btn-secondary ml-3 text-sm py-2 px-3">
                                        åˆ é™¤
                                    </button>
                                </div>
                                <div class="input-placeholder-hint">
                                    æç¤ºï¼šè¯·å¡«å†™${heir.name}çš„ç»§æ‰¿äººå§“åï¼ˆé…å¶ã€çˆ¶æ¯ã€å­å¥³ç­‰ï¼‰
                                </div>
                            </div>
                            `
                        }
                    </div>
                    
                    <button type="button" onclick="addTransferredItem('${heir.type}', ${heir.index})" class="w-full btn-secondary py-3">
                        + æ·»åŠ ç»§æ‰¿äºº
                    </button>
                `;
                
                transferredDetails.appendChild(heirDiv);
                
                // ç»‘å®šé…å¶é€‰æ‹©äº‹ä»¶ï¼ˆå¦‚æœä¸æ˜¯è¢«ç»§æ‰¿äººé…å¶ï¼‰
                if (heir.type !== 'spouse') {
                    const spouseRadios = heirDiv.querySelectorAll(`input[name="has-spouse-${heir.type}-${heir.index}"]`);
                    spouseRadios.forEach(radio => {
                        radio.addEventListener('change', function() {
                            saveHasSpouseData(heir.type, heir.index, this.value === 'yes');
                            
                            // æ˜¾ç¤º/éšè—é…å¶å¡«å†™æç¤º
                            const spouseHint = document.getElementById(`spouse-hint-${heir.type}-${heir.index}`);
                            if (spouseHint) {
                                if (this.value === 'yes') {
                                    spouseHint.classList.remove('hidden');
                                } else {
                                    spouseHint.classList.add('hidden');
                                }
                            }
                        });
                    });
                    
                    // åˆå§‹æ˜¾ç¤ºé…å¶æç¤º
                    if (heirData.hasSpouse) {
                        const spouseHint = document.getElementById(`spouse-hint-${heir.type}-${heir.index}`);
                        if (spouseHint) {
                            spouseHint.classList.remove('hidden');
                        }
                    }
                }
                
                // ç»‘å®šè¾“å…¥æ¡†äº‹ä»¶
                const inputs = heirDiv.querySelectorAll('.form-input');
                inputs.forEach((input, inputIndex) => {
                    input.addEventListener('blur', function() {
                        saveTransferredData(heir.type, heir.index, inputIndex, this.value);
                    });
                });
            });
        }
        
        // ä¿å­˜æ˜¯å¦æœ‰é…å¶ä¿¡æ¯
        function saveHasSpouseData(heirType, heirIndex, hasSpouse) {
            let heirData = null;
            
            if (heirType === 'spouse') {
                heirData = inheritanceDataV2.heirs.spouse;
            } else if (heirType === 'father') {
                heirData = inheritanceDataV2.heirs.father;
            } else if (heirType === 'mother') {
                heirData = inheritanceDataV2.heirs.mother;
            } else if (heirType === 'child') {
                heirData = inheritanceDataV2.heirs.children[heirIndex];
            }
            
            if (heirData) {
                heirData.hasSpouse = hasSpouse;
            }
        }
        
        // æ·»åŠ è½¬ç»§æ‰¿äººè¾“å…¥é¡¹
        window.addTransferredItem = function(heirType, heirIndex) {
            const container = document.getElementById(`transferred-items-${heirType}-${heirIndex}`);
            if (!container) return;
            
            const itemCount = container.children.length;
            
            const div = document.createElement('div');
            div.innerHTML = `
                <div class="flex items-center">
                    <input type="text" class="form-input flex-1" 
                           placeholder="è¯·è¾“å…¥ç»§æ‰¿äººå§“å" data-heir-type="${heirType}" data-heir-index="${heirIndex}">
                    <button type="button" onclick="removeTransferredItem(this)" class="btn-secondary ml-3 text-sm py-2 px-3">
                        åˆ é™¤
                    </button>
                </div>
                <div class="input-placeholder-hint">
                    æç¤ºï¼šè¯·å¡«å†™ç»§æ‰¿äººå§“åï¼ˆé…å¶ã€çˆ¶æ¯ã€å­å¥³ç­‰ï¼‰
                </div>
            `;
            
            container.appendChild(div);
            
            const input = div.querySelector('.form-input');
            input.addEventListener('blur', function() {
                saveTransferredData(heirType, heirIndex, Math.floor(itemCount), this.value);
            });
        }
        
        // åˆ é™¤è½¬ç»§æ‰¿äººè¾“å…¥é¡¹
        window.removeTransferredItem = function(button) {
            const container = button.closest('div');
            container.remove();
        }
        
        // ä¿å­˜è½¬ç»§æ‰¿äººæ•°æ®
        function saveTransferredData(heirType, heirIndex, itemIndex, value) {
            let heirData = null;
            
            if (heirType === 'spouse') {
                heirData = inheritanceDataV2.heirs.spouse;
            } else if (heirType === 'father') {
                heirData = inheritanceDataV2.heirs.father;
            } else if (heirType === 'mother') {
                heirData = inheritanceDataV2.heirs.mother;
            } else if (heirType === 'child') {
                heirData = inheritanceDataV2.heirs.children[heirIndex];
            }
            
            if (heirData) {
                if (!heirData.transferredTo) {
                    heirData.transferredTo = [];
                }
                
                // ç¡®ä¿æ•°ç»„é•¿åº¦è¶³å¤Ÿ
                if (itemIndex >= heirData.transferredTo.length) {
                    heirData.transferredTo.length = itemIndex + 1;
                }
                
                if (value.trim()) {
                    heirData.transferredTo[itemIndex] = {
                        name: value.trim(),
                        relationship: '' // å¯ä»¥æ‰©å±•è®°å½•å…³ç³»
                    };
                } else {
                    heirData.transferredTo[itemIndex] = undefined;
                }
                
                // æ¸…ç†ç©ºå€¼
                heirData.transferredTo = heirData.transferredTo.filter(item => item);
            }
        }
        
        // æ·»åŠ å­å¥³
        function addChild() {
            const childrenList = document.getElementById('children-list');
            if (!childrenList) return;
            
            const childIndex = childrenList.children.length;
            
            const childDiv = document.createElement('div');
            childDiv.className = 'child-item info-card border-purple-200 fade-in';
            childDiv.innerHTML = `
                <div class="flex justify-between items-start mb-6">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-100 to-purple-200 flex items-center justify-center mr-4">
                            <span class="text-lg">ğŸ‘¶</span>
                        </div>
                        <h4 class="font-bold text-xl text-purple-700">è¢«ç»§æ‰¿äººå­å¥³${childIndex + 1}</h4>
                    </div>
                    <button type="button" class="remove-child-btn btn-secondary text-sm py-2 px-3">
                        åˆ é™¤
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <label class="block font-medium mb-3 text-purple-700">å­å¥³å§“å</label>
                        <input type="text" class="child-name form-input" placeholder="è¯·è¾“å…¥å­å¥³å§“å">
                    </div>
                    <div>
                        <label class="block font-medium mb-3 text-purple-700">å­å¥³çŠ¶æ€</label>
                        <select class="child-status form-input">
                            <option value="alive">åœ¨ä¸–</option>
                            <option value="predeceased">å·²æ•…ï¼ˆåœ¨è¢«ç»§æ‰¿äººä¹‹å‰å»ä¸–ï¼‰</option>
                            <option value="postdeceased">å·²æ•…ï¼ˆåœ¨è¢«ç»§æ‰¿äººä¹‹åå»ä¸–ï¼‰</option>
                        </select>
                    </div>
                </div>
            `;
            
            childrenList.appendChild(childDiv);
            
            // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            const removeBtn = childDiv.querySelector('.remove-child-btn');
            removeBtn.addEventListener('click', function() {
                removeChild(this);
            });
            
            const nameInput = childDiv.querySelector('.child-name');
            const statusSelect = childDiv.querySelector('.child-status');
            
            nameInput.addEventListener('input', function() {
                updateChildData(childIndex);
            });
            
            statusSelect.addEventListener('change', function() {
                updateChildData(childIndex);
            });
        }
        
        // æ›´æ–°å­å¥³æ•°æ®
        function updateChildData(index) {
            const childrenItems = document.querySelectorAll('.child-item');
            if (index < childrenItems.length) {
                const child = childrenItems[index];
                const name = child.querySelector('.child-name').value.trim();
                const status = child.querySelector('.child-status').value;
                
                if (index >= inheritanceDataV2.heirs.children.length) {
                    inheritanceDataV2.heirs.children.push({
                        name: name,
                        status: status,
                        perStirpes: [],
                        transferredTo: [],
                        hasSpouse: false,
                        transferredFromSpouse: null
                    });
                } else {
                    inheritanceDataV2.heirs.children[index] = {
                        name: name,
                        status: status,
                        perStirpes: inheritanceDataV2.heirs.children[index]?.perStirpes || [],
                        transferredTo: inheritanceDataV2.heirs.children[index]?.transferredTo || [],
                        hasSpouse: inheritanceDataV2.heirs.children[index]?.hasSpouse || false,
                        transferredFromSpouse: inheritanceDataV2.heirs.children[index]?.transferredFromSpouse || null
                    };
                }
            }
        }
        
        // åˆ é™¤å­å¥³
        function removeChild(button) {
            const childDiv = button.closest('.child-item');
            const childIndex = Array.from(document.querySelectorAll('.child-item')).indexOf(childDiv);
            
            childDiv.style.opacity = '0';
            childDiv.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                childDiv.remove();
                
                if (childIndex >= 0 && childIndex < inheritanceDataV2.heirs.children.length) {
                    inheritanceDataV2.heirs.children.splice(childIndex, 1);
                }
                
                const childrenItems = document.querySelectorAll('.child-item');
                childrenItems.forEach((item, index) => {
                    const title = item.querySelector('h4');
                    if (title) {
                        title.textContent = `è¢«ç»§æ‰¿äººå­å¥³${index + 1}`;
                    }
                });
            }, 300);
        }
        
        // æ”¶é›†ç¬¬å…­æ­¥æ•°æ®
        function collectStep6Data() {
            // æ•°æ®å·²ç»åœ¨è¾“å…¥æ—¶å®æ—¶ä¿å­˜
        }
        
        // æ ¸å¿ƒè®¡ç®—å‡½æ•°
        function calculateInheritance() {
            console.log('å¼€å§‹è®¡ç®—ç»§æ‰¿...');
            
            collectStep6Data();
            
            if (!validateStep6()) {
                return;
            }
            
            try {
                const result = performAdvancedInheritanceCalculation();
                displayCalculationResult(result);
                
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep = 7;
                document.getElementById(`step${currentStep}`).classList.add('active');
                updateProgress();
                
                console.log('è®¡ç®—å®Œæˆï¼Œç»“æœæ˜¾ç¤ºåœ¨ç¬¬7æ­¥');
            } catch (error) {
                console.error('è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
                alert('è®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ•°æ®æ˜¯å¦æ­£ç¡®ã€‚é”™è¯¯ä¿¡æ¯ï¼š' + error.message);
            }
        }
        
        // é«˜çº§ç»§æ‰¿è®¡ç®— - å¢å¼ºç‰ˆæœ¬ï¼Œæ”¯æŒè½¬ç»§æ‰¿äººçš„é…å¶å…ˆåˆ†ä¸€åŠ
        function performAdvancedInheritanceCalculation() {
            const estateAmount = inheritanceDataV2.deceased.estateAmount || 0;
            const spousePersonalAmount = inheritanceDataV2.deceased.communityPropertyAmount / 2;
            
            console.log('å¼€å§‹é«˜çº§ç»§æ‰¿è®¡ç®—ï¼Œé—äº§æ€»é¢:', estateAmount);
            
            // æ­¥éª¤1: ç¡®å®šè¢«ç»§æ‰¿äººå»ä¸–æ—¶çš„ç¬¬ä¸€é¡ºåºç»§æ‰¿äººæ•°é‡
            let firstOrderHeirCount = 0;
            const firstOrderHeirs = [];
            
            // é…å¶ï¼ˆå¦‚æœåœ¨ä¸–æˆ–åå»ä¸–ï¼‰
            if (inheritanceDataV2.heirs.spouse.status === 'alive' || inheritanceDataV2.heirs.spouse.status === 'postdeceased') {
                firstOrderHeirCount++;
                firstOrderHeirs.push({
                    name: inheritanceDataV2.heirs.spouse.name,
                    type: 'è¢«ç»§æ‰¿äººé…å¶',
                    status: inheritanceDataV2.heirs.spouse.status,
                    share: 1,
                    originalShare: 1,
                    transferredTo: inheritanceDataV2.heirs.spouse.transferredTo || [],
                    hasSpouse: inheritanceDataV2.heirs.spouse.hasSpouse
                });
            }
            
            // çˆ¶äº²ï¼ˆå¦‚æœåœ¨ä¸–æˆ–åå»ä¸–ï¼‰
            if (inheritanceDataV2.heirs.father.status === 'alive' || inheritanceDataV2.heirs.father.status === 'postdeceased') {
                firstOrderHeirCount++;
                firstOrderHeirs.push({
                    name: inheritanceDataV2.heirs.father.name,
                    type: 'è¢«ç»§æ‰¿äººçˆ¶äº²',
                    status: inheritanceDataV2.heirs.father.status,
                    share: 1,
                    originalShare: 1,
                    transferredTo: inheritanceDataV2.heirs.father.transferredTo || [],
                    hasSpouse: inheritanceDataV2.heirs.father.hasSpouse,
                    isParent: true
                });
            }
            
            // æ¯äº²ï¼ˆå¦‚æœåœ¨ä¸–æˆ–åå»ä¸–ï¼‰
            if (inheritanceDataV2.heirs.mother.status === 'alive' || inheritanceDataV2.heirs.mother.status === 'postdeceased') {
                firstOrderHeirCount++;
                firstOrderHeirs.push({
                    name: inheritanceDataV2.heirs.mother.name,
                    type: 'è¢«ç»§æ‰¿äººæ¯äº²',
                    status: inheritanceDataV2.heirs.mother.status,
                    share: 1,
                    originalShare: 1,
                    transferredTo: inheritanceDataV2.heirs.mother.transferredTo || [],
                    hasSpouse: inheritanceDataV2.heirs.mother.hasSpouse,
                    isParent: true
                });
            }
            
            // å­å¥³ï¼ˆåœ¨ä¸–æˆ–åå»ä¸–ï¼‰
            inheritanceDataV2.heirs.children.forEach(child => {
                if (child.status === 'alive' || child.status === 'postdeceased') {
                    firstOrderHeirCount++;
                    firstOrderHeirs.push({
                        name: child.name,
                        type: 'è¢«ç»§æ‰¿äººå­å¥³',
                        status: child.status,
                        share: 1,
                        originalShare: 1,
                        perStirpes: child.perStirpes || [],
                        transferredTo: child.transferredTo || [],
                        hasSpouse: child.hasSpouse,
                        index: inheritanceDataV2.heirs.children.indexOf(child)
                    });
                }
            });
            
            // å…ˆå»ä¸–çš„å­å¥³ï¼ˆç”¨äºå­™è¾ˆç»§æ‰¿ï¼‰
            const predeceasedChildren = inheritanceDataV2.heirs.children.filter(child => 
                child.status === 'predeceased'
            );
            
            // æ¯ä¸ªå…ˆå»ä¸–çš„å­å¥³ä¹Ÿç®—ä¸€ä¸ªç¬¬ä¸€é¡ºåºç»§æ‰¿äºº
            predeceasedChildren.forEach(child => {
                firstOrderHeirCount++;
            });
            
            console.log('ç¬¬ä¸€é¡ºåºç»§æ‰¿äººæ€»æ•°:', firstOrderHeirCount);
            
            if (firstOrderHeirCount === 0) {
                return {
                    heirs: [],
                    totalShares: 0,
                    estateAmount: estateAmount,
                    spousePersonalAmount: spousePersonalAmount,
                    communityPropertyAmount: inheritanceDataV2.deceased.communityPropertyAmount,
                    propertyType: inheritanceDataV2.deceased.propertyType,
                    hasComplexCase: false,
                    notes: ['æ²¡æœ‰ç¬¬ä¸€é¡ºåºç»§æ‰¿äººï¼Œåº”è€ƒè™‘ç¬¬äºŒé¡ºåºç»§æ‰¿äººï¼ˆå…„å¼Ÿå§å¦¹ã€ç¥–çˆ¶æ¯ã€å¤–ç¥–çˆ¶æ¯ï¼‰']
                };
            }
            
            // æ­¥éª¤2: è®¡ç®—æ¯ä¸ªç¬¬ä¸€é¡ºåºç»§æ‰¿äººçš„ä»½é¢
            const sharePerHeir = 1 / firstOrderHeirCount;
            
            // æ›´æ–°ä»½é¢
            firstOrderHeirs.forEach(heir => {
                heir.share = sharePerHeir;
                heir.originalShare = sharePerHeir;
            });
            
            // æ­¥éª¤3: å¤„ç†å­™è¾ˆç»§æ‰¿
            const perStirpesHeirs = [];
            predeceasedChildren.forEach(child => {
                const childShare = sharePerHeir;
                
                if (child.perStirpes && child.perStirpes.length > 0) {
                    const sharePerSuccessor = childShare / child.perStirpes.length;
                    
                    child.perStirpes.forEach(successor => {
                        perStirpesHeirs.push({
                            name: successor,
                            type: 'å­™è¾ˆ',
                            share: sharePerSuccessor,
                            details: [`ç»§æ‰¿ ${child.name} çš„ä»½é¢ï¼ˆä»£ä½ç»§æ‰¿ï¼‰`]
                        });
                    });
                }
            });
            
            // æ­¥éª¤4: åˆ›å»ºåˆå§‹ä»½é¢æ˜ å°„è¡¨
            let shareMap = new Map();
            
            // æ·»åŠ ç¬¬ä¸€é¡ºåºç»§æ‰¿äººä»½é¢
            firstOrderHeirs.forEach(heir => {
                shareMap.set(heir.name, {
                    name: heir.name,
                    type: heir.type,
                    share: heir.share,
                    details: [`ç¬¬ä¸€é¡ºåºç»§æ‰¿äºº: ${heir.share.toFixed(4)} ä»½é¢`],
                    status: heir.status,
                    transferredTo: heir.transferredTo || [],
                    hasSpouse: heir.hasSpouse,
                    isParent: heir.isParent || false
                });
            });
            
            // æ·»åŠ å­™è¾ˆä»½é¢
            perStirpesHeirs.forEach(heir => {
                if (shareMap.has(heir.name)) {
                    // åˆå¹¶ä»½é¢ï¼ˆå¦‚æœè¯¥ç»§æ‰¿äººåŒæ—¶ä¹Ÿæ˜¯å…¶ä»–èº«ä»½ï¼‰
                    const existing = shareMap.get(heir.name);
                    existing.share += heir.share;
                    existing.details.push(heir.details[0]);
                } else {
                    shareMap.set(heir.name, heir);
                }
            });
            
            // æ­¥éª¤5: æŒ‰é¡ºåºå¤„ç†è½¬ç»§æ‰¿ï¼ˆæ”¯æŒè½¬ç»§æ‰¿äººçš„é…å¶å…ˆåˆ†ä¸€åŠï¼‰
            const sortedPostdeceased = [...inheritanceDataV2.postdeceasedOrder].sort((a, b) => {
                const orderA = a.order || 0;
                const orderB = b.order || 0;
                return orderA - orderB; // ä»æœ€å…ˆå»ä¸–çš„å¼€å§‹
            });
            
            // å¤„ç†çˆ¶æ¯ç›¸äº’ç»§æ‰¿çš„ç‰¹æ®Šæƒ…å†µ
            if (inheritanceDataV2.parentsDeathOrder) {
                console.log('çˆ¶æ¯ç›¸äº’ç»§æ‰¿æƒ…å†µ:', inheritanceDataV2.parentsDeathOrder);
                
                // æ‰¾åˆ°çˆ¶äº²å’Œæ¯äº²çš„é¡ºåº
                const fatherIndex = sortedPostdeceased.findIndex(h => h.type === 'father');
                const motherIndex = sortedPostdeceased.findIndex(h => h.type === 'mother');
                
                if (fatherIndex !== -1 && motherIndex !== -1) {
                    if (inheritanceDataV2.parentsDeathOrder === 'father-first') {
                        // çˆ¶äº²å…ˆå»ä¸–ï¼Œæ¯äº²åå»ä¸–
                        console.log('çˆ¶äº²å…ˆäºæ¯äº²å»ä¸–');
                        // çˆ¶äº²çš„ä»½é¢å…ˆåˆ†ä¸€åŠç»™æ¯äº²ï¼Œå‰©ä½™ä¸€åŠè½¬ç»§æ‰¿
                        // æ¯äº²çš„ä»½é¢ï¼ˆåŒ…æ‹¬ä»çˆ¶äº²å¤„ç»§æ‰¿çš„ï¼‰å…¨éƒ¨è½¬ç»§æ‰¿
                        shareMap = processParentsMutualInheritance(shareMap, 'father', 'mother', sortedPostdeceased);
                    } else if (inheritanceDataV2.parentsDeathOrder === 'mother-first') {
                        // æ¯äº²å…ˆå»ä¸–ï¼Œçˆ¶äº²åå»ä¸–
                        console.log('æ¯äº²å…ˆäºçˆ¶äº²å»ä¸–');
                        // æ¯äº²çš„ä»½é¢å…ˆåˆ†ä¸€åŠç»™çˆ¶äº²ï¼Œå‰©ä½™ä¸€åŠè½¬ç»§æ‰¿
                        // çˆ¶äº²çš„ä»½é¢ï¼ˆåŒ…æ‹¬ä»æ¯äº²å¤„ç»§æ‰¿çš„ï¼‰å…¨éƒ¨è½¬ç»§æ‰¿
                        shareMap = processParentsMutualInheritance(shareMap, 'mother', 'father', sortedPostdeceased);
                    }
                }
            } else {
                // æ­£å¸¸è½¬ç»§æ‰¿å¤„ç†
                shareMap = processEnhancedTransfers(shareMap, sortedPostdeceased);
            }
            
            // æ­¥éª¤6: æ•´åˆåŒåç»§æ‰¿äººçš„ä»½é¢
            const heirsArray = consolidateSameNameHeirs(Array.from(shareMap.values()));
            
            // æ­¥éª¤7: è®¡ç®—ç™¾åˆ†æ¯”å’Œé‡‘é¢
            const totalShares = heirsArray.reduce((sum, heir) => sum + heir.share, 0);
            
            const result = heirsArray.map(heir => {
                const amount = estateAmount * heir.share;
                
                // å°†ä»½é¢è½¬æ¢ä¸ºåˆ†æ•°å½¢å¼ï¼ˆå‡ åˆ†ä¹‹å‡ ï¼‰
                const fraction = convertToFraction(heir.share, totalShares);
                
                return {
                    ...heir,
                    fraction: fraction,
                    amount: parseFloat(amount.toFixed(2)),
                    totalShare: heir.share
                };
            });
            
            // ç”Ÿæˆè¯´æ˜
            const notes = generateEnhancedCalculationNotes(firstOrderHeirCount, predeceasedChildren.length, sortedPostdeceased.length);
            
            return {
                heirs: result,
                totalShares: totalShares,
                estateAmount: estateAmount,
                spousePersonalAmount: spousePersonalAmount,
                communityPropertyAmount: inheritanceDataV2.deceased.communityPropertyAmount,
                propertyType: inheritanceDataV2.deceased.propertyType,
                hasComplexCase: inheritanceDataV2.postdeceasedOrder.length > 0 || predeceasedChildren.length > 0,
                notes: notes,
                hasTransfers: inheritanceDataV2.postdeceasedOrder.length > 0,
                hasPerStirpes: predeceasedChildren.length > 0
            };
        }
        
        // å°†å°æ•°è½¬æ¢ä¸ºåˆ†æ•°å½¢å¼
        function convertToFraction(decimal, totalShares) {
            // å¦‚æœä»½é¢æ˜¯1æˆ–0ï¼Œç›´æ¥è¿”å›
            if (decimal === 1) return "1/1";
            if (decimal === 0) return "0";
            
            // å°è¯•è½¬æ¢ä¸ºåˆ†æ•°
            const tolerance = 0.0001;
            let numerator = 1;
            let denominator = 1;
            let fraction = numerator / denominator;
            
            // æŸ¥æ‰¾æœ€æ¥è¿‘çš„åˆ†æ•°
            while (Math.abs(fraction - decimal) > tolerance && denominator < 100) {
                if (fraction < decimal) {
                    numerator++;
                } else {
                    denominator++;
                    numerator = Math.round(decimal * denominator);
                }
                fraction = numerator / denominator;
            }
            
            // ç®€åŒ–åˆ†æ•°
            const gcd = greatestCommonDivisor(numerator, denominator);
            numerator = numerator / gcd;
            denominator = denominator / gcd;
            
            return `${numerator}/${denominator}`;
        }
        
        // è®¡ç®—æœ€å¤§å…¬çº¦æ•°
        function greatestCommonDivisor(a, b) {
            if (b === 0) return a;
            return greatestCommonDivisor(b, a % b);
        }
        
        // å¤„ç†çˆ¶æ¯ç›¸äº’ç»§æ‰¿çš„ç‰¹æ®Šæƒ…å†µ
        function processParentsMutualInheritance(shareMap, firstParent, secondParent, sortedPostdeceased) {
            const firstParentName = inheritanceDataV2.heirs[firstParent].name;
            const secondParentName = inheritanceDataV2.heirs[secondParent].name;
            
            // è·å–å…ˆå»ä¸–ä¸€æ–¹çš„ä»½é¢
            const firstParentShare = shareMap.get(firstParentName)?.share || 0;
            
            if (firstParentShare > 0) {
                // 1. å…ˆå»ä¸–ä¸€æ–¹çš„ä»½é¢ï¼Œä¸€åŠå½’åœ¨ä¸–é…å¶ï¼ˆå¦ä¸€æ–¹ï¼‰
                const shareToSecondParent = firstParentShare * 0.5;
                
                // åœ¨ä¸–é…å¶è·å¾—è¿™ä¸€åŠä»½é¢
                const sourceText = `ç»§æ‰¿${firstParentName}çš„ä¸€åŠä»½é¢`;
                if (shareMap.has(secondParentName)) {
                    const existing = shareMap.get(secondParentName);
                    existing.share += shareToSecondParent;
                    existing.details.push(sourceText);
                } else {
                    shareMap.set(secondParentName, {
                        name: secondParentName,
                        type: secondParent === 'father' ? 'è¢«ç»§æ‰¿äººçˆ¶äº²' : 'è¢«ç»§æ‰¿äººæ¯äº²',
                        share: shareToSecondParent,
                        details: [sourceText]
                    });
                }
                
                // 2. å‰©ä½™ä¸€åŠä»½é¢è½¬ç»§æ‰¿
                const remainingShare = firstParentShare * 0.5;
                const firstParentData = inheritanceDataV2.heirs[firstParent];
                
                if (firstParentData.transferredTo && firstParentData.transferredTo.length > 0) {
                    const sharePerTransferee = remainingShare / firstParentData.transferredTo.length;
                    
                    firstParentData.transferredTo.forEach(transferee => {
                        const transfereeName = transferee.name;
                        const sourceText = `è½¬ç»§æ‰¿${firstParentName}çš„å‰©ä½™ä»½é¢: ${sharePerTransferee.toFixed(4)} ä»½é¢`;
                        
                        if (shareMap.has(transfereeName)) {
                            const existing = shareMap.get(transfereeName);
                            existing.share += sharePerTransferee;
                            existing.details.push(sourceText);
                        } else {
                            shareMap.set(transfereeName, {
                                name: transfereeName,
                                type: 'è½¬ç»§æ‰¿äºº',
                                share: sharePerTransferee,
                                details: [sourceText]
                            });
                        }
                    });
                }
                
                // 3. ä»ç»§æ‰¿åœ°å›¾ä¸­ç§»é™¤å…ˆå»ä¸–ä¸€æ–¹
                shareMap.delete(firstParentName);
            }
            
            // 4. åå»ä¸–ä¸€æ–¹ï¼ˆåœ¨ä¸–é…å¶ï¼‰å»ä¸–æ—¶ï¼Œå…¶å…¨éƒ¨ä»½é¢ï¼ˆåŒ…æ‹¬ä»å…ˆå»ä¸–ä¸€æ–¹ç»§æ‰¿çš„ï¼‰è½¬ç»§æ‰¿
            // è¿™éƒ¨åˆ†é€šè¿‡æ­£å¸¸çš„è½¬ç»§æ‰¿å¤„ç†
            shareMap = processEnhancedTransfers(shareMap, sortedPostdeceased.filter(h => h.type !== firstParent));
            
            return shareMap;
        }
        
        // å¢å¼ºçš„è½¬ç»§æ‰¿å¤„ç†ï¼ˆæ”¯æŒè½¬ç»§æ‰¿äººçš„é…å¶å…ˆåˆ†ä¸€åŠï¼‰
        function processEnhancedTransfers(shareMap, sortedPostdeceased) {
            // æŒ‰é¡ºåºå¤„ç†æ¯ä¸ªåå»ä¸–ç»§æ‰¿äºº
            sortedPostdeceased.forEach((postdeceasedHeir, index) => {
                const heirName = postdeceasedHeir.name;
                
                if (shareMap.has(heirName)) {
                    const heirData = shareMap.get(heirName);
                    let heirShare = heirData.share;
                    
                    // è·å–è½¬ç»§æ‰¿äºº
                    let transferredTo = [];
                    if (postdeceasedHeir.type === 'spouse') {
                        transferredTo = inheritanceDataV2.heirs.spouse.transferredTo || [];
                    } else if (postdeceasedHeir.type === 'father') {
                        transferredTo = inheritanceDataV2.heirs.father.transferredTo || [];
                    } else if (postdeceasedHeir.type === 'mother') {
                        transferredTo = inheritanceDataV2.heirs.mother.transferredTo || [];
                    } else if (postdeceasedHeir.type === 'child') {
                        transferredTo = inheritanceDataV2.heirs.children[postdeceasedHeir.index].transferredTo || [];
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰é…å¶ï¼ˆè¢«ç»§æ‰¿äººé…å¶ä¸éœ€è¦æ£€æŸ¥ï¼‰
                    const hasSpouse = heirData.hasSpouse && postdeceasedHeir.type !== 'spouse';
                    
                    if (transferredTo.length > 0) {
                        let sharePerTransferee;
                        
                        if (hasSpouse && transferredTo.length > 1) {
                            // æœ‰é…å¶çš„æƒ…å†µï¼šå…ˆåˆ†ä¸€åŠç»™é…å¶ï¼Œå‰©ä½™çš„ä¸€åŠç”±æ‰€æœ‰ç»§æ‰¿äººï¼ˆåŒ…æ‹¬é…å¶ï¼‰å¹³åˆ†
                            const spouseShare = heirShare * 0.5;
                            const remainingShare = heirShare * 0.5;
                            sharePerTransferee = remainingShare / transferredTo.length;
                            
                            // é…å¶å…ˆå¾—åˆ°ä¸€åŠï¼ˆå‡è®¾é…å¶æ˜¯ç¬¬ä¸€ä¸ªè½¬ç»§æ‰¿äººï¼‰
                            const spouseName = transferredTo[0]?.name || '';
                            if (spouseName) {
                                const spouseSourceText = `ä½œä¸º ${heirName} çš„é…å¶ï¼Œå…ˆåˆ†å¾—ä¸€åŠ: ${spouseShare.toFixed(4)} ä»½é¢`;
                                
                                if (shareMap.has(spouseName)) {
                                    const existing = shareMap.get(spouseName);
                                    existing.share += spouseShare;
                                    existing.details.push(spouseSourceText);
                                } else {
                                    shareMap.set(spouseName, {
                                        name: spouseName,
                                        type: 'è½¬ç»§æ‰¿äºº',
                                        share: spouseShare,
                                        details: [spouseSourceText]
                                    });
                                }
                                
                                // å‰©ä½™çš„ä¸€åŠç”±æ‰€æœ‰ç»§æ‰¿äººï¼ˆåŒ…æ‹¬é…å¶ï¼‰å¹³åˆ†
                                transferredTo.forEach(transferee => {
                                    const transfereeName = transferee.name;
                                    const sourceText = `ç»§æ‰¿ ${heirName} çš„å‰©ä½™ä»½é¢: ${sharePerTransferee.toFixed(4)} ä»½é¢`;
                                    
                                    if (shareMap.has(transfereeName)) {
                                        const existing = shareMap.get(transfereeName);
                                        existing.share += sharePerTransferee;
                                        existing.details.push(sourceText);
                                    } else {
                                        shareMap.set(transfereeName, {
                                            name: transfereeName,
                                            type: 'è½¬ç»§æ‰¿äºº',
                                            share: sharePerTransferee,
                                            details: [sourceText]
                                        });
                                    }
                                });
                            }
                        } else {
                            // æ²¡æœ‰é…å¶æˆ–åªæœ‰ä¸€ä¸ªç»§æ‰¿äººï¼šç›´æ¥å¹³åˆ†
                            sharePerTransferee = heirShare / transferredTo.length;
                            
                            transferredTo.forEach(transferee => {
                                const transfereeName = transferee.name;
                                const sourceText = `ç»§æ‰¿ ${heirName} çš„ä»½é¢: ${sharePerTransferee.toFixed(4)} ä»½é¢`;
                                
                                if (shareMap.has(transfereeName)) {
                                    const existing = shareMap.get(transfereeName);
                                    existing.share += sharePerTransferee;
                                    existing.details.push(sourceText);
                                } else {
                                    shareMap.set(transfereeName, {
                                        name: transfereeName,
                                        type: 'è½¬ç»§æ‰¿äºº',
                                        share: sharePerTransferee,
                                        details: [sourceText]
                                    });
                                }
                            });
                        }
                        
                        // ä»ç»§æ‰¿åœ°å›¾ä¸­ç§»é™¤è¯¥ç»§æ‰¿äºº
                        shareMap.delete(heirName);
                    }
                }
            });
            
            return shareMap;
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®å§“åè·å–ç»§æ‰¿äººç±»å‹
        function getHeirTypeByName(name) {
            if (inheritanceDataV2.heirs.spouse.name === name) return 'è¢«ç»§æ‰¿äººé…å¶';
            if (inheritanceDataV2.heirs.father.name === name) return 'è¢«ç»§æ‰¿äººçˆ¶äº²';
            if (inheritanceDataV2.heirs.mother.name === name) return 'è¢«ç»§æ‰¿äººæ¯äº²';
            
            const child = inheritanceDataV2.heirs.children.find(child => child.name === name);
            if (child) return 'è¢«ç»§æ‰¿äººå­å¥³';
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å­™è¾ˆ
            for (let child of inheritanceDataV2.heirs.children) {
                if (child.perStirpes && child.perStirpes.includes(name)) {
                    return 'å­™è¾ˆ';
                }
            }
            
            return 'è½¬ç»§æ‰¿äºº';
        }
        
        // æ•´åˆåŒåç»§æ‰¿äººçš„ä»½é¢
        function consolidateSameNameHeirs(heirsArray) {
            const consolidatedMap = new Map();
            
            heirsArray.forEach(heir => {
                if (consolidatedMap.has(heir.name)) {
                    const existing = consolidatedMap.get(heir.name);
                    existing.share += heir.share;
                    // åˆå¹¶è¯¦ç»†è¯´æ˜
                    if (heir.details) {
                        existing.details = [...existing.details, ...heir.details];
                    }
                    // ä¿ç•™ä¸»è¦çš„ç±»å‹ï¼ˆå¦‚æœæœ‰å¤šä¸ªç±»å‹ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
                    const typePriority = {
                        'è¢«ç»§æ‰¿äººé…å¶': 1,
                        'è¢«ç»§æ‰¿äººçˆ¶äº²': 2,
                        'è¢«ç»§æ‰¿äººæ¯äº²': 3,
                        'è¢«ç»§æ‰¿äººå­å¥³': 4,
                        'å­™è¾ˆ': 5,
                        'è½¬ç»§æ‰¿äºº': 6,
                        'å…¶ä»–ç»§æ‰¿äºº': 7
                    };
                    
                    if (typePriority[heir.type] < typePriority[existing.type]) {
                        existing.type = heir.type;
                    }
                } else {
                    consolidatedMap.set(heir.name, {
                        ...heir,
                        details: [...(heir.details || [])] // åˆ›å»ºå‰¯æœ¬
                    });
                }
            });
            
            // æŒ‰ä»½é¢æ’åº
            const result = Array.from(consolidatedMap.values())
                .sort((a, b) => b.share - a.share);
            
            return result;
        }
        
        // ç”Ÿæˆå¢å¼ºç‰ˆè®¡ç®—è¯´æ˜
        function generateEnhancedCalculationNotes(firstOrderCount, predeceasedCount, postdeceasedCount) {
            const notes = [];
            
            notes.push(`ç¬¬ä¸€é¡ºåºç»§æ‰¿äººæ€»æ•°: ${firstOrderCount}äºº`);
            
            if (predeceasedCount > 0) {
                notes.push(`ä»£ä½ç»§æ‰¿: ${predeceasedCount}åå­å¥³å…ˆäºè¢«ç»§æ‰¿äººå»ä¸–ï¼Œç”±å…¶å­å¥³ï¼ˆå­™è¾ˆï¼‰ç»§æ‰¿`);
            }
            
            if (postdeceasedCount > 0) {
                notes.push(`è½¬ç»§æ‰¿: ${postdeceasedCount}åç»§æ‰¿äººåœ¨è¢«ç»§æ‰¿äººä¹‹åå»ä¸–`);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰è½¬ç»§æ‰¿äººæœ‰é…å¶
                let hasSpouseInTransfers = false;
                inheritanceDataV2.postdeceasedOrder.forEach(heir => {
                    let heirData = null;
                    if (heir.type === 'spouse') {
                        heirData = inheritanceDataV2.heirs.spouse;
                    } else if (heir.type === 'father') {
                        heirData = inheritanceDataV2.heirs.father;
                    } else if (heir.type === 'mother') {
                        heirData = inheritanceDataV2.heirs.mother;
                    } else if (heir.type === 'child') {
                        heirData = inheritanceDataV2.heirs.children[heir.index];
                    }
                    
                    if (heirData && heirData.hasSpouse && heir.type !== 'spouse') {
                        hasSpouseInTransfers = true;
                    }
                });
                
                if (hasSpouseInTransfers) {
                    notes.push(`è½¬ç»§æ‰¿ä¸­çš„é…å¶æƒç›Š: æœ‰é…å¶çš„è½¬ç»§æ‰¿äººï¼ˆé™¤è¢«ç»§æ‰¿äººé…å¶å¤–ï¼‰ï¼Œå…¶ç»§æ‰¿ä»½é¢å…ˆåˆ†ä¸€åŠç»™é…å¶ï¼Œå‰©ä½™ä¸€åŠç”±æ‰€æœ‰ç»§æ‰¿äººå¹³åˆ†`);
                }
                
                // çˆ¶æ¯ç›¸äº’ç»§æ‰¿çš„æƒ…å†µ
                if (inheritanceDataV2.parentsDeathOrder) {
                    if (inheritanceDataV2.parentsDeathOrder === 'father-first') {
                        notes.push(`çˆ¶æ¯ç›¸äº’ç»§æ‰¿: çˆ¶äº²å…ˆäºæ¯äº²å»ä¸–ï¼Œçˆ¶äº²çš„ç»§æ‰¿ä»½é¢å…ˆåˆ†ä¸€åŠç»™æ¯äº²ï¼Œå‰©ä½™ä¸€åŠè½¬ç»§æ‰¿ï¼›æ¯äº²å»ä¸–åï¼Œå…¶å…¨éƒ¨ä»½é¢ï¼ˆåŒ…æ‹¬ä»çˆ¶äº²å¤„ç»§æ‰¿çš„ï¼‰è½¬ç»§æ‰¿`);
                    } else if (inheritanceDataV2.parentsDeathOrder === 'mother-first') {
                        notes.push(`çˆ¶æ¯ç›¸äº’ç»§æ‰¿: æ¯äº²å…ˆäºçˆ¶äº²å»ä¸–ï¼Œæ¯äº²çš„ç»§æ‰¿ä»½é¢å…ˆåˆ†ä¸€åŠç»™çˆ¶äº²ï¼Œå‰©ä½™ä¸€åŠè½¬ç»§æ‰¿ï¼›çˆ¶äº²å»ä¸–åï¼Œå…¶å…¨éƒ¨ä»½é¢ï¼ˆåŒ…æ‹¬ä»æ¯äº²å¤„ç»§æ‰¿çš„ï¼‰è½¬ç»§æ‰¿`);
                    }
                }
            }
            
            if (inheritanceDataV2.heirs.spouse.status === 'alive') {
                notes.push(`å¤«å¦»å…±åŒè´¢äº§å·²åˆ†å‡ºä¸€åŠå½’é…å¶ï¼ˆä¸ªäººè´¢äº§ï¼Œä¸å±äºé—äº§ï¼‰`);
            }
            
            if (firstOrderCount === 0) {
                notes.push(`æ²¡æœ‰ç¬¬ä¸€é¡ºåºç»§æ‰¿äººï¼Œåº”è€ƒè™‘ç¬¬äºŒé¡ºåºç»§æ‰¿äººï¼ˆå…„å¼Ÿå§å¦¹ã€ç¥–çˆ¶æ¯ã€å¤–ç¥–çˆ¶æ¯ï¼‰`);
            }
            
            notes.push(`åŒåç»§æ‰¿äººçš„æ‰€æœ‰ä»½é¢å·²è‡ªåŠ¨åˆå¹¶`);
            
            return notes;
        }
        
        // ç»˜åˆ¶ç»§æ‰¿ä»½é¢å›¾è¡¨
        function drawInheritanceChart(heirs) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.id = 'inheritance-chart-container';
            
            // é¢œè‰²æ•°ç»„
            const colors = [
                '#3b82f6', '#1d4ed8', '#60a5fa', '#93c5fd', // è“è‰²ç³»
                '#10b981', '#059669', '#34d399', '#6ee7b7', // ç»¿è‰²ç³»
                '#f59e0b', '#d97706', '#fbbf24', '#fcd34d', // é»„è‰²ç³»
                '#ef4444', '#dc2626', '#f87171', '#fca5a5'  // çº¢è‰²ç³»
            ];
            
            // æ‰¾åˆ°æœ€å¤§é‡‘é¢ï¼Œç”¨äºè®¡ç®—æŸ±çŠ¶å›¾é«˜åº¦
            const maxAmount = Math.max(...heirs.map(h => h.amount));
            const containerHeight = 320;
            const containerWidth = Math.min(800, heirs.length * 80);
            
            // è®¾ç½®å®¹å™¨å°ºå¯¸
            chartContainer.style.width = containerWidth + 'px';
            chartContainer.style.height = containerHeight + 'px';
            
            heirs.forEach((heir, index) => {
                const barHeight = (heir.amount / maxAmount) * (containerHeight - 80);
                const barWidth = Math.min(60, (containerWidth / heirs.length) - 12);
                const leftPosition = index * (barWidth + 12) + 12;
                const colorIndex = index % colors.length;
                
                const barDiv = document.createElement('div');
                barDiv.className = 'chart-bar';
                barDiv.style.width = `${barWidth}px`;
                barDiv.style.height = `${barHeight}px`;
                barDiv.style.left = `${leftPosition}px`;
                barDiv.style.background = `linear-gradient(to top, ${colors[colorIndex]}, ${darkenColor(colors[colorIndex], 20)})`;
                barDiv.title = `${heir.name}: Â¥${formatNumber(heir.amount)} (${heir.fraction})`;
                
                // æ·»åŠ å€¼æ ‡ç­¾
                const valueLabel = document.createElement('div');
                valueLabel.className = 'chart-value';
                valueLabel.textContent = `${heir.fraction}`;
                valueLabel.style.color = colors[colorIndex];
                barDiv.appendChild(valueLabel);
                
                // æ·»åŠ åç§°æ ‡ç­¾
                const nameLabel = document.createElement('div');
                nameLabel.className = 'chart-label';
                nameLabel.textContent = heir.name.length > 6 ? heir.name.substring(0, 6) + '...' : heir.name;
                barDiv.appendChild(nameLabel);
                
                chartContainer.appendChild(barDiv);
                
                // æ·»åŠ æ‚¬åœæ•ˆæœ
                barDiv.addEventListener('mouseenter', function() {
                    this.style.background = `linear-gradient(to top, ${darkenColor(colors[colorIndex], 20)}, ${darkenColor(colors[colorIndex], 40)})`;
                });
                
                barDiv.addEventListener('mouseleave', function() {
                    this.style.background = `linear-gradient(to top, ${colors[colorIndex]}, ${darkenColor(colors[colorIndex], 20)})`;
                });
            });
            
            return chartContainer;
        }
        
        // åŠ æ·±é¢œè‰²
        function darkenColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;
            
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + 
                         (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + 
                         (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }
        
        // æ˜¾ç¤ºè®¡ç®—ç»“æœ - ä¿®æ”¹è¡¨æ ¼ç»“æ„ä»¥åŒ¹é…ç¬¬äºŒä¸ªæ–‡ä»¶
        function displayCalculationResult(result) {
            const resultDiv = document.getElementById('calculation-result');
            if (!resultDiv) return;
            
            let html = '';
            
            // æ˜¾ç¤ºæ‘˜è¦
            html += `
                <div class="info-card border-green-400 bg-gradient-to-br from-green-50 to-emerald-50">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-100 to-green-200 flex items-center justify-center mr-4">
                            <span class="text-2xl">âœ…</span>
                        </div>
                        <div>
                            <h3 class="font-bold text-xl text-green-800">è®¡ç®—å®Œæˆï¼</h3>
                            <p class="text-green-700">å…±è¯†åˆ«å‡º <strong class="text-2xl text-green-900">${result.heirs.length}</strong> åç»§æ‰¿äººï¼Œé—äº§æ€»é¢ä¸º <strong class="text-2xl text-green-900">Â¥${formatNumber(result.estateAmount)}</strong>ã€‚</p>
                        </div>
                    </div>
                    ${result.hasComplexCase ? 
                        '<p class="text-green-700 text-lg border-t border-green-300 pt-4">ğŸ“‹ æœ¬æ¬¡è®¡ç®—æ¶‰åŠä»£ä½ç»§æ‰¿ã€è½¬ç»§æ‰¿ç­‰å¤æ‚æƒ…å†µï¼Œå·²æŒ‰ç…§ã€Šæ°‘æ³•å…¸ã€‹è§„å®šå¤„ç†ã€‚</p>' : 
                        ''
                    }
                </div>
            `;
            
            // æ˜¾ç¤ºé…å¶ä¸ªäººè´¢äº§ï¼ˆå¦‚æœæœ‰ï¼‰
            if (result.spousePersonalAmount > 0 && inheritanceDataV2.heirs.spouse.status === 'alive') {
                html += `
                    <div class="info-card border-blue-400 bg-gradient-to-br from-blue-50 to-blue-100">
                        <div class="flex items-center mb-6">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center mr-4">
                                <span class="text-2xl">ğŸ‘¤</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-xl text-blue-800">é…å¶ä¸ªäººè´¢äº§</h3>
                                <p class="text-blue-700">å¤«å¦»å…±åŒè´¢äº§çš„ä¸€åŠå½’é…å¶æ‰€æœ‰ï¼Œä¸å±äºé—äº§</p>
                            </div>
                        </div>
                        <div class="p-6 rounded-xl border border-blue-300 bg-white">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="text-lg font-bold text-blue-700">é…å¶ï¼š${inheritanceDataV2.heirs.spouse.name}</div>
                                    <div class="text-sm text-blue-600">è·å¾—å¤«å¦»å…±åŒè´¢äº§çš„ä¸€åŠ</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold text-green-700">Â¥${formatNumber(result.spousePersonalAmount)}</div>
                                    <div class="text-sm text-blue-600">ä¸ªäººè´¢äº§ï¼ˆéé—äº§ï¼‰</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºé—äº§æ€»é¢
            html += `
                <div class="info-card border-gray-400 bg-gradient-to-br from-gray-50 to-gray-100">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-xl font-bold text-gray-800">é—äº§æ€»é¢</div>
                            <div class="text-gray-600">å¯ç”¨äºç»§æ‰¿åˆ†é…çš„è´¢äº§æ€»é¢</div>
                        </div>
                        <div class="text-right">
                            <div class="text-4xl font-bold text-gray-900">Â¥${formatNumber(result.estateAmount)}</div>
                            ${result.propertyType === 'community' ? 
                                `<div class="text-gray-600">(å¤«å¦»å…±åŒè´¢äº§ä¸€åŠ + ä¸ªäººè´¢äº§)</div>` : 
                                `<div class="text-gray-600">(å…¨éƒ¨ä¸ºä¸ªäººè´¢äº§)</div>`
                            }
                        </div>
                    </div>
                </div>
            `;
            
            // å¦‚æœæœ‰å¤æ‚æƒ…å†µï¼Œæ˜¾ç¤ºè¯´æ˜
            if (result.hasComplexCase) {
                html += `
                    <div class="info-card border-yellow-400 bg-gradient-to-br from-yellow-50 to-amber-50">
                        <div class="flex items-center mb-6">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-100 to-yellow-200 flex items-center justify-center mr-4">
                                <span class="text-2xl">ğŸ“Š</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-xl text-yellow-800">å¤æ‚ç»§æ‰¿æƒ…å†µè¯´æ˜</h3>
                            </div>
                        </div>
                        <div class="space-y-3">
                            ${result.notes.map(note => `
                                <div class="flex items-start">
                                    <div class="w-2 h-2 rounded-full bg-yellow-500 mt-2 mr-3"></div>
                                    <div class="text-yellow-700">${note}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºå›¾è¡¨
            if (result.heirs.length > 0) {
                html += `
                    <div class="info-card">
                        <h3 class="text-xl font-bold mb-6 text-blue-800">ğŸ“Š é—äº§åˆ†é…å¯è§†åŒ–</h3>
                        <div id="chart-container-placeholder" class="chart-container"></div>
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºè¯¦ç»†ç»“æœè¡¨æ ¼
            if (result.heirs.length > 0) {
                html += `
                    <div class="info-card">
                        <h3 class="text-xl font-bold mb-6 text-blue-800">ğŸ“‹ é—äº§åˆ†é…ç»“æœ</h3>
                        <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gradient-to-r from-blue-50 to-blue-100">
                                    <tr>
                                        <th scope="col" class="px-8 py-4 text-left text-sm font-bold text-blue-700 uppercase tracking-wider">ç»§æ‰¿äºº</th>
                                        <th scope="col" class="px-8 py-4 text-left text-sm font-bold text-blue-700 uppercase tracking-wider">ç»§æ‰¿ä»½é¢</th>
                                        <th scope="col" class="px-8 py-4 text-left text-sm font-bold text-blue-700 uppercase tracking-wider">ç»§æ‰¿æ¯”ä¾‹</th>
                                        <th scope="col" class="px-8 py-4 text-left text-sm font-bold text-blue-700 uppercase tracking-wider">ç»§æ‰¿é‡‘é¢</th>
                                        <th scope="col" class="px-8 py-4 text-left text-sm font-bold text-blue-700 uppercase tracking-wider">ä»½é¢æ¥æº</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                let totalAmount = 0;
                
                result.heirs.forEach(heir => {
                    totalAmount += heir.amount;
                    
                    // æ ¼å¼åŒ–ä»½é¢æ¥æº
                    const sources = heir.details || [];
                    const sourcesHtml = sources.map(source => 
                        `<div class="share-source-item">${source}</div>`
                    ).join('');
                    
                    html += `
                        <tr class="hover:bg-blue-50 transition-colors duration-200">
                            <td class="px-8 py-4 whitespace-nowrap">
                                <div class="font-bold text-lg text-gray-900">${heir.name}</div>
                                <div class="text-sm text-gray-500">${heir.type}</div>
                            </td>
                            <td class="px-8 py-4 whitespace-nowrap text-lg font-medium text-gray-700">
                                ${heir.totalShare.toFixed(4)}ä»½
                            </td>
                            <td class="px-8 py-4 whitespace-nowrap text-lg font-bold text-blue-700">
                                ${heir.fraction}
                            </td>
                            <td class="px-8 py-4 whitespace-nowrap text-lg font-bold text-green-700">
                                Â¥${heir.amount.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                            </td>
                            <td class="px-8 py-4 text-sm text-gray-600">
                                <div class="share-source">
                                    ${sourcesHtml}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                // æ·»åŠ æ€»è®¡è¡Œ
                html += `
                                </tbody>
                                <tfoot class="bg-gradient-to-r from-gray-50 to-gray-100 font-bold">
                                    <tr>
                                        <td colspan="2" class="px-8 py-4 text-right text-lg text-gray-800">æ€»è®¡</td>
                                        <td class="px-8 py-4 text-lg text-gray-800">${result.totalShares.toFixed(4)}ä»½</td>
                                        <td class="px-8 py-4 text-lg text-gray-800">1/1</td>
                                        <td class="px-8 py-4 text-2xl text-green-800">
                                            Â¥${totalAmount.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                        </td>
                                        <td class="px-8 py-4 text-sm text-gray-600">
                                            å…¨éƒ¨ç»§æ‰¿äººä»½é¢æ€»å’Œ
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="info-card border-yellow-400 bg-gradient-to-br from-yellow-50 to-amber-50">
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-100 to-yellow-200 flex items-center justify-center mr-4">
                                <span class="text-2xl">âš ï¸</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-xl text-yellow-800">æ²¡æœ‰è¯†åˆ«åˆ°ç»§æ‰¿äºº</h3>
                                <p class="text-yellow-700">æ ¹æ®æ‚¨æä¾›çš„ä¿¡æ¯ï¼Œæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„ç»§æ‰¿äººã€‚</p>
                                <p class="text-yellow-700 mt-2">å»ºè®®å’¨è¯¢ä¸“ä¸šå¾‹å¸ˆå¤„ç†æ­¤ç±»ç»§æ‰¿æƒ…å†µã€‚</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // æ˜¾ç¤ºæ³•å¾‹æç¤º
            html += `
                <div class="info-card border-red-200 bg-gradient-to-br from-red-50 to-pink-50">
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-red-100 to-red-200 flex items-center justify-center mr-4">
                            <span class="text-xl">âš–ï¸</span>
                        </div>
                        <h3 class="font-bold text-lg text-red-800">é‡è¦æç¤º</h3>
                    </div>
                    <div class="space-y-2">
                        <div class="flex items-start">
                            <div class="w-2 h-2 rounded-full bg-red-500 mt-2 mr-3"></div>
                            <div class="text-red-700">æœ¬è®¡ç®—ç»“æœä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæ­£å¼æ³•å¾‹æ„è§</div>
                        </div>
                        <div class="flex items-start">
                            <div class="w-2 h-2 rounded-full bg-red-500 mt-2 mr-3"></div>
                            <div class="text-red-700">å®é™…ç»§æ‰¿å¯èƒ½æ¶‰åŠæ›´å¤šå¤æ‚å› ç´ ï¼ˆå¦‚å€ºåŠ¡æ¸…å¿ã€ç¨è´¹ç­‰ï¼‰</div>
                        </div>
                        <div class="flex items-start">
                            <div class="w-2 h-2 rounded-full bg-red-500 mt-2 mr-3"></div>
                            <div class="text-red-700">å¤æ‚ç»§æ‰¿å…³ç³»å»ºè®®å’¨è¯¢ä¸“ä¸šå¾‹å¸ˆ</div>
                        </div>
                    </div>
                </div>
            `;
            
            resultDiv.innerHTML = html;
            
            // åˆ›å»ºå¹¶æ’å…¥å›¾è¡¨
            if (result.heirs.length > 0) {
                const chartContainer = document.getElementById('chart-container-placeholder');
                if (chartContainer) {
                    const chart = drawInheritanceChart(result.heirs);
                    chartContainer.appendChild(chart);
                }
            }
        }
        
        // é‡æ–°å¼€å§‹è®¡ç®—
        function restartCalculator() {
            // é‡ç½®è¡¨å•
            document.getElementById('deceased-name').value = '';
            
            // é‡ç½®è´¢äº§æ€§è´¨
            const communityRadio = document.querySelector('input[value="community"]');
            const personalRadio = document.querySelector('input[value="personal"]');
            if (communityRadio) communityRadio.checked = true;
            if (personalRadio) personalRadio.checked = false;
            
            updatePropertySelection();
            
            const communityPropertyAmount = document.getElementById('community-property-amount');
            const personalPropertyAmount = document.getElementById('personal-property-amount');
            const personalEstateAmount = document.getElementById('personal-estate-amount');
            
            if (communityPropertyAmount) communityPropertyAmount.value = '';
            if (personalPropertyAmount) personalPropertyAmount.value = '';
            if (personalEstateAmount) personalEstateAmount.value = '';
            
            // é‡ç½®ç¬¬å››æ­¥æ•°æ®
            document.getElementById('spouse-name').value = '';
            document.getElementById('spouse-status').value = 'alive';
            document.getElementById('father-name').value = '';
            document.getElementById('father-status').value = 'alive';
            document.getElementById('mother-name').value = '';
            document.getElementById('mother-status').value = 'alive';
            
            // é‡ç½®å­å¥³ä¿¡æ¯
            document.getElementById('children-list').innerHTML = '';
            
            // é‡ç½®æ•°æ®ç»“æ„
            inheritanceDataV2 = {
                deceased: {
                    name: '',
                    propertyType: 'community',
                    communityPropertyAmount: 0,
                    personalPropertyAmount: 0,
                    estateAmount: 0
                },
                heirs: {
                    spouse: { 
                        name: '', 
                        status: 'none',
                        transferredTo: [],
                        hasSpouse: false,
                        transferredFromSpouse: null
                    },
                    father: { 
                        name: '', 
                        status: 'alive',
                        transferredTo: [],
                        hasSpouse: false,
                        transferredFromSpouse: null
                    },
                    mother: { 
                        name: '', 
                        status: 'alive',
                        transferredTo: [],
                        hasSpouse: false,
                        transferredFromSpouse: null
                    },
                    children: []
                },
                postdeceasedOrder: [],
                transferredDetails: {},
                parentsDeathOrder: null
            };
            
            // é‡ç½®UIæ˜¾ç¤º
            const communityContainer = document.getElementById('community-property-container');
            const personalContainer = document.getElementById('personal-property-container');
            
            if (communityContainer) communityContainer.style.display = 'block';
            if (personalContainer) personalContainer.classList.add('hidden');
            
            // é‡ç½®æ˜¾ç¤ºæ•°æ®
            inheritanceDataV2.deceased.communityPropertyAmount = 0;
            inheritanceDataV2.deceased.personalPropertyAmount = 0;
            inheritanceDataV2.deceased.estateAmount = 0;
            
            updatePropertyCalculations();
            
            // é‡ç½®ç»“æœ
            const calculationResult = document.getElementById('calculation-result');
            if (calculationResult) calculationResult.innerHTML = '';
            
            // å›åˆ°ç¬¬ä¸€æ­¥
            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep = 1;
            document.getElementById(`step${currentStep}`).classList.add('active');
            updateProgress();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initCalculator);
    </script>
</body>
</html>